<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Storage</title>
<style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden}body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}</style>
<script>(function(){if(window.__yaarCaptureInstalled)return;window.__yaarCaptureInstalled=true;function respond(requestId,imageData){window.parent.postMessage({type:"yaar:capture-response",requestId,imageData},"*")}function inlineStyles(original,clone){var origEls=original.querySelectorAll("*");var cloneEls=clone.querySelectorAll("*");for(var i=0;i<origEls.length&&i<cloneEls.length;i++){var cs=window.getComputedStyle(origEls[i]);cloneEls[i].setAttribute("style",cs.cssText)}var rootCs=window.getComputedStyle(original);clone.setAttribute("style",rootCs.cssText)}function svgToCanvas(svgStr,w,h,cb){var blob=new Blob([svgStr],{type:"image/svg+xml;charset=utf-8"});var url=URL.createObjectURL(blob);var img=new Image;img.onload=function(){var c=document.createElement("canvas");c.width=w;c.height=h;var ctx=c.getContext("2d");ctx.drawImage(img,0,0,w,h);URL.revokeObjectURL(url);cb(c.toDataURL("image/png"))};img.onerror=function(){URL.revokeObjectURL(url);cb(null)};img.src=url}window.addEventListener("message",function(e){if(!e.data||e.data.type!=="yaar:capture-request")return;var requestId=e.data.requestId;var imageData=null;try{var canvases=document.querySelectorAll("canvas");if(canvases.length>0){var largest=null;var largestArea=0;for(var i=0;i<canvases.length;i++){var area=canvases[i].width*canvases[i].height;if(area>largestArea){largestArea=area;largest=canvases[i]}}if(largest){imageData=largest.toDataURL("image/png")}}if(imageData){respond(requestId,imageData);return}var svgs=document.querySelectorAll("svg");if(svgs.length>0){var largest=null;var largestArea=0;for(var i=0;i<svgs.length;i++){var rect=svgs[i].getBoundingClientRect();var area=rect.width*rect.height;if(area>largestArea){largestArea=area;largest=svgs[i]}}if(largest){var serializer=new XMLSerializer;var svgStr=serializer.serializeToString(largest);var rect=largest.getBoundingClientRect();svgToCanvas(svgStr,rect.width||300,rect.height||150,function(data){respond(requestId,data)});return}}var body=document.body;if(body){var w=Math.min(body.scrollWidth,window.innerWidth)||window.innerWidth||800;var h=Math.min(body.scrollHeight,window.innerHeight)||window.innerHeight||600;var clone=body.cloneNode(true);inlineStyles(body,clone);var remove=clone.querySelectorAll("script,iframe");for(var i=0;i<remove.length;i++)remove[i].remove();var xmlns="http://www.w3.org/1999/xhtml";var svgNS="http://www.w3.org/2000/svg";var xhtml=new XMLSerializer().serializeToString(clone);var svgStr='<svg xmlns="'+svgNS+'" width="'+w+'" height="'+h+'">'+'<foreignObject width="100%" height="100%">'+'<body xmlns="'+xmlns+'" style="margin:0;padding:0;">'+xhtml+"</body></foreignObject></svg>";svgToCanvas(svgStr,w,h,function(data){respond(requestId,data)});return}}catch(ex){}respond(requestId,null)})})();(function(){if(window.__yaarStorageInstalled)return;window.__yaarStorageInstalled=true;function encodePath(p){return p.split("/").map(encodeURIComponent).join("/")}window.yaar=window.yaar||{};window.yaar.storage={async save(path,data){var body;if(typeof data==="string"){body=data}else if(data instanceof Blob){body=await data.arrayBuffer()}else if(data instanceof ArrayBuffer){body=data}else if(data instanceof Uint8Array){body=data.buffer.slice(data.byteOffset,data.byteOffset+data.byteLength)}else{body=String(data)}var res=await fetch("/api/storage/"+encodePath(path),{method:"POST",body});if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Save failed")}return res.json()},async read(path,options){var mode=options&&options.as||"auto";var res=await fetch("/api/storage/"+encodePath(path));if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Read failed")}if(mode==="blob")return res.blob();if(mode==="arraybuffer")return res.arrayBuffer();if(mode==="json")return res.json();if(mode==="text")return res.text();var ct=res.headers.get("content-type")||"";if(ct.includes("json"))return res.json();if(ct.startsWith("text/"))return res.text();return res.blob()},async list(dirPath){var p=dirPath?encodePath(dirPath):"";var res=await fetch("/api/storage/"+p+"?list=true");if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"List failed")}return res.json()},async remove(path){var res=await fetch("/api/storage/"+encodePath(path),{method:"DELETE"});if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Delete failed")}return res.json()},url:function(path){return"/api/storage/"+encodePath(path)}}})();(function(){if(window.__yaarFetchProxyInstalled)return;window.__yaarFetchProxyInstalled=true;var realFetch=window.fetch.bind(window);var sessionId="";try{var sp=new URLSearchParams(location.search);var raw=sp.get("sessionId")||"";if(/^[a-zA-Z0-9_-]+$/.test(raw))sessionId=raw}catch(e){}window.fetch=function(input,init){var url;if(input instanceof Request){url=input.url}else{url=String(input)}if(url.startsWith("/")||url.startsWith("./")||url.startsWith("../")){return realFetch(input,init)}try{var parsed=new URL(url,location.origin);if(parsed.origin===location.origin){return realFetch(input,init)}}catch(e){return realFetch(input,init)}var method=init&&init.method||(input instanceof Request?input.method:"GET");var headers={};if(init&&init.headers){if(init.headers instanceof Headers){init.headers.forEach(function(v,k){headers[k]=v})}else if(Array.isArray(init.headers)){init.headers.forEach(function(pair){headers[pair[0]]=pair[1]})}else{headers=Object.assign({},init.headers)}}else if(input instanceof Request){input.headers.forEach(function(v,k){headers[k]=v})}var bodyPromise;if(init&&init.body!=null){if(typeof init.body==="string"){bodyPromise=Promise.resolve(init.body)}else{bodyPromise=new Response(init.body).text()}}else if(input instanceof Request&&method!=="GET"&&method!=="HEAD"){bodyPromise=input.text()}else{bodyPromise=Promise.resolve(undefined)}return bodyPromise.then(function(bodyStr){var payload={url,method,headers};if(bodyStr!==undefined)payload.body=bodyStr;if(sessionId)payload.sessionId=sessionId;return realFetch("/api/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)})}).then(function(proxyRes){if(!proxyRes.ok){return proxyRes.json().then(function(err){throw new Error(err.error||"Fetch proxy error: "+proxyRes.status)})}return proxyRes.json()}).then(function(data){var body;if(data.bodyEncoding==="base64"){var bin=atob(data.body);var bytes=new Uint8Array(bin.length);for(var i=0;i<bin.length;i++)bytes[i]=bin.charCodeAt(i);body=bytes.buffer}else{body=data.body}return new Response(body,{status:data.status,statusText:data.statusText,headers:data.headers})})}})();(function(){if(window.__yaarAppProtocolInstalled)return;window.__yaarAppProtocolInstalled=true;window.yaar=window.yaar||{};var registration=null;window.yaar.app={register:function(config){registration=config;window.parent.postMessage({type:"yaar:app-ready",appId:config.appId},"*")},sendInteraction:function(description){window.parent.postMessage({type:"yaar:app-interaction",content:typeof description==="string"?description:JSON.stringify(description)},"*")}};window.addEventListener("message",function(e){if(!e.data||!e.data.type)return;var msg=e.data;var requestId=msg.requestId;if(msg.type==="yaar:app-manifest-request"){if(!registration){window.parent.postMessage({type:"yaar:app-manifest-response",requestId,manifest:null,error:"No app registered"},"*");return}var manifest={appId:registration.appId,name:registration.name,state:{},commands:{}};if(registration.state){for(var key in registration.state){var s=registration.state[key];manifest.state[key]={description:s.description};if(s.schema)manifest.state[key].schema=s.schema}}if(registration.commands){for(var key in registration.commands){var c=registration.commands[key];manifest.commands[key]={description:c.description};if(c.params)manifest.commands[key].params=c.params;if(c.returns)manifest.commands[key].returns=c.returns}}window.parent.postMessage({type:"yaar:app-manifest-response",requestId,manifest},"*");return}if(msg.type==="yaar:app-query-request"){if(!registration||!registration.state||!registration.state[msg.stateKey]){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:"Unknown state key: "+msg.stateKey},"*");return}try{var result=registration.state[msg.stateKey].handler();if(result&&typeof result.then==="function"){result.then(function(data){window.parent.postMessage({type:"yaar:app-query-response",requestId,data},"*")}).catch(function(err){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:String(err)},"*")})}else{window.parent.postMessage({type:"yaar:app-query-response",requestId,data:result},"*")}}catch(err){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:String(err)},"*")}return}if(msg.type==="yaar:app-command-request"){if(!registration||!registration.commands||!registration.commands[msg.command]){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:"Unknown command: "+msg.command},"*");return}try{var result=registration.commands[msg.command].handler(msg.params);if(result&&typeof result.then==="function"){result.then(function(data){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:data},"*")}).catch(function(err){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:String(err)},"*")})}else{window.parent.postMessage({type:"yaar:app-command-response",requestId,result},"*")}}catch(err){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:String(err)},"*")}return}})})();</script>
</head>
<body>
<div id="app"></div>
<script type="module">
var X="",N=[],H=[],T=null,$=null,z=window.yaar,V=z?.storage,Q=z?.app;function Y(j){let k=j.replace(/\/$/,"").split("/");return k[k.length-1]||j}function I(j){return j.trim().toLowerCase().replace(/[^a-z0-9-]/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")}function f(j){if(j==null)return"";if(j<1024)return`${j} B`;if(j<1048576)return`${(j/1024).toFixed(1)} KB`;return`${(j/1048576).toFixed(1)} MB`}function x(j,k){if(k)return"\uD83D\uDCC1";let G=j.split(".").pop()?.toLowerCase()||"";return{pdf:"\uD83D\uDCC4",txt:"\uD83D\uDCDD",md:"\uD83D\uDCDD",json:"{}",csv:"\uD83D\uDCCA",html:"\uD83C\uDF10",xml:"\uD83C\uDF10",png:"\uD83D\uDDBC️",jpg:"\uD83D\uDDBC️",jpeg:"\uD83D\uDDBC️",gif:"\uD83D\uDDBC️",svg:"\uD83D\uDDBC️",webp:"\uD83D\uDDBC️",mp3:"\uD83C\uDFB5",wav:"\uD83C\uDFB5",mp4:"\uD83C\uDFA5",webm:"\uD83C\uDFA5",zip:"\uD83D\uDCE6",tar:"\uD83D\uDCE6",gz:"\uD83D\uDCE6",js:"\uD83D\uDFE8",ts:"\uD83D\uDD35",py:"\uD83D\uDC0D"}[G]||"\uD83D\uDCC4"}function A(j){let k=j.split(".").pop()?.toLowerCase()||"";return["txt","md","json","csv","html","xml","js","ts","py","css","yaml","yml","toml","log","sh","bat","env"].includes(k)}function F(j){let k=j.split(".").pop()?.toLowerCase()||"";return["png","jpg","jpeg","gif","svg","webp"].includes(k)}function P(j){return j.includes(".")?j.split(".").pop()?.toLowerCase()||"":""}function g(j){if(!Q?.sendInteraction)return;let k=Y(j.path),G=P(k);Q.sendInteraction({event:"open_file_request",source:"storage",path:j.path,name:k,extension:G,isDirectory:j.isDirectory}),K.textContent=`Requested agent open: ${k}`}var h=document.getElementById("app")||document.body;h.innerHTML=`
<style>
  :root {
    --bg: #1a1a2e;
    --surface: #16213e;
    --surface-hover: #1a2744;
    --border: #2a3a5c;
    --text: #e0e0e0;
    --text-dim: #8899aa;
    --accent: #4fc3f7;
    --accent-dim: #29688a;
    --danger: #ef5350;
  }
  #app {
    display: flex;
    flex-direction: column;
    height: 100vh;
    background: var(--bg);
    color: var(--text);
    font-family: system-ui, -apple-system, sans-serif;
    font-size: 13px;
    overflow: hidden;
  }

  /* Toolbar */
  .toolbar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 2px;
    flex: 1;
    min-width: 0;
    overflow-x: auto;
  }
  .breadcrumb button {
    background: none;
    border: none;
    color: var(--accent);
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 13px;
    white-space: nowrap;
  }
  .breadcrumb button:hover { background: var(--surface-hover); }
  .breadcrumb button:last-child { color: var(--text); cursor: default; }
  .breadcrumb .sep { color: var(--text-dim); font-size: 11px; }
  .toolbar-btn {
    background: var(--surface-hover);
    border: 1px solid var(--border);
    color: var(--text);
    cursor: pointer;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
  }
  .toolbar-btn:hover { border-color: var(--accent-dim); }
  .toolbar-select {
    background: var(--surface-hover);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: 4px;
    font-size: 12px;
    height: 26px;
    max-width: 180px;
  }

  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 20;
  }
  .modal.open { display: flex; }
  .modal-card {
    width: min(520px, calc(100vw - 32px));
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px;
    box-shadow: 0 14px 40px rgba(0, 0, 0, 0.5);
  }
  .modal-title { font-size: 14px; font-weight: 600; margin-bottom: 8px; }
  .modal-note { color: var(--text-dim); font-size: 12px; line-height: 1.4; margin-bottom: 12px; }
  .modal-form { display: grid; gap: 10px; }
  .modal-label { font-size: 12px; color: var(--text-dim); }
  .modal-input {
    width: 100%;
    box-sizing: border-box;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: 4px;
    padding: 7px 9px;
    font-size: 12px;
  }
  .modal-check { display: flex; align-items: center; gap: 6px; font-size: 12px; }
  .modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px; }

  /* Main content */
  .main {
    display: flex;
    flex: 1;
    min-height: 0;
    overflow: hidden;
  }

  /* File list */
  .file-list {
    flex: 1;
    overflow-y: auto;
    padding: 4px 0;
    min-width: 0;
  }
  .file-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    cursor: pointer;
    border-bottom: 1px solid transparent;
  }
  .file-row:hover { background: var(--surface-hover); }
  .file-row.selected { background: var(--accent-dim); }
  .file-icon { width: 24px; text-align: center; font-size: 16px; flex-shrink: 0; }
  .file-name {
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .file-name.dir { color: var(--accent); }
  .file-size { color: var(--text-dim); font-size: 12px; flex-shrink: 0; width: 70px; text-align: right; }
  .file-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.15s; }
  .file-row:hover .file-actions { opacity: 1; }
  .file-actions button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    padding: 2px 4px;
    border-radius: 3px;
    color: var(--text-dim);
  }
  .file-actions button:hover { background: var(--border); color: var(--text); }
  .file-actions button.danger:hover { color: var(--danger); }

  /* Empty state */
  .empty {
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 1;
    color: var(--text-dim);
    font-size: 14px;
    padding: 40px;
  }

  /* Preview panel */
  .preview {
    width: 320px;
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    background: var(--surface);
    flex-shrink: 0;
  }
  .preview-header {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    font-weight: 600;
    font-size: 12px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .preview-close {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 16px;
    padding: 0 4px;
  }
  .preview-close:hover { color: var(--text); }
  .preview-body {
    flex: 1;
    overflow: auto;
    padding: 12px;
  }
  .preview-body pre {
    white-space: pre-wrap;
    word-break: break-all;
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 12px;
    line-height: 1.5;
    color: var(--text);
    margin: 0;
  }
  .preview-body img {
    max-width: 100%;
    border-radius: 4px;
  }
  .preview-meta {
    padding: 8px 12px;
    border-top: 1px solid var(--border);
    font-size: 11px;
    color: var(--text-dim);
  }

  /* Status bar */
  .statusbar {
    padding: 4px 12px;
    background: var(--surface);
    border-top: 1px solid var(--border);
    font-size: 11px;
    color: var(--text-dim);
    flex-shrink: 0;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--accent-dim); }
</style>

<div class="toolbar">
  <div class="breadcrumb" id="breadcrumb"></div>
  <select class="toolbar-select" id="mount-select" title="Jump to mounted folder">
    <option value="">Mounts</option>
  </select>
  <button class="toolbar-btn" id="btn-mount" title="Request mount folder">Mount...</button>
  <button class="toolbar-btn" id="btn-refresh" title="Refresh">↻</button>
</div>
<div class="main">
  <div class="file-list" id="file-list"></div>
  <div class="preview" id="preview" style="display:none">
    <div class="preview-header">
      <span id="preview-title">Preview</span>
      <button class="preview-close" id="preview-close">✕</button>
    </div>
    <div class="preview-body" id="preview-body"></div>
    <div class="preview-meta" id="preview-meta"></div>
  </div>
</div>
<div class="modal" id="mount-modal">
  <div class="modal-card">
    <div class="modal-title">Request Host Folder Mount</div>
    <div class="modal-note">The app cannot mount folders directly. Submit a request and the agent will ask for permission and run the mount tool.</div>
    <form class="modal-form" id="mount-form">
      <label class="modal-label" for="mount-alias">Mount alias</label>
      <input class="modal-input" id="mount-alias" name="alias" placeholder="project-files" required />
      <label class="modal-label" for="mount-host-path">Host folder path</label>
      <input class="modal-input" id="mount-host-path" name="hostPath" placeholder="/Users/name/projects" required />
      <label class="modal-check" for="mount-readonly">
        <input type="checkbox" id="mount-readonly" name="readOnly" />
        Read-only mount
      </label>
      <div class="modal-actions">
        <button class="toolbar-btn" type="button" id="mount-cancel">Cancel</button>
        <button class="toolbar-btn" type="submit" id="mount-submit">Request Mount</button>
      </div>
    </form>
  </div>
</div>
<div class="statusbar" id="statusbar">Ready</div>
`;var R=document.getElementById("breadcrumb"),_=document.getElementById("mount-select"),O=document.getElementById("mount-modal"),C=document.getElementById("mount-form"),D=document.getElementById("mount-alias"),v=document.getElementById("mount-host-path"),d=document.getElementById("mount-readonly"),W=document.getElementById("file-list"),L=document.getElementById("preview"),M=document.getElementById("preview-title"),Z=document.getElementById("preview-body"),w=document.getElementById("preview-meta"),K=document.getElementById("statusbar");document.getElementById("btn-refresh").onclick=()=>U(X);document.getElementById("btn-mount").onclick=c;document.getElementById("mount-cancel").onclick=q;document.getElementById("preview-close").onclick=S;C.addEventListener("submit",b);O.addEventListener("click",(j)=>{if(j.target===O)q()});_.addEventListener("change",()=>{if(!_.value)return;U(`mounts/${_.value}`),_.value=""});function c(){C.reset(),O.classList.add("open"),D.focus()}function q(){O.classList.remove("open")}async function b(j){j.preventDefault();let k=I(D.value),G=v.value.trim();if(!k){K.textContent="Mount alias is required";return}if(!G){K.textContent="Host folder path is required";return}if(!Q?.sendInteraction){K.textContent="Agent bridge unavailable: cannot send mount request";return}Q.sendInteraction({event:"storage_mount_request",source:"storage",alias:k,hostPath:G,readOnly:d.checked}),q(),K.textContent=`Mount request sent for ${k}`}async function u(){try{H=(await V.list("mounts")).filter((G)=>G.isDirectory).map((G)=>Y(G.path)).sort((G,J)=>G.localeCompare(J))}catch{H=[]}let j=['<option value="">Mounts</option>'];for(let k of H)j.push(`<option value="${k}">${k}</option>`);_.innerHTML=j.join("")}async function U(j){X=j,T=null,$=null,S(),m(),W.innerHTML="",K.textContent="Loading...";try{await u(),N=await V.list(j),N.sort((J,E)=>{if(J.isDirectory!==E.isDirectory)return J.isDirectory?-1:1;return Y(J.path).localeCompare(Y(E.path))}),p();let k=N.filter((J)=>J.isDirectory).length,G=N.length-k;K.textContent=`${G} file${G!==1?"s":""}, ${k} folder${k!==1?"s":""}`}catch(k){W.innerHTML='<div class="empty">Failed to load directory</div>',K.textContent="Error loading directory"}}function m(){let j=X?X.split("/").filter(Boolean):[],k='<button data-path="">storage://</button>',G="";for(let J=0;J<j.length;J++)G+=(G?"/":"")+j[J],k+='<span class="sep">/</span>',k+=`<button data-path="${G}">${j[J]}</button>`;R.innerHTML=k,R.querySelectorAll("button").forEach((J)=>{J.addEventListener("click",()=>{let E=J.getAttribute("data-path")||"";U(E)})})}function p(){if(N.length===0){W.innerHTML='<div class="empty">This folder is empty</div>';return}W.innerHTML="";for(let j of N){let k=Y(j.path),G=document.createElement("div");G.className="file-row",G.dataset.path=j.path,G.innerHTML=`
      <span class="file-icon">${x(k,j.isDirectory)}</span>
      <span class="file-name${j.isDirectory?" dir":""}">${k}</span>
      <span class="file-size">${j.isDirectory?"":f(j.size)}</span>
      <span class="file-actions">
        ${!j.isDirectory?'<button class="act-open" title="Open in new tab">⇗</button>':""}
        <button class="act-delete danger" title="Delete">\uD83D\uDDD1</button>
      </span>
    `,G.addEventListener("click",(J)=>{if(J.target.closest(".file-actions"))return;if(j.isDirectory)U(j.path);else B(j)}),G.addEventListener("dblclick",(J)=>{if(J.target.closest(".file-actions"))return;if(!j.isDirectory)g(j)}),G.querySelector(".act-open")?.addEventListener("click",()=>{window.open(V.url(j.path),"_blank")}),G.querySelector(".act-delete")?.addEventListener("click",async()=>{if(!confirm(`Delete "${k}"?`))return;try{await V.remove(j.path),U(X)}catch{K.textContent=`Failed to delete ${k}`}}),W.appendChild(G)}}async function B(j){let k=Y(j.path);if(T=j.path,$=null,W.querySelectorAll(".file-row").forEach((G)=>{let J=G;J.classList.toggle("selected",J.dataset.path===j.path)}),L.style.display="flex",M.textContent=k,Z.innerHTML='<span style="color:var(--text-dim)">Loading...</span>',w.textContent=f(j.size),F(k)){Z.innerHTML=`<img src="${V.url(j.path)}" alt="${k}" />`;return}if(A(k)){try{let G=await V.read(j.path,{as:"text"});$=G;let J=G.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");Z.innerHTML=`<pre>${J}</pre>`}catch{Z.innerHTML='<span style="color:var(--text-dim)">Unable to preview</span>'}return}Z.innerHTML=`
    <div style="text-align:center;padding:20px">
      <div style="font-size:32px;margin-bottom:8px">${x(k,!1)}</div>
      <div style="color:var(--text-dim);margin-bottom:12px">No preview available</div>
      <button class="toolbar-btn" id="open-external">Open in browser</button>
    </div>
  `,document.getElementById("open-external")?.addEventListener("click",()=>{window.open(V.url(j.path),"_blank")})}function S(){T=null,$=null,L.style.display="none",W.querySelectorAll(".file-row.selected").forEach((j)=>j.classList.remove("selected"))}if(Q)Q.register({appId:"storage",name:"Storage Browser",state:{"current-path":{description:"Current directory path being viewed",handler:()=>X},"directory-listing":{description:"Files and folders in the current directory",handler:()=>N.map((j)=>({path:j.path,name:Y(j.path),isDirectory:j.isDirectory,size:j.size}))},"selected-file":{description:"Currently selected file path (null if none)",handler:()=>T},"mount-aliases":{description:"Mounted folders available under mounts/",handler:()=>[...H]},"file-preview":{description:"Text content of the currently previewed file (null if not text)",handler:()=>$}},commands:{navigate:{description:"Navigate to a directory path",params:{type:"object",properties:{path:{type:"string",description:"Directory path to navigate to"}},required:["path"]},handler:(j)=>{return U(String(j.path)),{success:!0,path:j.path}}},"select-file":{description:"Select and preview a file",params:{type:"object",properties:{path:{type:"string",description:"File path to select"}},required:["path"]},handler:(j)=>{let k=N.find((G)=>G.path===j.path);if(!k||k.isDirectory)return{success:!1,error:"File not found"};return B(k),{success:!0}}},"request-mount":{description:"Send a mount request for the agent to execute with host permission",params:{type:"object",properties:{alias:{type:"string",description:"Mount alias (example: project-files)"},hostPath:{type:"string",description:"Absolute host folder path"},readOnly:{type:"boolean",description:"Whether mount should be read-only"}},required:["alias","hostPath"]},handler:(j)=>{if(!Q?.sendInteraction)return{success:!1,error:"Agent bridge unavailable"};return Q.sendInteraction({event:"storage_mount_request",source:"storage",alias:I(String(j.alias||"")),hostPath:String(j.hostPath||""),readOnly:Boolean(j.readOnly)}),{success:!0}}},refresh:{description:"Refresh the current directory listing",params:{type:"object",properties:{}},handler:()=>{return U(X),{success:!0}}}}});U("");

</script>
</body>
</html>