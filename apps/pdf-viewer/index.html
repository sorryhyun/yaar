<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pdf Viewer</title>
<style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden}body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}</style>
<script>(function(){if(window.__yaarCaptureInstalled)return;window.__yaarCaptureInstalled=true;function respond(requestId,imageData){window.parent.postMessage({type:"yaar:capture-response",requestId,imageData},"*")}function inlineStyles(original,clone){var origEls=original.querySelectorAll("*");var cloneEls=clone.querySelectorAll("*");for(var i=0;i<origEls.length&&i<cloneEls.length;i++){var cs=window.getComputedStyle(origEls[i]);cloneEls[i].setAttribute("style",cs.cssText)}var rootCs=window.getComputedStyle(original);clone.setAttribute("style",rootCs.cssText)}function svgToCanvas(svgStr,w,h,cb){var blob=new Blob([svgStr],{type:"image/svg+xml;charset=utf-8"});var url=URL.createObjectURL(blob);var img=new Image;img.onload=function(){var c=document.createElement("canvas");c.width=w;c.height=h;var ctx=c.getContext("2d");ctx.drawImage(img,0,0,w,h);URL.revokeObjectURL(url);cb(c.toDataURL("image/png"))};img.onerror=function(){URL.revokeObjectURL(url);cb(null)};img.src=url}window.addEventListener("message",function(e){if(!e.data||e.data.type!=="yaar:capture-request")return;var requestId=e.data.requestId;var imageData=null;try{var canvases=document.querySelectorAll("canvas");if(canvases.length>0){var largest=null;var largestArea=0;for(var i=0;i<canvases.length;i++){var area=canvases[i].width*canvases[i].height;if(area>largestArea){largestArea=area;largest=canvases[i]}}if(largest){imageData=largest.toDataURL("image/png")}}if(imageData){respond(requestId,imageData);return}var svgs=document.querySelectorAll("svg");if(svgs.length>0){var largest=null;var largestArea=0;for(var i=0;i<svgs.length;i++){var rect=svgs[i].getBoundingClientRect();var area=rect.width*rect.height;if(area>largestArea){largestArea=area;largest=svgs[i]}}if(largest){var serializer=new XMLSerializer;var svgStr=serializer.serializeToString(largest);var rect=largest.getBoundingClientRect();svgToCanvas(svgStr,rect.width||300,rect.height||150,function(data){respond(requestId,data)});return}}var body=document.body;if(body){var w=Math.min(body.scrollWidth,window.innerWidth)||window.innerWidth||800;var h=Math.min(body.scrollHeight,window.innerHeight)||window.innerHeight||600;var clone=body.cloneNode(true);inlineStyles(body,clone);var remove=clone.querySelectorAll("script,iframe");for(var i=0;i<remove.length;i++)remove[i].remove();var xmlns="http://www.w3.org/1999/xhtml";var svgNS="http://www.w3.org/2000/svg";var xhtml=new XMLSerializer().serializeToString(clone);var svgStr='<svg xmlns="'+svgNS+'" width="'+w+'" height="'+h+'">'+'<foreignObject width="100%" height="100%">'+'<body xmlns="'+xmlns+'" style="margin:0;padding:0;">'+xhtml+"</body></foreignObject></svg>";svgToCanvas(svgStr,w,h,function(data){respond(requestId,data)});return}}catch(ex){}respond(requestId,null)})})();(function(){if(window.__yaarStorageInstalled)return;window.__yaarStorageInstalled=true;function encodePath(p){return p.split("/").map(encodeURIComponent).join("/")}window.yaar=window.yaar||{};window.yaar.storage={async save(path,data){var body;if(typeof data==="string"){body=data}else if(data instanceof Blob){body=await data.arrayBuffer()}else if(data instanceof ArrayBuffer){body=data}else if(data instanceof Uint8Array){body=data.buffer.slice(data.byteOffset,data.byteOffset+data.byteLength)}else{body=String(data)}var res=await fetch("/api/storage/"+encodePath(path),{method:"POST",body});if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Save failed")}return res.json()},async read(path,options){var mode=options&&options.as||"auto";var res=await fetch("/api/storage/"+encodePath(path));if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Read failed")}if(mode==="blob")return res.blob();if(mode==="arraybuffer")return res.arrayBuffer();if(mode==="json")return res.json();if(mode==="text")return res.text();var ct=res.headers.get("content-type")||"";if(ct.includes("json"))return res.json();if(ct.startsWith("text/"))return res.text();return res.blob()},async list(dirPath){var p=dirPath?encodePath(dirPath):"";var res=await fetch("/api/storage/"+p+"?list=true");if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"List failed")}return res.json()},async remove(path){var res=await fetch("/api/storage/"+encodePath(path),{method:"DELETE"});if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Delete failed")}return res.json()},url:function(path){return"/api/storage/"+encodePath(path)}}})();(function(){if(window.__yaarFetchProxyInstalled)return;window.__yaarFetchProxyInstalled=true;var realFetch=window.fetch.bind(window);var sessionId="";try{var sp=new URLSearchParams(location.search);var raw=sp.get("sessionId")||"";if(/^[a-zA-Z0-9_-]+$/.test(raw))sessionId=raw}catch(e){}window.fetch=function(input,init){var url;if(input instanceof Request){url=input.url}else{url=String(input)}if(url.startsWith("/")||url.startsWith("./")||url.startsWith("../")){return realFetch(input,init)}try{var parsed=new URL(url,location.origin);if(parsed.origin===location.origin){return realFetch(input,init)}}catch(e){return realFetch(input,init)}var method=init&&init.method||(input instanceof Request?input.method:"GET");var headers={};if(init&&init.headers){if(init.headers instanceof Headers){init.headers.forEach(function(v,k){headers[k]=v})}else if(Array.isArray(init.headers)){init.headers.forEach(function(pair){headers[pair[0]]=pair[1]})}else{headers=Object.assign({},init.headers)}}else if(input instanceof Request){input.headers.forEach(function(v,k){headers[k]=v})}var bodyPromise;if(init&&init.body!=null){if(typeof init.body==="string"){bodyPromise=Promise.resolve(init.body)}else{bodyPromise=new Response(init.body).text()}}else if(input instanceof Request&&method!=="GET"&&method!=="HEAD"){bodyPromise=input.text()}else{bodyPromise=Promise.resolve(undefined)}return bodyPromise.then(function(bodyStr){var payload={url,method,headers};if(bodyStr!==undefined)payload.body=bodyStr;if(sessionId)payload.sessionId=sessionId;return realFetch("/api/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)})}).then(function(proxyRes){if(!proxyRes.ok){return proxyRes.json().then(function(err){throw new Error(err.error||"Fetch proxy error: "+proxyRes.status)})}return proxyRes.json()}).then(function(data){var body;if(data.bodyEncoding==="base64"){var bin=atob(data.body);var bytes=new Uint8Array(bin.length);for(var i=0;i<bin.length;i++)bytes[i]=bin.charCodeAt(i);body=bytes.buffer}else{body=data.body}return new Response(body,{status:data.status,statusText:data.statusText,headers:data.headers})})}})();(function(){if(window.__yaarAppProtocolInstalled)return;window.__yaarAppProtocolInstalled=true;window.yaar=window.yaar||{};var registration=null;window.yaar.app={register:function(config){registration=config;window.parent.postMessage({type:"yaar:app-ready",appId:config.appId},"*")},sendInteraction:function(description){window.parent.postMessage({type:"yaar:app-interaction",content:typeof description==="string"?description:JSON.stringify(description)},"*")}};window.addEventListener("message",function(e){if(!e.data||!e.data.type)return;var msg=e.data;var requestId=msg.requestId;if(msg.type==="yaar:app-manifest-request"){if(!registration){window.parent.postMessage({type:"yaar:app-manifest-response",requestId,manifest:null,error:"No app registered"},"*");return}var manifest={appId:registration.appId,name:registration.name,state:{},commands:{}};if(registration.state){for(var key in registration.state){var s=registration.state[key];manifest.state[key]={description:s.description};if(s.schema)manifest.state[key].schema=s.schema}}if(registration.commands){for(var key in registration.commands){var c=registration.commands[key];manifest.commands[key]={description:c.description};if(c.params)manifest.commands[key].params=c.params;if(c.returns)manifest.commands[key].returns=c.returns}}window.parent.postMessage({type:"yaar:app-manifest-response",requestId,manifest},"*");return}if(msg.type==="yaar:app-query-request"){if(!registration||!registration.state||!registration.state[msg.stateKey]){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:"Unknown state key: "+msg.stateKey},"*");return}try{var result=registration.state[msg.stateKey].handler();if(result&&typeof result.then==="function"){result.then(function(data){window.parent.postMessage({type:"yaar:app-query-response",requestId,data},"*")}).catch(function(err){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:String(err)},"*")})}else{window.parent.postMessage({type:"yaar:app-query-response",requestId,data:result},"*")}}catch(err){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:String(err)},"*")}return}if(msg.type==="yaar:app-command-request"){if(!registration||!registration.commands||!registration.commands[msg.command]){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:"Unknown command: "+msg.command},"*");return}try{var result=registration.commands[msg.command].handler(msg.params);if(result&&typeof result.then==="function"){result.then(function(data){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:data},"*")}).catch(function(err){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:String(err)},"*")})}else{window.parent.postMessage({type:"yaar:app-command-response",requestId,result},"*")}}catch(err){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:String(err)},"*")}return}})})();</script>
</head>
<body>
<div id="app"></div>
<script type="module">
var L=document.getElementById("app");if(!L)throw Error("Missing app root");L.innerHTML=`
  <style>
    :root {
      color-scheme: light dark;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    body { margin: 0; }
    .wrap { display: grid; grid-template-rows: auto 1fr; height: 100vh; }
    .top {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #d0d7de;
      background: #f6f8fa;
      flex-wrap: wrap;
    }
    .top button, .top select, .top input, .top textarea {
      font: inherit;
    }
    .top button {
      padding: 6px 10px;
      border: 1px solid #b6c2cf;
      border-radius: 8px;
      background: white;
      cursor: pointer;
    }
    .top button.active { background: #0969da; color: #fff; border-color: #0969da; }
    .top .spacer { flex: 1; }
    .pane { height: calc(100vh - 58px); }
    .hidden { display: none !important; }
    .viewer-pane { display: grid; grid-template-rows: auto 1fr; }
    .viewer-controls {
      display: flex;
      gap: 8px;
      padding: 10px;
      border-bottom: 1px solid #d0d7de;
      align-items: center;
      flex-wrap: wrap;
    }
    .viewer-frame {
      width: 100%;
      height: 100%;
      border: 0;
      background: #f0f0f0;
    }
    .drop {
      border: 2px dashed #9aa4b2;
      border-radius: 12px;
      padding: 28px;
      margin: 12px;
      text-align: center;
      color: #57606a;
    }
    .drop.drag { border-color: #0969da; color: #0969da; }
    .export-pane { display: grid; grid-template-columns: 1fr 1fr; height: 100%; }
    .left, .right { padding: 10px; overflow: auto; }
    .left { border-right: 1px solid #d0d7de; }
    textarea {
      width: 100%;
      height: calc(100% - 60px);
      min-height: 220px;
      resize: vertical;
      border: 1px solid #d0d7de;
      border-radius: 8px;
      padding: 10px;
      box-sizing: border-box;
      background: white;
      color: #111;
    }
    .preview {
      background: white;
      border: 1px solid #d0d7de;
      border-radius: 8px;
      padding: 20px;
      min-height: 92%;
      color: #111;
    }
    .hint { color: #57606a; font-size: 12px; }
    .status { font-size: 12px; color: #57606a; }
    @media print {
      body * { visibility: hidden !important; }
      #print-area, #print-area * { visibility: visible !important; }
      #print-area {
        position: fixed;
        inset: 0;
        background: white;
        color: #000;
        padding: 20mm;
      }
    }
  </style>

  <div class="wrap">
    <div class="top">
      <button id="btn-viewer" class="active">PDF Viewer</button>
      <button id="btn-export">Export to PDF</button>
      <div class="spacer"></div>
      <span id="global-status" class="status">Ready</span>
    </div>

    <div id="viewer-pane" class="pane viewer-pane">
      <div class="viewer-controls">
        <input id="file-input" type="file" accept="application/pdf" />
        <button id="open-storage">Open from Storage Path</button>
        <input id="storage-path" type="text" placeholder="e.g. mydocs/report.pdf" style="min-width: 260px; padding: 6px 8px; border-radius: 8px; border: 1px solid #d0d7de;" />
        <button id="clear-pdf">Clear</button>
        <span id="pdf-status" class="status">No PDF loaded.</span>
      </div>
      <div id="drop" class="drop">Drop a PDF file here, or use the file picker above.</div>
      <iframe id="pdf-frame" class="viewer-frame hidden"></iframe>
    </div>

    <div id="export-pane" class="pane export-pane hidden">
      <div class="left">
        <h3 style="margin: 0 0 8px;">Content</h3>
        <p class="hint" style="margin-top: 0;">Type plain text or basic HTML. Use preview, then click “Export PDF”.</p>
        <textarea id="content-input" placeholder="Paste document/content here..."></textarea>
      </div>
      <div class="right">
        <div style="display: flex; gap: 8px; margin-bottom: 10px;">
          <button id="preview-btn">Refresh Preview</button>
          <button id="export-btn">Export PDF</button>
          <button id="save-html-btn">Save HTML to Storage</button>
        </div>
        <div id="print-area" class="preview"></div>
      </div>
    </div>
  </div>
`;var j={btnViewer:document.getElementById("btn-viewer"),btnExport:document.getElementById("btn-export"),viewerPane:document.getElementById("viewer-pane"),exportPane:document.getElementById("export-pane"),globalStatus:document.getElementById("global-status"),fileInput:document.getElementById("file-input"),pdfFrame:document.getElementById("pdf-frame"),pdfStatus:document.getElementById("pdf-status"),drop:document.getElementById("drop"),clearPdf:document.getElementById("clear-pdf"),openStorage:document.getElementById("open-storage"),storagePath:document.getElementById("storage-path"),contentInput:document.getElementById("content-input"),previewBtn:document.getElementById("preview-btn"),exportBtn:document.getElementById("export-btn"),saveHtmlBtn:document.getElementById("save-html-btn"),printArea:document.getElementById("print-area")},Q="viewer",D=null;function I(q){Q=q;let z=q==="viewer";j.viewerPane.classList.toggle("hidden",!z),j.exportPane.classList.toggle("hidden",z),j.btnViewer.classList.toggle("active",z),j.btnExport.classList.toggle("active",!z),j.globalStatus.textContent=z?"Viewer mode":"Export mode"}function J(){if(D&&D.startsWith("blob:"))URL.revokeObjectURL(D);D=null}function K(q,z){J(),D=q,j.pdfFrame.src=q,j.pdfFrame.classList.remove("hidden"),j.drop.classList.add("hidden"),j.pdfStatus.textContent=`Loaded: ${z}`,j.globalStatus.textContent="PDF loaded"}async function N(q){let z=q.trim().replace(/^\/+/,"");if(!z){j.pdfStatus.textContent="Enter a storage path first.";return}let A=window.yaar?.storage;if(!A){j.pdfStatus.textContent="Storage API unavailable in this app context.";return}try{let B=await A.read(z,{as:"arraybuffer"}),G=new Blob([B],{type:"application/pdf"}),O=URL.createObjectURL(G);K(O,z)}catch(B){let G=B instanceof Error?B.message:String(B);j.pdfStatus.textContent=`Failed to read storage file: ${G}`}}function E(){let q=j.contentInput.value.trim();if(!q){j.printArea.innerHTML='<p style="color:#57606a;">No content yet.</p>';return}if(/<\/?[a-z][\s\S]*>/i.test(q))j.printArea.innerHTML=q;else{let A=q.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;").replaceAll(`
`,"<br>");j.printArea.innerHTML=`<div>${A}</div>`}}async function R(){let q=window.yaar?.storage;if(!q){j.globalStatus.textContent="Storage API unavailable";return}let A=`pdf-viewer/exports/export-${new Date().toISOString().replace(/[:.]/g,"-")}.html`;await q.save(A,j.printArea.innerHTML||"<p></p>"),j.globalStatus.textContent=`Saved HTML: ${A}`}j.btnViewer.addEventListener("click",()=>I("viewer"));j.btnExport.addEventListener("click",()=>I("export"));j.fileInput.addEventListener("change",()=>{let q=j.fileInput.files?.[0];if(!q)return;let z=URL.createObjectURL(q);K(z,q.name)});j.clearPdf.addEventListener("click",()=>{J(),j.pdfFrame.src="",j.pdfFrame.classList.add("hidden"),j.drop.classList.remove("hidden"),j.pdfStatus.textContent="No PDF loaded.",j.globalStatus.textContent="Viewer cleared"});j.openStorage.addEventListener("click",()=>N(j.storagePath.value));j.storagePath.addEventListener("keydown",(q)=>{if(q.key==="Enter")N(j.storagePath.value)});j.drop.addEventListener("dragover",(q)=>{q.preventDefault(),j.drop.classList.add("drag")});j.drop.addEventListener("dragleave",()=>j.drop.classList.remove("drag"));j.drop.addEventListener("drop",(q)=>{q.preventDefault(),j.drop.classList.remove("drag");let z=q.dataTransfer?.files?.[0];if(!z)return;if(z.type!=="application/pdf"&&!z.name.toLowerCase().endsWith(".pdf")){j.pdfStatus.textContent="Only PDF files are supported.";return}let A=URL.createObjectURL(z);K(A,z.name)});j.previewBtn.addEventListener("click",()=>{E(),j.globalStatus.textContent="Preview updated"});j.exportBtn.addEventListener("click",()=>{E(),j.globalStatus.textContent="Opening print dialog... choose Save as PDF",window.print()});j.saveHtmlBtn.addEventListener("click",async()=>{E();try{await R()}catch(q){let z=q instanceof Error?q.message:String(q);j.globalStatus.textContent=`Save failed: ${z}`}});j.contentInput.value=`<h1>Document Title</h1>
<p>Write or paste your content here, then click <strong>Export PDF</strong>.</p>
<ul><li>Supports plain text</li><li>Supports basic HTML</li></ul>`;E();I("viewer");window.addEventListener("beforeunload",()=>J());

</script>
</body>
</html>