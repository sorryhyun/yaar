<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>pdf-viewer</title>
<style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden}body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}</style>
<script>(function(){if(window.__yaarCaptureInstalled)return;window.__yaarCaptureInstalled=!0;function s(r,n){window.parent.postMessage({type:"yaar:capture-response",requestId:r,imageData:n},"*")}function o(r,n){for(var d=r.querySelectorAll("*"),u=n.querySelectorAll("*"),i=0;i<d.length&&i<u.length;i++){var t=window.getComputedStyle(d[i]);u[i].setAttribute("style",t.cssText)}var a=window.getComputedStyle(r);n.setAttribute("style",a.cssText)}function e(r,n,d,u){var i=new Blob([r],{type:"image/svg+xml;charset=utf-8"}),t=URL.createObjectURL(i),a=new Image;a.onload=function(){var f=document.createElement("canvas");f.width=n,f.height=d;var p=f.getContext("2d");p.drawImage(a,0,0,n,d),URL.revokeObjectURL(t),u(f.toDataURL("image/png"))},a.onerror=function(){URL.revokeObjectURL(t),u(null)},a.src=t}window.addEventListener("message",function(r){if(!(!r.data||r.data.type!=="yaar:capture-request")){var n=r.data.requestId,d=null;try{var u=document.querySelectorAll("canvas");if(u.length>0){for(var i=null,t=0,a=0;a<u.length;a++){var f=u[a].width*u[a].height;f>t&&(t=f,i=u[a])}i&&(d=i.toDataURL("image/png"))}if(d){s(n,d);return}var p=document.querySelectorAll("svg");if(p.length>0){for(var i=null,t=0,a=0;a<p.length;a++){var c=p[a].getBoundingClientRect(),f=c.width*c.height;f>t&&(t=f,i=p[a])}if(i){var v=new XMLSerializer,w=v.serializeToString(i),c=i.getBoundingClientRect();e(w,c.width||300,c.height||150,function(j){s(n,j)});return}}var l=document.body;if(l){var h=Math.min(l.scrollWidth,window.innerWidth)||window.innerWidth||800,g=Math.min(l.scrollHeight,window.innerHeight)||window.innerHeight||600,y=l.cloneNode(!0);o(l,y);for(var m=y.querySelectorAll("script,iframe"),a=0;a<m.length;a++)m[a].remove();var q="http://www.w3.org/1999/xhtml",b="http://www.w3.org/2000/svg",I=new XMLSerializer().serializeToString(y),w='<svg xmlns="'+b+'" width="'+h+'" height="'+g+'"><foreignObject width="100%" height="100%"><body xmlns="'+q+'" style="margin:0;padding:0;">'+I+"</body></foreignObject></svg>";e(w,h,g,function(S){s(n,S)});return}}catch{}s(n,null)}})})(),function(){if(window.__yaarStorageInstalled)return;window.__yaarStorageInstalled=!0;function s(o){return o.split("/").map(encodeURIComponent).join("/")}window.yaar=window.yaar||{},window.yaar.storage={async save(o,e){var r;typeof e=="string"?r=e:e instanceof Blob?r=await e.arrayBuffer():e instanceof ArrayBuffer?r=e:e instanceof Uint8Array?r=e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength):r=String(e);var n=await fetch("/api/storage/"+s(o),{method:"POST",body:r});if(!n.ok){var d=await n.json().catch(function(){return{error:n.statusText}});throw new Error(d.error||"Save failed")}return n.json()},async read(o,e){var r=e&&e.as||"auto",n=await fetch("/api/storage/"+s(o));if(!n.ok){var d=await n.json().catch(function(){return{error:n.statusText}});throw new Error(d.error||"Read failed")}if(r==="blob")return n.blob();if(r==="arraybuffer")return n.arrayBuffer();if(r==="json")return n.json();if(r==="text")return n.text();var u=n.headers.get("content-type")||"";return u.includes("json")?n.json():u.startsWith("text/")?n.text():n.blob()},async list(o){var e=o?s(o):"",r=await fetch("/api/storage/"+e+"?list=true");if(!r.ok){var n=await r.json().catch(function(){return{error:r.statusText}});throw new Error(n.error||"List failed")}return r.json()},async remove(o){var e=await fetch("/api/storage/"+s(o),{method:"DELETE"});if(!e.ok){var r=await e.json().catch(function(){return{error:e.statusText}});throw new Error(r.error||"Delete failed")}return e.json()},url:function(o){return"/api/storage/"+s(o)}}}(),function(){if(!window.__yaarFetchProxyInstalled){window.__yaarFetchProxyInstalled=!0;var s=window.fetch.bind(window);window.fetch=function(o,e){var r;if(o instanceof Request?r=o.url:r=String(o),r.startsWith("/")||r.startsWith("./")||r.startsWith("../"))return s(o,e);try{var n=new URL(r,location.origin);if(n.origin===location.origin)return s(o,e)}catch{return s(o,e)}var d=e&&e.method||(o instanceof Request?o.method:"GET"),u={};e&&e.headers?e.headers instanceof Headers?e.headers.forEach(function(t,a){u[a]=t}):Array.isArray(e.headers)?e.headers.forEach(function(t){u[t[0]]=t[1]}):u=Object.assign({},e.headers):o instanceof Request&&o.headers.forEach(function(t,a){u[a]=t});var i;return e&&e.body!=null?typeof e.body=="string"?i=Promise.resolve(e.body):i=new Response(e.body).text():o instanceof Request&&d!=="GET"&&d!=="HEAD"?i=o.text():i=Promise.resolve(void 0),i.then(function(t){var a={url:r,method:d,headers:u};return t!==void 0&&(a.body=t),s("/api/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})}).then(function(t){return t.ok?t.json():t.json().then(function(a){throw new Error(a.error||"Fetch proxy error: "+t.status)})}).then(function(t){var a;if(t.bodyEncoding==="base64"){for(var f=atob(t.body),p=new Uint8Array(f.length),c=0;c<f.length;c++)p[c]=f.charCodeAt(c);a=p.buffer}else a=t.body;return new Response(a,{status:t.status,statusText:t.statusText,headers:t.headers})})}}}(),function(){if(!window.__yaarAppProtocolInstalled){window.__yaarAppProtocolInstalled=!0,window.yaar=window.yaar||{};var s=null;window.yaar.app={register:function(o){s=o,window.parent.postMessage({type:"yaar:app-ready",appId:o.appId},"*")},sendInteraction:function(o){window.parent.postMessage({type:"yaar:app-interaction",content:typeof o=="string"?o:JSON.stringify(o)},"*")}},window.addEventListener("message",function(o){if(!(!o.data||!o.data.type)){var e=o.data,r=e.requestId;if(e.type==="yaar:app-manifest-request"){if(!s){window.parent.postMessage({type:"yaar:app-manifest-response",requestId:r,manifest:null,error:"No app registered"},"*");return}var n={appId:s.appId,name:s.name,state:{},commands:{}};if(s.state)for(var d in s.state){var u=s.state[d];n.state[d]={description:u.description},u.schema&&(n.state[d].schema=u.schema)}if(s.commands)for(var d in s.commands){var i=s.commands[d];n.commands[d]={description:i.description},i.params&&(n.commands[d].params=i.params),i.returns&&(n.commands[d].returns=i.returns)}window.parent.postMessage({type:"yaar:app-manifest-response",requestId:r,manifest:n},"*");return}if(e.type==="yaar:app-query-request"){if(!s||!s.state||!s.state[e.stateKey]){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:null,error:"Unknown state key: "+e.stateKey},"*");return}try{var t=s.state[e.stateKey].handler();t&&typeof t.then=="function"?t.then(function(a){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:a},"*")}).catch(function(a){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:null,error:String(a)},"*")}):window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:t},"*")}catch(a){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:null,error:String(a)},"*")}return}if(e.type==="yaar:app-command-request"){if(!s||!s.commands||!s.commands[e.command]){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:null,error:"Unknown command: "+e.command},"*");return}try{var t=s.commands[e.command].handler(e.params);t&&typeof t.then=="function"?t.then(function(f){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:f},"*")}).catch(function(f){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:null,error:String(f)},"*")}):window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:t},"*")}catch(a){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:null,error:String(a)},"*")}return}}})}}();</script>
</head>
<body>
<div id="app"></div>
<script type="module">
var c=document.getElementById("app");if(!c)throw new Error("Missing app root");c.innerHTML=`
  <style>
    :root {
      color-scheme: light dark;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    body { margin: 0; }
    .wrap { display: grid; grid-template-rows: auto 1fr; height: 100vh; }
    .top {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #d0d7de;
      background: #f6f8fa;
      flex-wrap: wrap;
    }
    .top button, .top select, .top input, .top textarea {
      font: inherit;
    }
    .top button {
      padding: 6px 10px;
      border: 1px solid #b6c2cf;
      border-radius: 8px;
      background: white;
      cursor: pointer;
    }
    .top button.active { background: #0969da; color: #fff; border-color: #0969da; }
    .top .spacer { flex: 1; }
    .pane { height: calc(100vh - 58px); }
    .hidden { display: none !important; }
    .viewer-pane { display: grid; grid-template-rows: auto 1fr; }
    .viewer-controls {
      display: flex;
      gap: 8px;
      padding: 10px;
      border-bottom: 1px solid #d0d7de;
      align-items: center;
      flex-wrap: wrap;
    }
    .viewer-frame {
      width: 100%;
      height: 100%;
      border: 0;
      background: #f0f0f0;
    }
    .drop {
      border: 2px dashed #9aa4b2;
      border-radius: 12px;
      padding: 28px;
      margin: 12px;
      text-align: center;
      color: #57606a;
    }
    .drop.drag { border-color: #0969da; color: #0969da; }
    .export-pane { display: grid; grid-template-columns: 1fr 1fr; height: 100%; }
    .left, .right { padding: 10px; overflow: auto; }
    .left { border-right: 1px solid #d0d7de; }
    textarea {
      width: 100%;
      height: calc(100% - 60px);
      min-height: 220px;
      resize: vertical;
      border: 1px solid #d0d7de;
      border-radius: 8px;
      padding: 10px;
      box-sizing: border-box;
      background: white;
      color: #111;
    }
    .preview {
      background: white;
      border: 1px solid #d0d7de;
      border-radius: 8px;
      padding: 20px;
      min-height: 92%;
      color: #111;
    }
    .hint { color: #57606a; font-size: 12px; }
    .status { font-size: 12px; color: #57606a; }
    @media print {
      body * { visibility: hidden !important; }
      #print-area, #print-area * { visibility: visible !important; }
      #print-area {
        position: fixed;
        inset: 0;
        background: white;
        color: #000;
        padding: 20mm;
      }
    }
  </style>

  <div class="wrap">
    <div class="top">
      <button id="btn-viewer" class="active">PDF Viewer</button>
      <button id="btn-export">Export to PDF</button>
      <div class="spacer"></div>
      <span id="global-status" class="status">Ready</span>
    </div>

    <div id="viewer-pane" class="pane viewer-pane">
      <div class="viewer-controls">
        <input id="file-input" type="file" accept="application/pdf" />
        <button id="open-storage">Open from Storage Path</button>
        <input id="storage-path" type="text" placeholder="e.g. mydocs/report.pdf" style="min-width: 260px; padding: 6px 8px; border-radius: 8px; border: 1px solid #d0d7de;" />
        <button id="clear-pdf">Clear</button>
        <span id="pdf-status" class="status">No PDF loaded.</span>
      </div>
      <div id="drop" class="drop">Drop a PDF file here, or use the file picker above.</div>
      <iframe id="pdf-frame" class="viewer-frame hidden"></iframe>
    </div>

    <div id="export-pane" class="pane export-pane hidden">
      <div class="left">
        <h3 style="margin: 0 0 8px;">Content</h3>
        <p class="hint" style="margin-top: 0;">Type plain text or basic HTML. Use preview, then click \u201CExport PDF\u201D.</p>
        <textarea id="content-input" placeholder="Paste document/content here..."></textarea>
      </div>
      <div class="right">
        <div style="display: flex; gap: 8px; margin-bottom: 10px;">
          <button id="preview-btn">Refresh Preview</button>
          <button id="export-btn">Export PDF</button>
          <button id="save-html-btn">Save HTML to Storage</button>
        </div>
        <div id="print-area" class="preview"></div>
      </div>
    </div>
  </div>
`;var e={btnViewer:document.getElementById("btn-viewer"),btnExport:document.getElementById("btn-export"),viewerPane:document.getElementById("viewer-pane"),exportPane:document.getElementById("export-pane"),globalStatus:document.getElementById("global-status"),fileInput:document.getElementById("file-input"),pdfFrame:document.getElementById("pdf-frame"),pdfStatus:document.getElementById("pdf-status"),drop:document.getElementById("drop"),clearPdf:document.getElementById("clear-pdf"),openStorage:document.getElementById("open-storage"),storagePath:document.getElementById("storage-path"),contentInput:document.getElementById("content-input"),previewBtn:document.getElementById("preview-btn"),exportBtn:document.getElementById("export-btn"),saveHtmlBtn:document.getElementById("save-html-btn"),printArea:document.getElementById("print-area")},m="viewer",o=null;function s(t){m=t;let n=t==="viewer";e.viewerPane.classList.toggle("hidden",!n),e.exportPane.classList.toggle("hidden",n),e.btnViewer.classList.toggle("active",n),e.btnExport.classList.toggle("active",!n),e.globalStatus.textContent=n?"Viewer mode":"Export mode"}function l(){o&&o.startsWith("blob:")&&URL.revokeObjectURL(o),o=null}function p(t,n){l(),o=t,e.pdfFrame.src=t,e.pdfFrame.classList.remove("hidden"),e.drop.classList.add("hidden"),e.pdfStatus.textContent=`Loaded: ${n}`,e.globalStatus.textContent="PDF loaded"}async function u(t){let n=t.trim().replace(/^\/+/,"");if(!n){e.pdfStatus.textContent="Enter a storage path first.";return}let r=window.yaar?.storage;if(!r){e.pdfStatus.textContent="Storage API unavailable in this app context.";return}try{let a=await r.read(n,{as:"arraybuffer"}),d=new Blob([a],{type:"application/pdf"}),g=URL.createObjectURL(d);p(g,n)}catch(a){let d=a instanceof Error?a.message:String(a);e.pdfStatus.textContent=`Failed to read storage file: ${d}`}}function i(){let t=e.contentInput.value.trim();if(!t){e.printArea.innerHTML='<p style="color:#57606a;">No content yet.</p>';return}if(/<\/?[a-z][\s\S]*>/i.test(t))e.printArea.innerHTML=t;else{let r=t.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;").replaceAll(`
`,"<br>");e.printArea.innerHTML=`<div>${r}</div>`}}async function f(){let t=window.yaar?.storage;if(!t){e.globalStatus.textContent="Storage API unavailable";return}let r=`pdf-viewer/exports/export-${new Date().toISOString().replace(/[:.]/g,"-")}.html`;await t.save(r,e.printArea.innerHTML||"<p></p>"),e.globalStatus.textContent=`Saved HTML: ${r}`}e.btnViewer.addEventListener("click",()=>s("viewer"));e.btnExport.addEventListener("click",()=>s("export"));e.fileInput.addEventListener("change",()=>{let t=e.fileInput.files?.[0];if(!t)return;let n=URL.createObjectURL(t);p(n,t.name)});e.clearPdf.addEventListener("click",()=>{l(),e.pdfFrame.src="",e.pdfFrame.classList.add("hidden"),e.drop.classList.remove("hidden"),e.pdfStatus.textContent="No PDF loaded.",e.globalStatus.textContent="Viewer cleared"});e.openStorage.addEventListener("click",()=>u(e.storagePath.value));e.storagePath.addEventListener("keydown",t=>{t.key==="Enter"&&u(e.storagePath.value)});e.drop.addEventListener("dragover",t=>{t.preventDefault(),e.drop.classList.add("drag")});e.drop.addEventListener("dragleave",()=>e.drop.classList.remove("drag"));e.drop.addEventListener("drop",t=>{t.preventDefault(),e.drop.classList.remove("drag");let n=t.dataTransfer?.files?.[0];if(!n)return;if(n.type!=="application/pdf"&&!n.name.toLowerCase().endsWith(".pdf")){e.pdfStatus.textContent="Only PDF files are supported.";return}let r=URL.createObjectURL(n);p(r,n.name)});e.previewBtn.addEventListener("click",()=>{i(),e.globalStatus.textContent="Preview updated"});e.exportBtn.addEventListener("click",()=>{i(),e.globalStatus.textContent="Opening print dialog... choose Save as PDF",window.print()});e.saveHtmlBtn.addEventListener("click",async()=>{i();try{await f()}catch(t){let n=t instanceof Error?t.message:String(t);e.globalStatus.textContent=`Save failed: ${n}`}});e.contentInput.value=`<h1>Document Title</h1>
<p>Write or paste your content here, then click <strong>Export PDF</strong>.</p>
<ul><li>Supports plain text</li><li>Supports basic HTML</li></ul>`;i();s("viewer");window.addEventListener("beforeunload",()=>l());

</script>
</body>
</html>