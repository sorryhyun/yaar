<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GitHub Manager</title>
<style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden}body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}</style>
<script>(function(){if(window.__yaarCaptureInstalled)return;window.__yaarCaptureInstalled=true;function respond(requestId,imageData){window.parent.postMessage({type:"yaar:capture-response",requestId,imageData},"*")}function inlineStyles(original,clone){var origEls=original.querySelectorAll("*");var cloneEls=clone.querySelectorAll("*");for(var i=0;i<origEls.length&&i<cloneEls.length;i++){var cs=window.getComputedStyle(origEls[i]);cloneEls[i].setAttribute("style",cs.cssText)}var rootCs=window.getComputedStyle(original);clone.setAttribute("style",rootCs.cssText)}function svgToCanvas(svgStr,w,h,cb){var blob=new Blob([svgStr],{type:"image/svg+xml;charset=utf-8"});var url=URL.createObjectURL(blob);var img=new Image;img.onload=function(){var c=document.createElement("canvas");c.width=w;c.height=h;var ctx=c.getContext("2d");ctx.drawImage(img,0,0,w,h);URL.revokeObjectURL(url);cb(c.toDataURL("image/png"))};img.onerror=function(){URL.revokeObjectURL(url);cb(null)};img.src=url}window.addEventListener("message",function(e){if(!e.data||e.data.type!=="yaar:capture-request")return;var requestId=e.data.requestId;var imageData=null;try{var canvases=document.querySelectorAll("canvas");if(canvases.length>0){var largest=null;var largestArea=0;for(var i=0;i<canvases.length;i++){var area=canvases[i].width*canvases[i].height;if(area>largestArea){largestArea=area;largest=canvases[i]}}if(largest){imageData=largest.toDataURL("image/png")}}if(imageData){respond(requestId,imageData);return}var svgs=document.querySelectorAll("svg");if(svgs.length>0){var largest=null;var largestArea=0;for(var i=0;i<svgs.length;i++){var rect=svgs[i].getBoundingClientRect();var area=rect.width*rect.height;if(area>largestArea){largestArea=area;largest=svgs[i]}}if(largest){var serializer=new XMLSerializer;var svgStr=serializer.serializeToString(largest);var rect=largest.getBoundingClientRect();svgToCanvas(svgStr,rect.width||300,rect.height||150,function(data){respond(requestId,data)});return}}var body=document.body;if(body){var w=Math.min(body.scrollWidth,window.innerWidth)||window.innerWidth||800;var h=Math.min(body.scrollHeight,window.innerHeight)||window.innerHeight||600;var clone=body.cloneNode(true);inlineStyles(body,clone);var remove=clone.querySelectorAll("script,iframe");for(var i=0;i<remove.length;i++)remove[i].remove();var xmlns="http://www.w3.org/1999/xhtml";var svgNS="http://www.w3.org/2000/svg";var xhtml=new XMLSerializer().serializeToString(clone);var svgStr='<svg xmlns="'+svgNS+'" width="'+w+'" height="'+h+'">'+'<foreignObject width="100%" height="100%">'+'<body xmlns="'+xmlns+'" style="margin:0;padding:0;">'+xhtml+"</body></foreignObject></svg>";svgToCanvas(svgStr,w,h,function(data){respond(requestId,data)});return}}catch(ex){}respond(requestId,null)})})();(function(){if(window.__yaarStorageInstalled)return;window.__yaarStorageInstalled=true;function encodePath(p){return p.split("/").map(encodeURIComponent).join("/")}window.yaar=window.yaar||{};window.yaar.storage={async save(path,data){var body;if(typeof data==="string"){body=data}else if(data instanceof Blob){body=await data.arrayBuffer()}else if(data instanceof ArrayBuffer){body=data}else if(data instanceof Uint8Array){body=data.buffer.slice(data.byteOffset,data.byteOffset+data.byteLength)}else{body=String(data)}var res=await fetch("/api/storage/"+encodePath(path),{method:"POST",body});if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Save failed")}return res.json()},async read(path,options){var mode=options&&options.as||"auto";var res=await fetch("/api/storage/"+encodePath(path));if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Read failed")}if(mode==="blob")return res.blob();if(mode==="arraybuffer")return res.arrayBuffer();if(mode==="json")return res.json();if(mode==="text")return res.text();var ct=res.headers.get("content-type")||"";if(ct.includes("json"))return res.json();if(ct.startsWith("text/"))return res.text();return res.blob()},async list(dirPath){var p=dirPath?encodePath(dirPath):"";var res=await fetch("/api/storage/"+p+"?list=true");if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"List failed")}return res.json()},async remove(path){var res=await fetch("/api/storage/"+encodePath(path),{method:"DELETE"});if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Delete failed")}return res.json()},url:function(path){return"/api/storage/"+encodePath(path)}}})();(function(){if(window.__yaarFetchProxyInstalled)return;window.__yaarFetchProxyInstalled=true;var realFetch=window.fetch.bind(window);var sessionId="";try{var sp=new URLSearchParams(location.search);var raw=sp.get("sessionId")||"";if(/^[a-zA-Z0-9_-]+$/.test(raw))sessionId=raw}catch(e){}window.fetch=function(input,init){var url;if(input instanceof Request){url=input.url}else{url=String(input)}if(url.startsWith("/")||url.startsWith("./")||url.startsWith("../")){return realFetch(input,init)}try{var parsed=new URL(url,location.origin);if(parsed.origin===location.origin){return realFetch(input,init)}}catch(e){return realFetch(input,init)}var method=init&&init.method||(input instanceof Request?input.method:"GET");var headers={};if(init&&init.headers){if(init.headers instanceof Headers){init.headers.forEach(function(v,k){headers[k]=v})}else if(Array.isArray(init.headers)){init.headers.forEach(function(pair){headers[pair[0]]=pair[1]})}else{headers=Object.assign({},init.headers)}}else if(input instanceof Request){input.headers.forEach(function(v,k){headers[k]=v})}var bodyPromise;if(init&&init.body!=null){if(typeof init.body==="string"){bodyPromise=Promise.resolve(init.body)}else{bodyPromise=new Response(init.body).text()}}else if(input instanceof Request&&method!=="GET"&&method!=="HEAD"){bodyPromise=input.text()}else{bodyPromise=Promise.resolve(undefined)}return bodyPromise.then(function(bodyStr){var payload={url,method,headers};if(bodyStr!==undefined)payload.body=bodyStr;if(sessionId)payload.sessionId=sessionId;return realFetch("/api/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)})}).then(function(proxyRes){if(!proxyRes.ok){return proxyRes.json().then(function(err){throw new Error(err.error||"Fetch proxy error: "+proxyRes.status)})}return proxyRes.json()}).then(function(data){var body;if(data.bodyEncoding==="base64"){var bin=atob(data.body);var bytes=new Uint8Array(bin.length);for(var i=0;i<bin.length;i++)bytes[i]=bin.charCodeAt(i);body=bytes.buffer}else{body=data.body}return new Response(body,{status:data.status,statusText:data.statusText,headers:data.headers})})}})();(function(){if(window.__yaarAppProtocolInstalled)return;window.__yaarAppProtocolInstalled=true;window.yaar=window.yaar||{};var registration=null;window.yaar.app={register:function(config){registration=config;window.parent.postMessage({type:"yaar:app-ready",appId:config.appId},"*")},sendInteraction:function(description){window.parent.postMessage({type:"yaar:app-interaction",content:typeof description==="string"?description:JSON.stringify(description)},"*")}};window.addEventListener("message",function(e){if(!e.data||!e.data.type)return;var msg=e.data;var requestId=msg.requestId;if(msg.type==="yaar:app-manifest-request"){if(!registration){window.parent.postMessage({type:"yaar:app-manifest-response",requestId,manifest:null,error:"No app registered"},"*");return}var manifest={appId:registration.appId,name:registration.name,state:{},commands:{}};if(registration.state){for(var key in registration.state){var s=registration.state[key];manifest.state[key]={description:s.description};if(s.schema)manifest.state[key].schema=s.schema}}if(registration.commands){for(var key in registration.commands){var c=registration.commands[key];manifest.commands[key]={description:c.description};if(c.params)manifest.commands[key].params=c.params;if(c.returns)manifest.commands[key].returns=c.returns}}window.parent.postMessage({type:"yaar:app-manifest-response",requestId,manifest},"*");return}if(msg.type==="yaar:app-query-request"){if(!registration||!registration.state||!registration.state[msg.stateKey]){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:"Unknown state key: "+msg.stateKey},"*");return}try{var result=registration.state[msg.stateKey].handler();if(result&&typeof result.then==="function"){result.then(function(data){window.parent.postMessage({type:"yaar:app-query-response",requestId,data},"*")}).catch(function(err){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:String(err)},"*")})}else{window.parent.postMessage({type:"yaar:app-query-response",requestId,data:result},"*")}}catch(err){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:String(err)},"*")}return}if(msg.type==="yaar:app-command-request"){if(!registration||!registration.commands||!registration.commands[msg.command]){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:"Unknown command: "+msg.command},"*");return}try{var result=registration.commands[msg.command].handler(msg.params);if(result&&typeof result.then==="function"){result.then(function(data){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:data},"*")}).catch(function(err){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:String(err)},"*")})}else{window.parent.postMessage({type:"yaar:app-command-response",requestId,result},"*")}}catch(err){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:String(err)},"*")}return}})})();</script>
</head>
<body>
<div id="app"></div>
<script type="module">
var $=document.createElement("div");$.innerHTML=`
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #0b1020; color: #e5e7eb; }
    .app { display: grid; grid-template-rows: auto 1fr; height: 100vh; }
    .top { padding: 12px; border-bottom: 1px solid #1f2937; background: #0f172a; display: grid; gap: 8px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input, textarea, button { border-radius: 8px; border: 1px solid #334155; background: #111827; color: #e5e7eb; }
    input, textarea { padding: 8px 10px; }
    button { padding: 8px 12px; cursor: pointer; }
    button:hover { border-color: #60a5fa; }
    .main { display: grid; grid-template-columns: 360px 1fr; min-height: 0; }
    .panel { border-right: 1px solid #1f2937; overflow: auto; }
    .panel:last-child { border-right: 0; }
    .repos { padding: 8px; display: grid; gap: 8px; }
    .repo { border: 1px solid #334155; border-radius: 10px; padding: 10px; background: #0f172a; cursor: pointer; }
    .repo.active { border-color: #60a5fa; background: #111827; }
    .repo-title { font-weight: 600; }
    .muted { color: #94a3b8; font-size: 12px; }
    .right { padding: 12px; overflow: auto; display: grid; gap: 12px; align-content: start; }
    .card { border: 1px solid #334155; border-radius: 10px; padding: 12px; background: #0f172a; }
    .issues { display: grid; gap: 8px; }
    .issue { border: 1px solid #334155; border-radius: 8px; padding: 8px; }
    .status { font-size: 12px; color: #93c5fd; }
    .pill { display: inline-block; border: 1px solid #334155; border-radius: 999px; padding: 2px 8px; font-size: 11px; margin-left: 6px; }
    a { color: #93c5fd; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .grow { flex: 1; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; background: #020617; border: 1px dashed #334155; padding: 4px 8px; border-radius: 8px; }
  </style>
  <div class="app">
    <div class="top">
      <div class="row">
        <input id="token" class="grow" type="password" placeholder="GitHub token (OAuth or PAT)" />
        <button id="saveToken">Save token</button>
        <button id="loadRepos">Load repos</button>
      </div>
      <div class="row">
        <input id="oauthClientId" class="grow" type="text" placeholder="GitHub OAuth App Client ID (for Login with GitHub)" />
        <button id="oauthLogin">Login with GitHub</button>
        <button id="oauthCancel" style="display:none;">Cancel login</button>
      </div>
      <div class="row" id="oauthHintRow" style="display:none;">
        <span class="muted">User code:</span>
        <span id="oauthUserCode" class="code">-</span>
        <button id="openVerify">Open verification page</button>
      </div>
      <div class="row">
        <input id="filter" class="grow" type="text" placeholder="Filter repos..." />
        <span id="me" class="muted"></span>
        <span id="status" class="status">Ready</span>
      </div>
    </div>
    <div class="main">
      <div class="panel">
        <div id="repos" class="repos"></div>
      </div>
      <div class="panel right">
        <div class="card">
          <div><strong id="selectedRepo">No repo selected</strong></div>
          <div class="muted" id="selectedRepoMeta"></div>
        </div>

        <div class="card">
          <div style="font-weight:600; margin-bottom:8px;">Create issue</div>
          <div class="row" style="display:grid; gap:8px;">
            <input id="issueTitle" type="text" placeholder="Issue title" />
            <textarea id="issueBody" rows="4" placeholder="Issue body"></textarea>
            <button id="createIssue">Create issue in selected repo</button>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center; gap:8px;">
            <strong>Open issues / PRs</strong>
            <button id="refreshIssues">Refresh</button>
          </div>
          <div id="issues" class="issues" style="margin-top:8px;"></div>
        </div>
      </div>
    </div>
  </div>
`;document.body.appendChild($);var l=document.getElementById("token"),I=document.getElementById("oauthClientId"),A=document.getElementById("oauthUserCode"),P=document.getElementById("oauthHintRow"),N=document.getElementById("openVerify"),T=document.getElementById("oauthCancel"),S=document.getElementById("filter"),j=document.getElementById("me"),z=document.getElementById("status"),v=document.getElementById("repos"),m=document.getElementById("issues"),C=document.getElementById("selectedRepo"),R=document.getElementById("selectedRepoMeta"),w=document.getElementById("issueTitle"),x=document.getElementById("issueBody"),d=[],b=[],u=[],s=null,k="",E="",p="",f=!1,D="github-manager/config.json";function n(e){z.textContent=e}async function O(e){await window.yaar?.storage?.save(D,JSON.stringify(e))}async function U(){try{return await window.yaar?.storage?.read(D,{as:"json"})??{}}catch{return{}}}function q(e){return{Authorization:`Bearer ${e}`,Accept:"application/vnd.github+json","X-GitHub-Api-Version":"2022-11-28"}}async function y(e,t,o){let i=await fetch(`https://api.github.com${e}`,{...o,headers:{...q(t),...o?.headers||{}}});if(!i.ok){let r=await i.text();throw Error(`GitHub API ${i.status}: ${r.slice(0,200)}`)}return await i.json()}function g(){let e=S.value.trim().toLowerCase();if(b=e?d.filter((t)=>t.full_name.toLowerCase().includes(e)):d,v.innerHTML="",!b.length){v.innerHTML='<div class="muted">No repos found.</div>';return}for(let t of b){let o=document.createElement("div");o.className=`repo ${s?.id===t.id?"active":""}`,o.innerHTML=`
      <div class="repo-title">${t.full_name}</div>
      <div class="muted">${t.description??""}</div>
      <div class="muted">★ ${t.stargazers_count} · Forks ${t.forks_count} · ${t.private?"Private":"Public"}</div>
    `,o.onclick=async()=>{s=t,g(),L(),await h(),window.yaar?.app?.sendInteraction?.({event:"repo_selected",repo:t.full_name})},v.appendChild(o)}}function L(){if(!s){C.textContent="No repo selected",R.textContent="";return}C.textContent=s.full_name,R.innerHTML=`<a href="${s.html_url}" target="_blank">Open on GitHub</a> · Updated ${new Date(s.updated_at).toLocaleString()}`}function _(){if(m.innerHTML="",!s){m.innerHTML='<div class="muted">Select a repo first.</div>';return}if(!u.length){m.innerHTML='<div class="muted">No open issues/PRs.</div>';return}for(let e of u){let t=!!e.pull_request,o=document.createElement("div");o.className="issue",o.innerHTML=`
      <div><a href="${e.html_url}" target="_blank">#${e.number} ${e.title}</a>${t?'<span class="pill">PR</span>':'<span class="pill">Issue</span>'}</div>
      <div class="muted">by ${e.user?.login??"unknown"} · ${new Date(e.created_at).toLocaleString()}</div>
    `,m.appendChild(o)}}async function F(){let e=l.value.trim();if(!e)return;k=(await y("/user",e)).login,j.textContent=`Signed in: ${k}`}async function H(){let e=l.value.trim();if(!e){n("Add token first");return}n("Loading repos...");try{await F(),d=await y("/user/repos?per_page=100&sort=updated",e),g(),n(`Loaded ${d.length} repos`)}catch(t){n(t?.message||"Failed loading repos")}}async function h(){let e=l.value.trim();if(!e||!s){_();return}n(`Loading issues for ${s.full_name}...`);try{u=await y(`/repos/${s.full_name}/issues?state=open&per_page=30`,e),_(),n(`Loaded ${u.length} items`)}catch(t){n(t?.message||"Failed loading issues")}}async function G(){let e=l.value.trim(),t=w.value.trim(),o=x.value.trim();if(!e)return n("Add token first");if(!s)return n("Select repo first");if(!t)return n("Issue title is required");n("Creating issue...");try{let i=await y(`/repos/${s.full_name}/issues`,e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t,body:o})});w.value="",x.value="",n(`Created #${i.number}`),await h()}catch(i){n(i?.message||"Failed creating issue")}}function c(e=!0){if(f=!0,E="",p="",T.style.display="none",e)P.style.display="none",A.textContent="-"}async function M(e,t){let o=new URLSearchParams(t),i=await fetch(e,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/x-www-form-urlencoded"},body:o}),r=await i.text(),a={};try{a=JSON.parse(r||"{}")}catch{throw Error(`Unexpected response from ${e}`)}if(!i.ok)throw Error(a.error_description||a.error||`HTTP ${i.status}`);return a}async function V(){let e=I.value.trim();if(!e){n("Enter OAuth App Client ID first");return}try{n("Requesting GitHub device code..."),f=!1,T.style.display="inline-block";let t=await M("https://github.com/login/device/code",{client_id:e,scope:"repo read:user"});E=t.device_code,p=t.verification_uri_complete||t.verification_uri,A.textContent=t.user_code,P.style.display="flex",window.open(p,"_blank","noopener,noreferrer"),n("Finish login in the opened GitHub page, then waiting for token...");let o=Math.max(5,t.interval||5)*1000,i=Date.now()+t.expires_in*1000;while(!f&&Date.now()<i){await new Promise((a)=>setTimeout(a,o));let r=await M("https://github.com/login/oauth/access_token",{client_id:e,device_code:E,grant_type:"urn:ietf:params:oauth:grant-type:device_code"});if(r.access_token){l.value=r.access_token,await O({token:r.access_token,oauthClientId:e}),c(),n("GitHub login successful — token saved"),await H(),window.yaar?.app?.sendInteraction?.({event:"oauth_login_success"});return}if(r.error==="authorization_pending")continue;if(r.error==="slow_down"){await new Promise((a)=>setTimeout(a,o));continue}if(r.error==="expired_token"){c(),n("Login timed out. Please try again.");return}throw Error(r.error_description||r.error||"OAuth failed")}if(!f)c(),n("Login canceled or expired")}catch(t){c(!1),n(`OAuth failed: ${t?.message||"unknown error"} (PAT still works)`)}}document.getElementById("saveToken").onclick=async()=>{let e=l.value.trim();if(!e)return n("Token is empty");await O({token:e,oauthClientId:I.value.trim()||void 0}),n("Token saved locally")};document.getElementById("loadRepos").onclick=()=>H();document.getElementById("refreshIssues").onclick=()=>h();document.getElementById("createIssue").onclick=()=>G();document.getElementById("oauthLogin").onclick=()=>V();T.onclick=()=>{c(),n("OAuth login canceled")};N.onclick=()=>{if(!p)return;window.open(p,"_blank","noopener,noreferrer")};S.oninput=()=>g();async function J(){let e=await U();if(e.token)l.value=e.token,n("Loaded saved token");if(e.oauthClientId)I.value=e.oauthClientId;g(),L(),_()}J();var B=window.yaar?.app;if(B)B.register({appId:"github-manager",name:"GitHub Manager",state:{viewer:{description:"Current authenticated viewer login",handler:()=>k},repos:{description:"Loaded repositories",handler:()=>[...d]},selectedRepo:{description:"Currently selected repo full name",handler:()=>s?.full_name??null},issues:{description:"Loaded issues for selected repo",handler:()=>[...u]}},commands:{refreshRepos:{description:"Load repositories from GitHub API",params:{type:"object",properties:{}},handler:async()=>{return await H(),{ok:!0,count:d.length}}},selectRepo:{description:"Select a repo by full name and load issues",params:{type:"object",properties:{fullName:{type:"string"}},required:["fullName"]},handler:async(e)=>{let t=d.find((o)=>o.full_name===e.fullName);if(!t)throw Error("Repo not found");return s=t,g(),L(),await h(),{ok:!0}}},createIssue:{description:"Create an issue in the selected repo",params:{type:"object",properties:{title:{type:"string"},body:{type:"string"}},required:["title"]},handler:async(e)=>{return w.value=e.title,x.value=e.body??"",await G(),{ok:!0}}}}});

</script>
</body>
</html>