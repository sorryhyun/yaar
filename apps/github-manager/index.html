<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GitHub Manager</title>
<style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden}body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}</style>
<script>(function(){if(window.__yaarCaptureInstalled)return;window.__yaarCaptureInstalled=!0;function s(r,n){window.parent.postMessage({type:"yaar:capture-response",requestId:r,imageData:n},"*")}function o(r,n){for(var d=r.querySelectorAll("*"),u=n.querySelectorAll("*"),i=0;i<d.length&&i<u.length;i++){var t=window.getComputedStyle(d[i]);u[i].setAttribute("style",t.cssText)}var a=window.getComputedStyle(r);n.setAttribute("style",a.cssText)}function e(r,n,d,u){var i=new Blob([r],{type:"image/svg+xml;charset=utf-8"}),t=URL.createObjectURL(i),a=new Image;a.onload=function(){var f=document.createElement("canvas");f.width=n,f.height=d;var p=f.getContext("2d");p.drawImage(a,0,0,n,d),URL.revokeObjectURL(t),u(f.toDataURL("image/png"))},a.onerror=function(){URL.revokeObjectURL(t),u(null)},a.src=t}window.addEventListener("message",function(r){if(!(!r.data||r.data.type!=="yaar:capture-request")){var n=r.data.requestId,d=null;try{var u=document.querySelectorAll("canvas");if(u.length>0){for(var i=null,t=0,a=0;a<u.length;a++){var f=u[a].width*u[a].height;f>t&&(t=f,i=u[a])}i&&(d=i.toDataURL("image/png"))}if(d){s(n,d);return}var p=document.querySelectorAll("svg");if(p.length>0){for(var i=null,t=0,a=0;a<p.length;a++){var c=p[a].getBoundingClientRect(),f=c.width*c.height;f>t&&(t=f,i=p[a])}if(i){var v=new XMLSerializer,w=v.serializeToString(i),c=i.getBoundingClientRect();e(w,c.width||300,c.height||150,function(j){s(n,j)});return}}var l=document.body;if(l){var h=Math.min(l.scrollWidth,window.innerWidth)||window.innerWidth||800,g=Math.min(l.scrollHeight,window.innerHeight)||window.innerHeight||600,y=l.cloneNode(!0);o(l,y);for(var m=y.querySelectorAll("script,iframe"),a=0;a<m.length;a++)m[a].remove();var q="http://www.w3.org/1999/xhtml",b="http://www.w3.org/2000/svg",I=new XMLSerializer().serializeToString(y),w='<svg xmlns="'+b+'" width="'+h+'" height="'+g+'"><foreignObject width="100%" height="100%"><body xmlns="'+q+'" style="margin:0;padding:0;">'+I+"</body></foreignObject></svg>";e(w,h,g,function(S){s(n,S)});return}}catch{}s(n,null)}})})(),function(){if(window.__yaarStorageInstalled)return;window.__yaarStorageInstalled=!0;function s(o){return o.split("/").map(encodeURIComponent).join("/")}window.yaar=window.yaar||{},window.yaar.storage={async save(o,e){var r;typeof e=="string"?r=e:e instanceof Blob?r=await e.arrayBuffer():e instanceof ArrayBuffer?r=e:e instanceof Uint8Array?r=e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength):r=String(e);var n=await fetch("/api/storage/"+s(o),{method:"POST",body:r});if(!n.ok){var d=await n.json().catch(function(){return{error:n.statusText}});throw new Error(d.error||"Save failed")}return n.json()},async read(o,e){var r=e&&e.as||"auto",n=await fetch("/api/storage/"+s(o));if(!n.ok){var d=await n.json().catch(function(){return{error:n.statusText}});throw new Error(d.error||"Read failed")}if(r==="blob")return n.blob();if(r==="arraybuffer")return n.arrayBuffer();if(r==="json")return n.json();if(r==="text")return n.text();var u=n.headers.get("content-type")||"";return u.includes("json")?n.json():u.startsWith("text/")?n.text():n.blob()},async list(o){var e=o?s(o):"",r=await fetch("/api/storage/"+e+"?list=true");if(!r.ok){var n=await r.json().catch(function(){return{error:r.statusText}});throw new Error(n.error||"List failed")}return r.json()},async remove(o){var e=await fetch("/api/storage/"+s(o),{method:"DELETE"});if(!e.ok){var r=await e.json().catch(function(){return{error:e.statusText}});throw new Error(r.error||"Delete failed")}return e.json()},url:function(o){return"/api/storage/"+s(o)}}}(),function(){if(!window.__yaarFetchProxyInstalled){window.__yaarFetchProxyInstalled=!0;var s=window.fetch.bind(window);window.fetch=function(o,e){var r;if(o instanceof Request?r=o.url:r=String(o),r.startsWith("/")||r.startsWith("./")||r.startsWith("../"))return s(o,e);try{var n=new URL(r,location.origin);if(n.origin===location.origin)return s(o,e)}catch{return s(o,e)}var d=e&&e.method||(o instanceof Request?o.method:"GET"),u={};e&&e.headers?e.headers instanceof Headers?e.headers.forEach(function(t,a){u[a]=t}):Array.isArray(e.headers)?e.headers.forEach(function(t){u[t[0]]=t[1]}):u=Object.assign({},e.headers):o instanceof Request&&o.headers.forEach(function(t,a){u[a]=t});var i;return e&&e.body!=null?typeof e.body=="string"?i=Promise.resolve(e.body):i=new Response(e.body).text():o instanceof Request&&d!=="GET"&&d!=="HEAD"?i=o.text():i=Promise.resolve(void 0),i.then(function(t){var a={url:r,method:d,headers:u};return t!==void 0&&(a.body=t),s("/api/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})}).then(function(t){return t.ok?t.json():t.json().then(function(a){throw new Error(a.error||"Fetch proxy error: "+t.status)})}).then(function(t){var a;if(t.bodyEncoding==="base64"){for(var f=atob(t.body),p=new Uint8Array(f.length),c=0;c<f.length;c++)p[c]=f.charCodeAt(c);a=p.buffer}else a=t.body;return new Response(a,{status:t.status,statusText:t.statusText,headers:t.headers})})}}}(),function(){if(!window.__yaarAppProtocolInstalled){window.__yaarAppProtocolInstalled=!0,window.yaar=window.yaar||{};var s=null;window.yaar.app={register:function(o){s=o,window.parent.postMessage({type:"yaar:app-ready",appId:o.appId},"*")},sendInteraction:function(o){window.parent.postMessage({type:"yaar:app-interaction",content:typeof o=="string"?o:JSON.stringify(o)},"*")}},window.addEventListener("message",function(o){if(!(!o.data||!o.data.type)){var e=o.data,r=e.requestId;if(e.type==="yaar:app-manifest-request"){if(!s){window.parent.postMessage({type:"yaar:app-manifest-response",requestId:r,manifest:null,error:"No app registered"},"*");return}var n={appId:s.appId,name:s.name,state:{},commands:{}};if(s.state)for(var d in s.state){var u=s.state[d];n.state[d]={description:u.description},u.schema&&(n.state[d].schema=u.schema)}if(s.commands)for(var d in s.commands){var i=s.commands[d];n.commands[d]={description:i.description},i.params&&(n.commands[d].params=i.params),i.returns&&(n.commands[d].returns=i.returns)}window.parent.postMessage({type:"yaar:app-manifest-response",requestId:r,manifest:n},"*");return}if(e.type==="yaar:app-query-request"){if(!s||!s.state||!s.state[e.stateKey]){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:null,error:"Unknown state key: "+e.stateKey},"*");return}try{var t=s.state[e.stateKey].handler();t&&typeof t.then=="function"?t.then(function(a){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:a},"*")}).catch(function(a){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:null,error:String(a)},"*")}):window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:t},"*")}catch(a){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:null,error:String(a)},"*")}return}if(e.type==="yaar:app-command-request"){if(!s||!s.commands||!s.commands[e.command]){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:null,error:"Unknown command: "+e.command},"*");return}try{var t=s.commands[e.command].handler(e.params);t&&typeof t.then=="function"?t.then(function(f){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:f},"*")}).catch(function(f){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:null,error:String(f)},"*")}):window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:t},"*")}catch(a){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:null,error:String(a)},"*")}return}}})}}();</script>
</head>
<body>
<div id="app"></div>
<script type="module">
var $=document.createElement("div");$.innerHTML=`
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #0b1020; color: #e5e7eb; }
    .app { display: grid; grid-template-rows: auto 1fr; height: 100vh; }
    .top { padding: 12px; border-bottom: 1px solid #1f2937; background: #0f172a; display: grid; gap: 8px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input, textarea, button { border-radius: 8px; border: 1px solid #334155; background: #111827; color: #e5e7eb; }
    input, textarea { padding: 8px 10px; }
    button { padding: 8px 12px; cursor: pointer; }
    button:hover { border-color: #60a5fa; }
    .main { display: grid; grid-template-columns: 360px 1fr; min-height: 0; }
    .panel { border-right: 1px solid #1f2937; overflow: auto; }
    .panel:last-child { border-right: 0; }
    .repos { padding: 8px; display: grid; gap: 8px; }
    .repo { border: 1px solid #334155; border-radius: 10px; padding: 10px; background: #0f172a; cursor: pointer; }
    .repo.active { border-color: #60a5fa; background: #111827; }
    .repo-title { font-weight: 600; }
    .muted { color: #94a3b8; font-size: 12px; }
    .right { padding: 12px; overflow: auto; display: grid; gap: 12px; align-content: start; }
    .card { border: 1px solid #334155; border-radius: 10px; padding: 12px; background: #0f172a; }
    .issues { display: grid; gap: 8px; }
    .issue { border: 1px solid #334155; border-radius: 8px; padding: 8px; }
    .status { font-size: 12px; color: #93c5fd; }
    .pill { display: inline-block; border: 1px solid #334155; border-radius: 999px; padding: 2px 8px; font-size: 11px; margin-left: 6px; }
    a { color: #93c5fd; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .grow { flex: 1; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; background: #020617; border: 1px dashed #334155; padding: 4px 8px; border-radius: 8px; }
  </style>
  <div class="app">
    <div class="top">
      <div class="row">
        <input id="token" class="grow" type="password" placeholder="GitHub token (OAuth or PAT)" />
        <button id="saveToken">Save token</button>
        <button id="loadRepos">Load repos</button>
      </div>
      <div class="row">
        <input id="oauthClientId" class="grow" type="text" placeholder="GitHub OAuth App Client ID (for Login with GitHub)" />
        <button id="oauthLogin">Login with GitHub</button>
        <button id="oauthCancel" style="display:none;">Cancel login</button>
      </div>
      <div class="row" id="oauthHintRow" style="display:none;">
        <span class="muted">User code:</span>
        <span id="oauthUserCode" class="code">-</span>
        <button id="openVerify">Open verification page</button>
      </div>
      <div class="row">
        <input id="filter" class="grow" type="text" placeholder="Filter repos..." />
        <span id="me" class="muted"></span>
        <span id="status" class="status">Ready</span>
      </div>
    </div>
    <div class="main">
      <div class="panel">
        <div id="repos" class="repos"></div>
      </div>
      <div class="panel right">
        <div class="card">
          <div><strong id="selectedRepo">No repo selected</strong></div>
          <div class="muted" id="selectedRepoMeta"></div>
        </div>

        <div class="card">
          <div style="font-weight:600; margin-bottom:8px;">Create issue</div>
          <div class="row" style="display:grid; gap:8px;">
            <input id="issueTitle" type="text" placeholder="Issue title" />
            <textarea id="issueBody" rows="4" placeholder="Issue body"></textarea>
            <button id="createIssue">Create issue in selected repo</button>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center; gap:8px;">
            <strong>Open issues / PRs</strong>
            <button id="refreshIssues">Refresh</button>
          </div>
          <div id="issues" class="issues" style="margin-top:8px;"></div>
        </div>
      </div>
    </div>
  </div>
`;document.body.appendChild($);var l=document.getElementById("token"),I=document.getElementById("oauthClientId"),A=document.getElementById("oauthUserCode"),P=document.getElementById("oauthHintRow"),N=document.getElementById("openVerify"),T=document.getElementById("oauthCancel"),S=document.getElementById("filter"),j=document.getElementById("me"),z=document.getElementById("status"),v=document.getElementById("repos"),m=document.getElementById("issues"),C=document.getElementById("selectedRepo"),R=document.getElementById("selectedRepoMeta"),w=document.getElementById("issueTitle"),x=document.getElementById("issueBody"),d=[],b=[],u=[],s=null,k="",E="",p="",f=!1,D="github-manager/config.json";function n(e){z.textContent=e}async function O(e){await window.yaar?.storage?.save(D,JSON.stringify(e))}async function U(){try{return await window.yaar?.storage?.read(D,{as:"json"})??{}}catch{return{}}}function q(e){return{Authorization:`Bearer ${e}`,Accept:"application/vnd.github+json","X-GitHub-Api-Version":"2022-11-28"}}async function y(e,t,o){let i=await fetch(`https://api.github.com${e}`,{...o,headers:{...q(t),...o?.headers||{}}});if(!i.ok){let r=await i.text();throw new Error(`GitHub API ${i.status}: ${r.slice(0,200)}`)}return await i.json()}function g(){let e=S.value.trim().toLowerCase();if(b=e?d.filter(t=>t.full_name.toLowerCase().includes(e)):d,v.innerHTML="",!b.length){v.innerHTML='<div class="muted">No repos found.</div>';return}for(let t of b){let o=document.createElement("div");o.className=`repo ${s?.id===t.id?"active":""}`,o.innerHTML=`
      <div class="repo-title">${t.full_name}</div>
      <div class="muted">${t.description??""}</div>
      <div class="muted">\u2605 ${t.stargazers_count} \xB7 Forks ${t.forks_count} \xB7 ${t.private?"Private":"Public"}</div>
    `,o.onclick=async()=>{s=t,g(),L(),await h(),window.yaar?.app?.sendInteraction?.({event:"repo_selected",repo:t.full_name})},v.appendChild(o)}}function L(){if(!s){C.textContent="No repo selected",R.textContent="";return}C.textContent=s.full_name,R.innerHTML=`<a href="${s.html_url}" target="_blank">Open on GitHub</a> \xB7 Updated ${new Date(s.updated_at).toLocaleString()}`}function _(){if(m.innerHTML="",!s){m.innerHTML='<div class="muted">Select a repo first.</div>';return}if(!u.length){m.innerHTML='<div class="muted">No open issues/PRs.</div>';return}for(let e of u){let t=!!e.pull_request,o=document.createElement("div");o.className="issue",o.innerHTML=`
      <div><a href="${e.html_url}" target="_blank">#${e.number} ${e.title}</a>${t?'<span class="pill">PR</span>':'<span class="pill">Issue</span>'}</div>
      <div class="muted">by ${e.user?.login??"unknown"} \xB7 ${new Date(e.created_at).toLocaleString()}</div>
    `,m.appendChild(o)}}async function F(){let e=l.value.trim();if(!e)return;k=(await y("/user",e)).login,j.textContent=`Signed in: ${k}`}async function H(){let e=l.value.trim();if(!e){n("Add token first");return}n("Loading repos...");try{await F(),d=await y("/user/repos?per_page=100&sort=updated",e),g(),n(`Loaded ${d.length} repos`)}catch(t){n(t?.message||"Failed loading repos")}}async function h(){let e=l.value.trim();if(!e||!s){_();return}n(`Loading issues for ${s.full_name}...`);try{u=await y(`/repos/${s.full_name}/issues?state=open&per_page=30`,e),_(),n(`Loaded ${u.length} items`)}catch(t){n(t?.message||"Failed loading issues")}}async function G(){let e=l.value.trim(),t=w.value.trim(),o=x.value.trim();if(!e)return n("Add token first");if(!s)return n("Select repo first");if(!t)return n("Issue title is required");n("Creating issue...");try{let i=await y(`/repos/${s.full_name}/issues`,e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t,body:o})});w.value="",x.value="",n(`Created #${i.number}`),await h()}catch(i){n(i?.message||"Failed creating issue")}}function c(e=!0){f=!0,E="",p="",T.style.display="none",e&&(P.style.display="none",A.textContent="-")}async function M(e,t){let o=new URLSearchParams(t),i=await fetch(e,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/x-www-form-urlencoded"},body:o}),r=await i.text(),a={};try{a=JSON.parse(r||"{}")}catch{throw new Error(`Unexpected response from ${e}`)}if(!i.ok)throw new Error(a.error_description||a.error||`HTTP ${i.status}`);return a}async function V(){let e=I.value.trim();if(!e){n("Enter OAuth App Client ID first");return}try{n("Requesting GitHub device code..."),f=!1,T.style.display="inline-block";let t=await M("https://github.com/login/device/code",{client_id:e,scope:"repo read:user"});E=t.device_code,p=t.verification_uri_complete||t.verification_uri,A.textContent=t.user_code,P.style.display="flex",window.open(p,"_blank","noopener,noreferrer"),n("Finish login in the opened GitHub page, then waiting for token...");let o=Math.max(5,t.interval||5)*1e3,i=Date.now()+t.expires_in*1e3;for(;!f&&Date.now()<i;){await new Promise(a=>setTimeout(a,o));let r=await M("https://github.com/login/oauth/access_token",{client_id:e,device_code:E,grant_type:"urn:ietf:params:oauth:grant-type:device_code"});if(r.access_token){l.value=r.access_token,await O({token:r.access_token,oauthClientId:e}),c(),n("GitHub login successful \u2014 token saved"),await H(),window.yaar?.app?.sendInteraction?.({event:"oauth_login_success"});return}if(r.error!=="authorization_pending"){if(r.error==="slow_down"){await new Promise(a=>setTimeout(a,o));continue}if(r.error==="expired_token"){c(),n("Login timed out. Please try again.");return}throw new Error(r.error_description||r.error||"OAuth failed")}}f||(c(),n("Login canceled or expired"))}catch(t){c(!1),n(`OAuth failed: ${t?.message||"unknown error"} (PAT still works)`)}}document.getElementById("saveToken").onclick=async()=>{let e=l.value.trim();if(!e)return n("Token is empty");await O({token:e,oauthClientId:I.value.trim()||void 0}),n("Token saved locally")};document.getElementById("loadRepos").onclick=()=>H();document.getElementById("refreshIssues").onclick=()=>h();document.getElementById("createIssue").onclick=()=>G();document.getElementById("oauthLogin").onclick=()=>V();T.onclick=()=>{c(),n("OAuth login canceled")};N.onclick=()=>{p&&window.open(p,"_blank","noopener,noreferrer")};S.oninput=()=>g();async function J(){let e=await U();e.token&&(l.value=e.token,n("Loaded saved token")),e.oauthClientId&&(I.value=e.oauthClientId),g(),L(),_()}J();var B=window.yaar?.app;B&&B.register({appId:"github-manager",name:"GitHub Manager",state:{viewer:{description:"Current authenticated viewer login",handler:()=>k},repos:{description:"Loaded repositories",handler:()=>[...d]},selectedRepo:{description:"Currently selected repo full name",handler:()=>s?.full_name??null},issues:{description:"Loaded issues for selected repo",handler:()=>[...u]}},commands:{refreshRepos:{description:"Load repositories from GitHub API",params:{type:"object",properties:{}},handler:async()=>(await H(),{ok:!0,count:d.length})},selectRepo:{description:"Select a repo by full name and load issues",params:{type:"object",properties:{fullName:{type:"string"}},required:["fullName"]},handler:async e=>{let t=d.find(o=>o.full_name===e.fullName);if(!t)throw new Error("Repo not found");return s=t,g(),L(),await h(),{ok:!0}}},createIssue:{description:"Create an issue in the selected repo",params:{type:"object",properties:{title:{type:"string"},body:{type:"string"}},required:["title"]},handler:async e=>(w.value=e.title,x.value=e.body??"",await G(),{ok:!0})}}});

</script>
</body>
</html>