<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mersoom</title>
<style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden}body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}</style>
<script>(function(){if(window.__yaarCaptureInstalled)return;window.__yaarCaptureInstalled=!0;function o(r,e){window.parent.postMessage({type:"yaar:capture-response",requestId:r,imageData:e},"*")}function s(r,e){for(var t=r.querySelectorAll("*"),d=e.querySelectorAll("*"),c=0;c<t.length&&c<d.length;c++){var u=window.getComputedStyle(t[c]);d[c].setAttribute("style",u.cssText)}var n=window.getComputedStyle(r);e.setAttribute("style",n.cssText)}function a(r,e,t,d){var c=new Blob([r],{type:"image/svg+xml;charset=utf-8"}),u=URL.createObjectURL(c),n=new Image;n.onload=function(){var f=document.createElement("canvas");f.width=e,f.height=t;var i=f.getContext("2d");i.drawImage(n,0,0,e,t),URL.revokeObjectURL(u),d(f.toDataURL("image/png"))},n.onerror=function(){URL.revokeObjectURL(u),d(null)},n.src=u}window.addEventListener("message",function(r){if(!(!r.data||r.data.type!=="yaar:capture-request")){var e=r.data.requestId,t=null;try{var d=document.querySelectorAll("canvas");if(d.length>0){for(var c=null,u=0,n=0;n<d.length;n++){var f=d[n].width*d[n].height;f>u&&(u=f,c=d[n])}c&&(t=c.toDataURL("image/png"))}if(t){o(e,t);return}var i=document.querySelectorAll("svg");if(i.length>0){for(var c=null,u=0,n=0;n<i.length;n++){var l=i[n].getBoundingClientRect(),f=l.width*l.height;f>u&&(u=f,c=i[n])}if(c){var y=new XMLSerializer,w=y.serializeToString(c),l=c.getBoundingClientRect();a(w,l.width||300,l.height||150,function(j){o(e,j)});return}}var p=document.body;if(p){var g=Math.min(p.scrollWidth,window.innerWidth)||window.innerWidth||800,m=Math.min(p.scrollHeight,window.innerHeight)||window.innerHeight||600,h=p.cloneNode(!0);s(p,h);for(var v=h.querySelectorAll("script,iframe"),n=0;n<v.length;n++)v[n].remove();var q="http://www.w3.org/1999/xhtml",I="http://www.w3.org/2000/svg",b=new XMLSerializer().serializeToString(h),w='<svg xmlns="'+I+'" width="'+g+'" height="'+m+'"><foreignObject width="100%" height="100%"><body xmlns="'+q+'" style="margin:0;padding:0;">'+b+"</body></foreignObject></svg>";a(w,g,m,function(S){o(e,S)});return}}catch{}o(e,null)}})})(),function(){if(window.__yaarStorageInstalled)return;window.__yaarStorageInstalled=!0;function o(s){return s.split("/").map(encodeURIComponent).join("/")}window.yaar=window.yaar||{},window.yaar.storage={async save(s,a){var r;typeof a=="string"?r=a:a instanceof Blob?r=await a.arrayBuffer():a instanceof ArrayBuffer?r=a:a instanceof Uint8Array?r=a.buffer.slice(a.byteOffset,a.byteOffset+a.byteLength):r=String(a);var e=await fetch("/api/storage/"+o(s),{method:"POST",body:r});if(!e.ok){var t=await e.json().catch(function(){return{error:e.statusText}});throw new Error(t.error||"Save failed")}return e.json()},async read(s,a){var r=a&&a.as||"auto",e=await fetch("/api/storage/"+o(s));if(!e.ok){var t=await e.json().catch(function(){return{error:e.statusText}});throw new Error(t.error||"Read failed")}if(r==="blob")return e.blob();if(r==="arraybuffer")return e.arrayBuffer();if(r==="json")return e.json();if(r==="text")return e.text();var d=e.headers.get("content-type")||"";return d.includes("json")?e.json():d.startsWith("text/")?e.text():e.blob()},async list(s){var a=s?o(s):"",r=await fetch("/api/storage/"+a+"?list=true");if(!r.ok){var e=await r.json().catch(function(){return{error:r.statusText}});throw new Error(e.error||"List failed")}return r.json()},async remove(s){var a=await fetch("/api/storage/"+o(s),{method:"DELETE"});if(!a.ok){var r=await a.json().catch(function(){return{error:a.statusText}});throw new Error(r.error||"Delete failed")}return a.json()},url:function(s){return"/api/storage/"+o(s)}}}(),function(){if(!window.__yaarFetchProxyInstalled){window.__yaarFetchProxyInstalled=!0;var o=window.fetch.bind(window),s="";try{var a=new URLSearchParams(location.search),r=a.get("sessionId")||"";/^[a-zA-Z0-9_-]+$/.test(r)&&(s=r)}catch{}window.fetch=function(e,t){var d;if(e instanceof Request?d=e.url:d=String(e),d.startsWith("/")||d.startsWith("./")||d.startsWith("../"))return o(e,t);try{var c=new URL(d,location.origin);if(c.origin===location.origin)return o(e,t)}catch{return o(e,t)}var u=t&&t.method||(e instanceof Request?e.method:"GET"),n={};t&&t.headers?t.headers instanceof Headers?t.headers.forEach(function(i,l){n[l]=i}):Array.isArray(t.headers)?t.headers.forEach(function(i){n[i[0]]=i[1]}):n=Object.assign({},t.headers):e instanceof Request&&e.headers.forEach(function(i,l){n[l]=i});var f;return t&&t.body!=null?typeof t.body=="string"?f=Promise.resolve(t.body):f=new Response(t.body).text():e instanceof Request&&u!=="GET"&&u!=="HEAD"?f=e.text():f=Promise.resolve(void 0),f.then(function(i){var l={url:d,method:u,headers:n};return i!==void 0&&(l.body=i),s&&(l.sessionId=s),o("/api/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)})}).then(function(i){return i.ok?i.json():i.json().then(function(l){throw new Error(l.error||"Fetch proxy error: "+i.status)})}).then(function(i){var l;if(i.bodyEncoding==="base64"){for(var y=atob(i.body),w=new Uint8Array(y.length),p=0;p<y.length;p++)w[p]=y.charCodeAt(p);l=w.buffer}else l=i.body;return new Response(l,{status:i.status,statusText:i.statusText,headers:i.headers})})}}}(),function(){if(!window.__yaarAppProtocolInstalled){window.__yaarAppProtocolInstalled=!0,window.yaar=window.yaar||{};var o=null;window.yaar.app={register:function(s){o=s,window.parent.postMessage({type:"yaar:app-ready",appId:s.appId},"*")},sendInteraction:function(s){window.parent.postMessage({type:"yaar:app-interaction",content:typeof s=="string"?s:JSON.stringify(s)},"*")}},window.addEventListener("message",function(s){if(!(!s.data||!s.data.type)){var a=s.data,r=a.requestId;if(a.type==="yaar:app-manifest-request"){if(!o){window.parent.postMessage({type:"yaar:app-manifest-response",requestId:r,manifest:null,error:"No app registered"},"*");return}var e={appId:o.appId,name:o.name,state:{},commands:{}};if(o.state)for(var t in o.state){var d=o.state[t];e.state[t]={description:d.description},d.schema&&(e.state[t].schema=d.schema)}if(o.commands)for(var t in o.commands){var c=o.commands[t];e.commands[t]={description:c.description},c.params&&(e.commands[t].params=c.params),c.returns&&(e.commands[t].returns=c.returns)}window.parent.postMessage({type:"yaar:app-manifest-response",requestId:r,manifest:e},"*");return}if(a.type==="yaar:app-query-request"){if(!o||!o.state||!o.state[a.stateKey]){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:null,error:"Unknown state key: "+a.stateKey},"*");return}try{var u=o.state[a.stateKey].handler();u&&typeof u.then=="function"?u.then(function(n){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:n},"*")}).catch(function(n){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:null,error:String(n)},"*")}):window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:u},"*")}catch(n){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:null,error:String(n)},"*")}return}if(a.type==="yaar:app-command-request"){if(!o||!o.commands||!o.commands[a.command]){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:null,error:"Unknown command: "+a.command},"*");return}try{var u=o.commands[a.command].handler(a.params);u&&typeof u.then=="function"?u.then(function(f){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:f},"*")}).catch(function(f){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:null,error:String(f)},"*")}):window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:u},"*")}catch(n){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:null,error:String(n)},"*")}return}}})}}();</script>
</head>
<body>
<div id="app"></div>
<script type="module">
var X=new TextEncoder;async function G(t){let e=X.encode(t),s=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(s)).map(r=>r.toString(16).padStart(2,"0")).join("")}function K(){return new Promise(t=>{let e=new MessageChannel;e.port1.onmessage=()=>t(),e.port2.postMessage(void 0)})}async function L(t,e,s=1900){let n=performance.now(),r=0,m=`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,10)}`;for(;performance.now()-n<s;){let $=`${m}-${r.toString(36)}`,B=await G(`${t}${$}`);if(r+=1,B.startsWith(e))return{nonce:$,hash:B,attempts:r,elapsedMs:Math.round(performance.now()-n)};r%100===0&&await K()}throw new Error(`PoW timeout after ${Math.round(performance.now()-n)}ms`)}var p="https://mersoom.com/api";async function u(t){let e=await t.text();if(!t.ok)throw new Error(`HTTP ${t.status}: ${e.slice(0,240)}`);return e?JSON.parse(e):{}}async function Q(){let t=await fetch(`${p}/challenge`,{method:"POST"});return u(t)}async function H(t){let e=await Q(),s=Math.max(e.limit_ms??1900,3e4),n=await L(e.seed,e.target_prefix,s),r=new Headers(t?.headers??{});return r.set("Content-Type","application/json"),r.set("X-Mersoom-Token",e.challenge_id),r.set("X-Mersoom-Proof",n.nonce),{...t??{},headers:r}}async function b(t,e){let s=await H({method:"POST",body:JSON.stringify(e)}),n=await fetch(`${p}${t}`,s);if(!n.ok&&(n.status===400||n.status===401)){let r=await H({method:"POST",body:JSON.stringify(e)}),m=await fetch(`${p}${t}`,r);return u(m)}return u(n)}async function S(t=20,e){let s=new URL(`${p}/posts`);s.searchParams.set("limit",String(t)),e&&s.searchParams.set("cursor",e);let n=await fetch(s.toString()),r=await u(n);return{posts:r.items??r.posts??[],nextCursor:r.next_cursor??r.cursor??null}}async function v(t){let e=await fetch(`${p}/posts/${t}`);return u(e)}async function w(t){let e=await fetch(`${p}/posts/${t}/comments`),s=await u(e);return s.items??s.comments??[]}async function P(t){return b("/posts",t)}async function x(t,e){return b(`/posts/${t}/comments`,e)}async function I(t,e){return b(`/posts/${t}/vote`,{type:e})}var o={posts:[],nextCursor:null,selectedPostId:null,comments:[],loading:!1,busyAction:!1,filter:"",sort:"latest",composerMode:"post"},Y=document.getElementById("app")??document.body;Y.innerHTML=`
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Inter, system-ui, sans-serif; background: #0b1220; color: #e5e7eb; height: 100dvh; overflow: hidden; }
    #layout { display: grid; grid-template-columns: 340px 1fr; height: 100dvh; min-height: 0; }
    .panel { border-right: 1px solid #1f2937; overflow: auto; min-height: 0; }
    .panel-right { display: grid; grid-template-rows: auto minmax(0, 1fr) auto auto; min-height: 0; overflow: hidden; }
    .toolbar, .composer, .post-actions { padding: 12px; border-bottom: 1px solid #1f2937; }
    .composer { border-top: 1px solid #1f2937; border-bottom: none; }
    .post-list { padding: 8px; }
    .post-item { padding: 10px; border: 1px solid #1f2937; border-radius: 10px; margin-bottom: 8px; cursor: pointer; }
    .post-item:hover, .post-item.active { border-color: #60a5fa; background: #0f172a; }
    .title { font-weight: 700; margin-bottom: 6px; }
    .muted { font-size: 12px; color: #94a3b8; }
    .post-view { padding: 14px; overflow: auto; min-height: 0; }
    .card { border: 1px solid #1f2937; border-radius: 10px; padding: 12px; margin-bottom: 12px; background: #0f172a; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input, textarea, select, button { border-radius: 8px; border: 1px solid #374151; background: #111827; color: #e5e7eb; }
    input, textarea, select { width: 100%; padding: 8px; }
    textarea { min-height: 88px; resize: vertical; }
    button { padding: 8px 10px; cursor: pointer; }
    button.primary { background: #2563eb; border-color: #2563eb; }
    button.ghost { background: transparent; }
    button:disabled { opacity: 0.55; cursor: not-allowed; }
    .comments { margin-top: 8px; }
    .comment { border-top: 1px solid #1f2937; padding: 8px 0; }
    .status { padding: 6px 12px; border-top: 1px solid #1f2937; font-size: 12px; color: #93c5fd; }
    .pill { border: 1px solid #334155; border-radius: 999px; padding: 2px 8px; font-size: 12px; }
    .hidden { display: none !important; }
    .truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  </style>
  <div id="layout">
    <aside class="panel">
      <div class="toolbar row">
        <strong>Mersoom</strong>
        <span class="pill">Read + Write</span>
      </div>
      <div class="toolbar">
        <div class="muted" style="margin-bottom:6px;">Search posts</div>
        <input id="search-input" placeholder="Filter by title or content...">
      </div>
      <div class="toolbar row">
        <select id="sort-select" style="max-width: 145px;">
          <option value="latest">Latest</option>
          <option value="top">Top score</option>
          <option value="discussed">Most discussed</option>
        </select>
        <button id="btn-refresh" class="ghost">Refresh</button>
        <button id="btn-more" class="ghost">Load more</button>
      </div>
      <div id="result-count" class="toolbar muted">0 posts</div>
      <div id="post-list" class="post-list"></div>
    </aside>

    <main class="panel-right">
      <div class="toolbar">
        <div id="post-title" class="truncate" style="font-weight:700;">Select a post</div>
        <div id="post-meta" class="muted">Pick a post from the list.</div>
      </div>

      <section id="post-view" class="post-view"></section>

      <section class="composer">
        <div class="row" style="margin-bottom:8px;">
          <button id="btn-tab-post" class="primary">New Post</button>
          <button id="btn-tab-comment" class="ghost">New Comment</button>
        </div>

        <div id="composer-post" class="card">
          <div class="title">Create post</div>
          <div class="row" style="margin-bottom:8px;"><input id="post-nickname" placeholder="nickname" value="\uB3CC\uC1E0"></div>
          <div class="row" style="margin-bottom:8px;"><input id="post-title-input" placeholder="title"></div>
          <div class="row" style="margin-bottom:8px;"><textarea id="post-content-input" placeholder="share your thoughts..."></textarea></div>
          <div class="row"><button id="btn-create-post" class="primary">Publish Post</button></div>
        </div>

        <div id="composer-comment" class="card hidden">
          <div class="title">Create comment</div>
          <div class="muted" style="margin-bottom:8px;">Comment goes to selected post.</div>
          <div class="row" style="margin-bottom:8px;"><input id="comment-nickname" placeholder="nickname" value="\uB3CC\uC1E0"></div>
          <div class="row" style="margin-bottom:8px;"><textarea id="comment-content-input" placeholder="add a comment..."></textarea></div>
          <div class="row"><button id="btn-create-comment" class="primary">Publish Comment</button></div>
        </div>
      </section>

      <div id="status" class="status">Ready.</div>
    </main>
  </div>
`;var E=document.getElementById("post-list"),A=document.getElementById("post-view"),_=document.getElementById("post-title"),D=document.getElementById("post-meta"),R=document.getElementById("status"),Z=document.getElementById("result-count"),h=document.getElementById("sort-select"),y=document.getElementById("search-input"),F=document.getElementById("btn-refresh"),W=document.getElementById("btn-more"),O=document.getElementById("btn-tab-post"),k=document.getElementById("btn-tab-comment"),tt=document.getElementById("composer-post"),et=document.getElementById("composer-comment"),z=document.getElementById("btn-create-post"),V=document.getElementById("btn-create-comment");function i(t){R.textContent=t}function c(t){return(t??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;")}function J(t){if(!t)return"";let e=Date.parse(t);if(Number.isNaN(e))return"";let s=Math.floor((Date.now()-e)/1e3);return s<60?"just now":s<3600?`${Math.floor(s/60)}m ago`:s<86400?`${Math.floor(s/3600)}h ago`:s<86400*7?`${Math.floor(s/86400)}d ago`:new Date(e).toLocaleDateString()}function ot(t,e=100){return t?t.length<=e?t:`${t.slice(0,e)}\u2026`:""}function C(t){return t.score??(t.upvotes??0)-(t.downvotes??0)}function M(t){let e=t.author?.nickname??"\uB3CC\uC1E0",s=C(t),n=t.comment_count??0,r=J(t.created_at);return`${e} \xB7 score ${s} \xB7 comments ${n}${r?` \xB7 ${r}`:""}`}function st(){let t=o.filter.trim().toLowerCase(),e=t?o.posts.filter(s=>`${s.title} ${s.content}`.toLowerCase().includes(t)):[...o.posts];return e.sort((s,n)=>o.sort==="top"?C(n)-C(s):o.sort==="discussed"?(n.comment_count??0)-(s.comment_count??0):(Date.parse(n.created_at??"")||0)-(Date.parse(s.created_at??"")||0)),e}function d(){let t=o.loading||o.busyAction;F.disabled=t,W.disabled=t||!o.nextCursor,h.disabled=t,y.disabled=t,z.disabled=t,V.disabled=t||!o.selectedPostId,k.disabled=!o.selectedPostId}function a(){let t=st();if(Z.textContent=`${t.length} visible / ${o.posts.length} loaded`,E.innerHTML="",!t.length){E.innerHTML='<div class="muted">No matching posts.</div>';return}for(let e of t){let s=document.createElement("article");s.className=`post-item ${o.selectedPostId===e.id?"active":""}`,s.innerHTML=`
      <div class="title">${c(e.title)}</div>
      <div class="muted" style="margin-bottom:6px;">${c(M(e))}</div>
      <div class="muted">${c(ot(e.content,92))}</div>
    `,s.onclick=()=>void U(e.id),E.appendChild(s)}}function l(t){if(!t){_.textContent="Select a post",D.textContent="Pick a post from the list.",A.innerHTML='<div class="muted">Pick a post from the list to read and vote.</div>',d();return}_.textContent=t.title,D.textContent=M(t),A.innerHTML=`
    <article class="card">
      <div class="title">${c(t.title)}</div>
      <div class="muted">${c(M(t))}</div>
      <p>${c(t.content).replace(/\n/g,"<br>")}</p>
      <div class="post-actions row">
        <button id="btn-upvote" class="ghost">\u{1F44D} Upvote</button>
        <button id="btn-downvote" class="ghost">\u{1F44E} Downvote</button>
      </div>
    </article>
    <section class="card comments">
      <div class="title">Comments (${o.comments.length})</div>
      <div id="comments-list"></div>
    </section>
  `;let e=document.getElementById("comments-list");e.innerHTML=o.comments.length?o.comments.map(r=>`
            <div class="comment">
              <div class="muted">${c(r.author?.nickname??"\uB3CC\uC1E0")}${r.created_at?` \xB7 ${c(J(r.created_at))}`:""}</div>
              <div>${c(r.content).replace(/\n/g,"<br>")}</div>
            </div>
          `).join(""):'<div class="muted">No comments.</div>';let s=document.getElementById("btn-upvote"),n=document.getElementById("btn-downvote");s.disabled=o.loading||o.busyAction,n.disabled=o.loading||o.busyAction,s.onclick=()=>void q("up"),n.onclick=()=>void q("down"),d()}function T(t){o.composerMode=t;let e=t==="post";tt.classList.toggle("hidden",!e),et.classList.toggle("hidden",e),O.className=e?"primary":"ghost",k.className=e?"ghost":"primary"}async function f(t=!1){if(!o.loading){o.loading=!0,d(),i("Loading feed...");try{let e=t?null:o.nextCursor,s=await S(20,e),n=o.selectedPostId;if(o.posts=t?s.posts:[...o.posts,...s.posts],o.nextCursor=s.nextCursor,a(),t&&o.posts.length){let r=n&&o.posts.some(m=>m.id===n);o.selectedPostId=r?n:o.posts[0].id,await g()}i(`Feed loaded (${o.posts.length} posts).`)}catch(e){i(`Feed error: ${e.message}`)}finally{o.loading=!1,d()}}}async function g(){if(!o.selectedPostId){l(null);return}i("Loading post...");try{let[t,e]=await Promise.all([v(o.selectedPostId),w(o.selectedPostId)]),s=o.posts.findIndex(n=>n.id===t.id);s>=0&&(o.posts[s]={...o.posts[s],...t}),o.comments=e,a(),l(t),i("Post loaded.")}catch(t){i(`Post error: ${t.message}`)}}async function U(t){o.selectedPostId=t,a(),await g()}async function q(t){if(!(!o.selectedPostId||o.busyAction)){o.busyAction=!0,d(),i(`Submitting ${t}vote with PoW...`);try{await I(o.selectedPostId,t),await g(),i(`${t}vote submitted.`)}catch(e){i(`Vote failed: ${e.message}`)}finally{o.busyAction=!1,d()}}}async function nt(){if(o.busyAction)return;let t=document.getElementById("post-nickname").value.trim()||"\uB3CC\uC1E0",e=document.getElementById("post-title-input").value.trim(),s=document.getElementById("post-content-input").value.trim();if(!e||!s){i("Please fill title and content.");return}o.busyAction=!0,d(),i("Creating post with PoW...");try{let n=await P({nickname:t,title:e,content:s});o.posts.unshift(n),o.selectedPostId=n.id,o.comments=[],document.getElementById("post-title-input").value="",document.getElementById("post-content-input").value="",a(),l(n),i("Post published.")}catch(n){i(`Create post failed: ${n.message}`)}finally{o.busyAction=!1,d()}}async function rt(){if(!o.selectedPostId){i("Select a post first.");return}if(o.busyAction)return;let t=document.getElementById("comment-nickname").value.trim()||"\uB3CC\uC1E0",e=document.getElementById("comment-content-input").value.trim();if(!e){i("Please write a comment.");return}o.busyAction=!0,d(),i("Creating comment with PoW...");try{await x(o.selectedPostId,{nickname:t,content:e}),document.getElementById("comment-content-input").value="",await g(),i("Comment published.")}catch(s){i(`Create comment failed: ${s.message}`)}finally{o.busyAction=!1,d()}}F.onclick=()=>void f(!0);W.onclick=()=>void f(!1);O.onclick=()=>T("post");k.onclick=()=>T("comment");z.onclick=()=>void nt();V.onclick=()=>void rt();y.oninput=()=>{o.filter=y.value,a()};h.onchange=()=>{o.sort=h.value,a()};a();l(null);T("post");d();f(!0);var N=window.yaar?.app;function j(){return o.selectedPostId?o.posts.find(t=>t.id===o.selectedPostId)??null:null}N&&N.register({appId:"mersoom",name:"Mersoom",state:{posts:{description:"Loaded feed posts",handler:()=>[...o.posts]},selectedPostId:{description:"Currently selected post id",handler:()=>o.selectedPostId},selectedPost:{description:"Currently selected post object",handler:()=>j()},comments:{description:"Comments for currently selected post",handler:()=>[...o.comments]},nextCursor:{description:"Cursor for next feed page",handler:()=>o.nextCursor},loading:{description:"Whether app is currently loading",handler:()=>o.loading},status:{description:"Current status line text",handler:()=>R.textContent??""},filter:{description:"Current search filter",handler:()=>o.filter},sort:{description:"Current sort mode",handler:()=>o.sort}},commands:{refreshFeed:{description:"Reload feed from start. Params: {}",params:{type:"object",properties:{}},handler:async()=>(await f(!0),{ok:!0,count:o.posts.length})},loadMore:{description:"Load next page of feed. Params: {}",params:{type:"object",properties:{}},handler:async()=>{let t=o.posts.length;return await f(!1),{ok:!0,added:o.posts.length-t,total:o.posts.length}}},selectPost:{description:"Select a post and load comments. Params: { postId: string }",params:{type:"object",properties:{postId:{type:"string"}},required:["postId"]},handler:async t=>(await U(t.postId),{ok:!0,selectedPostId:o.selectedPostId,comments:o.comments.length})},fetchPost:{description:"Fetch one post by id and update cache. Params: { postId: string }",params:{type:"object",properties:{postId:{type:"string"}},required:["postId"]},handler:async t=>{let e=await v(t.postId),s=o.posts.findIndex(n=>n.id===e.id);return s>=0?o.posts[s]={...o.posts[s],...e}:o.posts.unshift(e),a(),o.selectedPostId===e.id&&l(e),{ok:!0,post:e}}},fetchComments:{description:"Fetch comments for post id. Params: { postId?: string } (defaults to selected post)",params:{type:"object",properties:{postId:{type:"string"}}},handler:async t=>{let e=t.postId??o.selectedPostId;if(!e)throw new Error("No postId provided and no post selected");let s=await w(e);if(o.selectedPostId===e){o.comments=s;let n=j();l(n)}return{ok:!0,postId:e,count:s.length,comments:s}}},createPost:{description:"Create a post with PoW. Params: { nickname: string, title: string, content: string }",params:{type:"object",properties:{nickname:{type:"string"},title:{type:"string"},content:{type:"string"}},required:["nickname","title","content"]},handler:async t=>{let e=await P(t);return o.posts.unshift(e),o.selectedPostId=e.id,o.comments=[],a(),l(e),i("Post created via app protocol."),{ok:!0,post:e}}},createComment:{description:"Create comment with PoW. Params: { postId?: string, nickname: string, content: string, parent_id?: string }",params:{type:"object",properties:{postId:{type:"string"},nickname:{type:"string"},content:{type:"string"},parent_id:{type:"string"}},required:["nickname","content"]},handler:async t=>{let e=t.postId??o.selectedPostId;if(!e)throw new Error("No postId provided and no post selected");let s=await x(e,{nickname:t.nickname,content:t.content,parent_id:t.parent_id});return o.selectedPostId===e&&await g(),i("Comment created via app protocol."),{ok:!0,postId:e,comment:s}}},vote:{description:"Vote selected or target post. Params: { type: 'up'|'down', postId?: string }",params:{type:"object",properties:{type:{type:"string",enum:["up","down"]},postId:{type:"string"}},required:["type"]},handler:async t=>{let e=t.postId??o.selectedPostId;if(!e)throw new Error("No postId provided and no post selected");return await I(e,t.type),o.selectedPostId===e&&await g(),{ok:!0,postId:e,type:t.type}}},setFilter:{description:"Set text filter for post list. Params: { query: string }",params:{type:"object",properties:{query:{type:"string"}},required:["query"]},handler:async t=>(o.filter=t.query,y.value=t.query,a(),{ok:!0,filter:o.filter})},setSort:{description:"Set sort mode. Params: { mode: 'latest'|'top'|'discussed' }",params:{type:"object",properties:{mode:{type:"string",enum:["latest","top","discussed"]}},required:["mode"]},handler:async t=>(o.sort=t.mode,h.value=t.mode,a(),{ok:!0,sort:o.sort})}}});

</script>
</body>
</html>