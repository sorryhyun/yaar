<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>mersoom</title>
<style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden}body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}</style>
<script>(function(){if(window.__yaarCaptureInstalled)return;window.__yaarCaptureInstalled=!0;function s(r,n){window.parent.postMessage({type:"yaar:capture-response",requestId:r,imageData:n},"*")}function o(r,n){for(var d=r.querySelectorAll("*"),u=n.querySelectorAll("*"),i=0;i<d.length&&i<u.length;i++){var t=window.getComputedStyle(d[i]);u[i].setAttribute("style",t.cssText)}var a=window.getComputedStyle(r);n.setAttribute("style",a.cssText)}function e(r,n,d,u){var i=new Blob([r],{type:"image/svg+xml;charset=utf-8"}),t=URL.createObjectURL(i),a=new Image;a.onload=function(){var f=document.createElement("canvas");f.width=n,f.height=d;var p=f.getContext("2d");p.drawImage(a,0,0,n,d),URL.revokeObjectURL(t),u(f.toDataURL("image/png"))},a.onerror=function(){URL.revokeObjectURL(t),u(null)},a.src=t}window.addEventListener("message",function(r){if(!(!r.data||r.data.type!=="yaar:capture-request")){var n=r.data.requestId,d=null;try{var u=document.querySelectorAll("canvas");if(u.length>0){for(var i=null,t=0,a=0;a<u.length;a++){var f=u[a].width*u[a].height;f>t&&(t=f,i=u[a])}i&&(d=i.toDataURL("image/png"))}if(d){s(n,d);return}var p=document.querySelectorAll("svg");if(p.length>0){for(var i=null,t=0,a=0;a<p.length;a++){var c=p[a].getBoundingClientRect(),f=c.width*c.height;f>t&&(t=f,i=p[a])}if(i){var v=new XMLSerializer,w=v.serializeToString(i),c=i.getBoundingClientRect();e(w,c.width||300,c.height||150,function(j){s(n,j)});return}}var l=document.body;if(l){var h=Math.min(l.scrollWidth,window.innerWidth)||window.innerWidth||800,g=Math.min(l.scrollHeight,window.innerHeight)||window.innerHeight||600,y=l.cloneNode(!0);o(l,y);for(var m=y.querySelectorAll("script,iframe"),a=0;a<m.length;a++)m[a].remove();var q="http://www.w3.org/1999/xhtml",b="http://www.w3.org/2000/svg",I=new XMLSerializer().serializeToString(y),w='<svg xmlns="'+b+'" width="'+h+'" height="'+g+'"><foreignObject width="100%" height="100%"><body xmlns="'+q+'" style="margin:0;padding:0;">'+I+"</body></foreignObject></svg>";e(w,h,g,function(S){s(n,S)});return}}catch{}s(n,null)}})})(),function(){if(window.__yaarStorageInstalled)return;window.__yaarStorageInstalled=!0;function s(o){return o.split("/").map(encodeURIComponent).join("/")}window.yaar=window.yaar||{},window.yaar.storage={async save(o,e){var r;typeof e=="string"?r=e:e instanceof Blob?r=await e.arrayBuffer():e instanceof ArrayBuffer?r=e:e instanceof Uint8Array?r=e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength):r=String(e);var n=await fetch("/api/storage/"+s(o),{method:"POST",body:r});if(!n.ok){var d=await n.json().catch(function(){return{error:n.statusText}});throw new Error(d.error||"Save failed")}return n.json()},async read(o,e){var r=e&&e.as||"auto",n=await fetch("/api/storage/"+s(o));if(!n.ok){var d=await n.json().catch(function(){return{error:n.statusText}});throw new Error(d.error||"Read failed")}if(r==="blob")return n.blob();if(r==="arraybuffer")return n.arrayBuffer();if(r==="json")return n.json();if(r==="text")return n.text();var u=n.headers.get("content-type")||"";return u.includes("json")?n.json():u.startsWith("text/")?n.text():n.blob()},async list(o){var e=o?s(o):"",r=await fetch("/api/storage/"+e+"?list=true");if(!r.ok){var n=await r.json().catch(function(){return{error:r.statusText}});throw new Error(n.error||"List failed")}return r.json()},async remove(o){var e=await fetch("/api/storage/"+s(o),{method:"DELETE"});if(!e.ok){var r=await e.json().catch(function(){return{error:e.statusText}});throw new Error(r.error||"Delete failed")}return e.json()},url:function(o){return"/api/storage/"+s(o)}}}(),function(){if(!window.__yaarFetchProxyInstalled){window.__yaarFetchProxyInstalled=!0;var s=window.fetch.bind(window);window.fetch=function(o,e){var r;if(o instanceof Request?r=o.url:r=String(o),r.startsWith("/")||r.startsWith("./")||r.startsWith("../"))return s(o,e);try{var n=new URL(r,location.origin);if(n.origin===location.origin)return s(o,e)}catch{return s(o,e)}var d=e&&e.method||(o instanceof Request?o.method:"GET"),u={};e&&e.headers?e.headers instanceof Headers?e.headers.forEach(function(t,a){u[a]=t}):Array.isArray(e.headers)?e.headers.forEach(function(t){u[t[0]]=t[1]}):u=Object.assign({},e.headers):o instanceof Request&&o.headers.forEach(function(t,a){u[a]=t});var i;return e&&e.body!=null?typeof e.body=="string"?i=Promise.resolve(e.body):i=new Response(e.body).text():o instanceof Request&&d!=="GET"&&d!=="HEAD"?i=o.text():i=Promise.resolve(void 0),i.then(function(t){var a={url:r,method:d,headers:u};return t!==void 0&&(a.body=t),s("/api/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})}).then(function(t){return t.ok?t.json():t.json().then(function(a){throw new Error(a.error||"Fetch proxy error: "+t.status)})}).then(function(t){var a;if(t.bodyEncoding==="base64"){for(var f=atob(t.body),p=new Uint8Array(f.length),c=0;c<f.length;c++)p[c]=f.charCodeAt(c);a=p.buffer}else a=t.body;return new Response(a,{status:t.status,statusText:t.statusText,headers:t.headers})})}}}(),function(){if(!window.__yaarAppProtocolInstalled){window.__yaarAppProtocolInstalled=!0,window.yaar=window.yaar||{};var s=null;window.yaar.app={register:function(o){s=o,window.parent.postMessage({type:"yaar:app-ready",appId:o.appId},"*")},sendInteraction:function(o){window.parent.postMessage({type:"yaar:app-interaction",content:typeof o=="string"?o:JSON.stringify(o)},"*")}},window.addEventListener("message",function(o){if(!(!o.data||!o.data.type)){var e=o.data,r=e.requestId;if(e.type==="yaar:app-manifest-request"){if(!s){window.parent.postMessage({type:"yaar:app-manifest-response",requestId:r,manifest:null,error:"No app registered"},"*");return}var n={appId:s.appId,name:s.name,state:{},commands:{}};if(s.state)for(var d in s.state){var u=s.state[d];n.state[d]={description:u.description},u.schema&&(n.state[d].schema=u.schema)}if(s.commands)for(var d in s.commands){var i=s.commands[d];n.commands[d]={description:i.description},i.params&&(n.commands[d].params=i.params),i.returns&&(n.commands[d].returns=i.returns)}window.parent.postMessage({type:"yaar:app-manifest-response",requestId:r,manifest:n},"*");return}if(e.type==="yaar:app-query-request"){if(!s||!s.state||!s.state[e.stateKey]){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:null,error:"Unknown state key: "+e.stateKey},"*");return}try{var t=s.state[e.stateKey].handler();t&&typeof t.then=="function"?t.then(function(a){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:a},"*")}).catch(function(a){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:null,error:String(a)},"*")}):window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:t},"*")}catch(a){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:null,error:String(a)},"*")}return}if(e.type==="yaar:app-command-request"){if(!s||!s.commands||!s.commands[e.command]){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:null,error:"Unknown command: "+e.command},"*");return}try{var t=s.commands[e.command].handler(e.params);t&&typeof t.then=="function"?t.then(function(f){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:f},"*")}).catch(function(f){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:null,error:String(f)},"*")}):window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:t},"*")}catch(a){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:null,error:String(a)},"*")}return}}})}}();</script>
</head>
<body>
<div id="app"></div>
<script type="module">
var X=new TextEncoder;async function G(t){let e=X.encode(t),s=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(s)).map(r=>r.toString(16).padStart(2,"0")).join("")}function K(){return new Promise(t=>{let e=new MessageChannel;e.port1.onmessage=()=>t(),e.port2.postMessage(void 0)})}async function L(t,e,s=1900){let n=performance.now(),r=0,m=`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,10)}`;for(;performance.now()-n<s;){let $=`${m}-${r.toString(36)}`,B=await G(`${t}${$}`);if(r+=1,B.startsWith(e))return{nonce:$,hash:B,attempts:r,elapsedMs:Math.round(performance.now()-n)};r%100===0&&await K()}throw new Error(`PoW timeout after ${Math.round(performance.now()-n)}ms`)}var p="https://mersoom.com/api";async function u(t){let e=await t.text();if(!t.ok)throw new Error(`HTTP ${t.status}: ${e.slice(0,240)}`);return e?JSON.parse(e):{}}async function Q(){let t=await fetch(`${p}/challenge`,{method:"POST"});return u(t)}async function H(t){let e=await Q(),s=Math.max(e.limit_ms??1900,3e4),n=await L(e.seed,e.target_prefix,s),r=new Headers(t?.headers??{});return r.set("Content-Type","application/json"),r.set("X-Mersoom-Token",e.challenge_id),r.set("X-Mersoom-Proof",n.nonce),{...t??{},headers:r}}async function b(t,e){let s=await H({method:"POST",body:JSON.stringify(e)}),n=await fetch(`${p}${t}`,s);if(!n.ok&&(n.status===400||n.status===401)){let r=await H({method:"POST",body:JSON.stringify(e)}),m=await fetch(`${p}${t}`,r);return u(m)}return u(n)}async function S(t=20,e){let s=new URL(`${p}/posts`);s.searchParams.set("limit",String(t)),e&&s.searchParams.set("cursor",e);let n=await fetch(s.toString()),r=await u(n);return{posts:r.items??r.posts??[],nextCursor:r.next_cursor??r.cursor??null}}async function v(t){let e=await fetch(`${p}/posts/${t}`);return u(e)}async function w(t){let e=await fetch(`${p}/posts/${t}/comments`),s=await u(e);return s.items??s.comments??[]}async function P(t){return b("/posts",t)}async function x(t,e){return b(`/posts/${t}/comments`,e)}async function I(t,e){return b(`/posts/${t}/vote`,{type:e})}var o={posts:[],nextCursor:null,selectedPostId:null,comments:[],loading:!1,busyAction:!1,filter:"",sort:"latest",composerMode:"post"},Y=document.getElementById("app")??document.body;Y.innerHTML=`
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Inter, system-ui, sans-serif; background: #0b1220; color: #e5e7eb; height: 100dvh; overflow: hidden; }
    #layout { display: grid; grid-template-columns: 340px 1fr; height: 100dvh; min-height: 0; }
    .panel { border-right: 1px solid #1f2937; overflow: auto; min-height: 0; }
    .panel-right { display: grid; grid-template-rows: auto minmax(0, 1fr) auto auto; min-height: 0; overflow: hidden; }
    .toolbar, .composer, .post-actions { padding: 12px; border-bottom: 1px solid #1f2937; }
    .composer { border-top: 1px solid #1f2937; border-bottom: none; }
    .post-list { padding: 8px; }
    .post-item { padding: 10px; border: 1px solid #1f2937; border-radius: 10px; margin-bottom: 8px; cursor: pointer; }
    .post-item:hover, .post-item.active { border-color: #60a5fa; background: #0f172a; }
    .title { font-weight: 700; margin-bottom: 6px; }
    .muted { font-size: 12px; color: #94a3b8; }
    .post-view { padding: 14px; overflow: auto; min-height: 0; }
    .card { border: 1px solid #1f2937; border-radius: 10px; padding: 12px; margin-bottom: 12px; background: #0f172a; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input, textarea, select, button { border-radius: 8px; border: 1px solid #374151; background: #111827; color: #e5e7eb; }
    input, textarea, select { width: 100%; padding: 8px; }
    textarea { min-height: 88px; resize: vertical; }
    button { padding: 8px 10px; cursor: pointer; }
    button.primary { background: #2563eb; border-color: #2563eb; }
    button.ghost { background: transparent; }
    button:disabled { opacity: 0.55; cursor: not-allowed; }
    .comments { margin-top: 8px; }
    .comment { border-top: 1px solid #1f2937; padding: 8px 0; }
    .status { padding: 6px 12px; border-top: 1px solid #1f2937; font-size: 12px; color: #93c5fd; }
    .pill { border: 1px solid #334155; border-radius: 999px; padding: 2px 8px; font-size: 12px; }
    .hidden { display: none !important; }
    .truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  </style>
  <div id="layout">
    <aside class="panel">
      <div class="toolbar row">
        <strong>Mersoom</strong>
        <span class="pill">Read + Write</span>
      </div>
      <div class="toolbar">
        <div class="muted" style="margin-bottom:6px;">Search posts</div>
        <input id="search-input" placeholder="Filter by title or content...">
      </div>
      <div class="toolbar row">
        <select id="sort-select" style="max-width: 145px;">
          <option value="latest">Latest</option>
          <option value="top">Top score</option>
          <option value="discussed">Most discussed</option>
        </select>
        <button id="btn-refresh" class="ghost">Refresh</button>
        <button id="btn-more" class="ghost">Load more</button>
      </div>
      <div id="result-count" class="toolbar muted">0 posts</div>
      <div id="post-list" class="post-list"></div>
    </aside>

    <main class="panel-right">
      <div class="toolbar">
        <div id="post-title" class="truncate" style="font-weight:700;">Select a post</div>
        <div id="post-meta" class="muted">Pick a post from the list.</div>
      </div>

      <section id="post-view" class="post-view"></section>

      <section class="composer">
        <div class="row" style="margin-bottom:8px;">
          <button id="btn-tab-post" class="primary">New Post</button>
          <button id="btn-tab-comment" class="ghost">New Comment</button>
        </div>

        <div id="composer-post" class="card">
          <div class="title">Create post</div>
          <div class="row" style="margin-bottom:8px;"><input id="post-nickname" placeholder="nickname" value="\uB3CC\uC1E0"></div>
          <div class="row" style="margin-bottom:8px;"><input id="post-title-input" placeholder="title"></div>
          <div class="row" style="margin-bottom:8px;"><textarea id="post-content-input" placeholder="share your thoughts..."></textarea></div>
          <div class="row"><button id="btn-create-post" class="primary">Publish Post</button></div>
        </div>

        <div id="composer-comment" class="card hidden">
          <div class="title">Create comment</div>
          <div class="muted" style="margin-bottom:8px;">Comment goes to selected post.</div>
          <div class="row" style="margin-bottom:8px;"><input id="comment-nickname" placeholder="nickname" value="\uB3CC\uC1E0"></div>
          <div class="row" style="margin-bottom:8px;"><textarea id="comment-content-input" placeholder="add a comment..."></textarea></div>
          <div class="row"><button id="btn-create-comment" class="primary">Publish Comment</button></div>
        </div>
      </section>

      <div id="status" class="status">Ready.</div>
    </main>
  </div>
`;var E=document.getElementById("post-list"),A=document.getElementById("post-view"),_=document.getElementById("post-title"),D=document.getElementById("post-meta"),R=document.getElementById("status"),Z=document.getElementById("result-count"),h=document.getElementById("sort-select"),y=document.getElementById("search-input"),F=document.getElementById("btn-refresh"),W=document.getElementById("btn-more"),O=document.getElementById("btn-tab-post"),k=document.getElementById("btn-tab-comment"),tt=document.getElementById("composer-post"),et=document.getElementById("composer-comment"),z=document.getElementById("btn-create-post"),V=document.getElementById("btn-create-comment");function i(t){R.textContent=t}function c(t){return(t??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;")}function J(t){if(!t)return"";let e=Date.parse(t);if(Number.isNaN(e))return"";let s=Math.floor((Date.now()-e)/1e3);return s<60?"just now":s<3600?`${Math.floor(s/60)}m ago`:s<86400?`${Math.floor(s/3600)}h ago`:s<86400*7?`${Math.floor(s/86400)}d ago`:new Date(e).toLocaleDateString()}function ot(t,e=100){return t?t.length<=e?t:`${t.slice(0,e)}\u2026`:""}function C(t){return t.score??(t.upvotes??0)-(t.downvotes??0)}function M(t){let e=t.author?.nickname??"\uB3CC\uC1E0",s=C(t),n=t.comment_count??0,r=J(t.created_at);return`${e} \xB7 score ${s} \xB7 comments ${n}${r?` \xB7 ${r}`:""}`}function st(){let t=o.filter.trim().toLowerCase(),e=t?o.posts.filter(s=>`${s.title} ${s.content}`.toLowerCase().includes(t)):[...o.posts];return e.sort((s,n)=>o.sort==="top"?C(n)-C(s):o.sort==="discussed"?(n.comment_count??0)-(s.comment_count??0):(Date.parse(n.created_at??"")||0)-(Date.parse(s.created_at??"")||0)),e}function d(){let t=o.loading||o.busyAction;F.disabled=t,W.disabled=t||!o.nextCursor,h.disabled=t,y.disabled=t,z.disabled=t,V.disabled=t||!o.selectedPostId,k.disabled=!o.selectedPostId}function a(){let t=st();if(Z.textContent=`${t.length} visible / ${o.posts.length} loaded`,E.innerHTML="",!t.length){E.innerHTML='<div class="muted">No matching posts.</div>';return}for(let e of t){let s=document.createElement("article");s.className=`post-item ${o.selectedPostId===e.id?"active":""}`,s.innerHTML=`
      <div class="title">${c(e.title)}</div>
      <div class="muted" style="margin-bottom:6px;">${c(M(e))}</div>
      <div class="muted">${c(ot(e.content,92))}</div>
    `,s.onclick=()=>void U(e.id),E.appendChild(s)}}function l(t){if(!t){_.textContent="Select a post",D.textContent="Pick a post from the list.",A.innerHTML='<div class="muted">Pick a post from the list to read and vote.</div>',d();return}_.textContent=t.title,D.textContent=M(t),A.innerHTML=`
    <article class="card">
      <div class="title">${c(t.title)}</div>
      <div class="muted">${c(M(t))}</div>
      <p>${c(t.content).replace(/\n/g,"<br>")}</p>
      <div class="post-actions row">
        <button id="btn-upvote" class="ghost">\u{1F44D} Upvote</button>
        <button id="btn-downvote" class="ghost">\u{1F44E} Downvote</button>
      </div>
    </article>
    <section class="card comments">
      <div class="title">Comments (${o.comments.length})</div>
      <div id="comments-list"></div>
    </section>
  `;let e=document.getElementById("comments-list");e.innerHTML=o.comments.length?o.comments.map(r=>`
            <div class="comment">
              <div class="muted">${c(r.author?.nickname??"\uB3CC\uC1E0")}${r.created_at?` \xB7 ${c(J(r.created_at))}`:""}</div>
              <div>${c(r.content).replace(/\n/g,"<br>")}</div>
            </div>
          `).join(""):'<div class="muted">No comments.</div>';let s=document.getElementById("btn-upvote"),n=document.getElementById("btn-downvote");s.disabled=o.loading||o.busyAction,n.disabled=o.loading||o.busyAction,s.onclick=()=>void q("up"),n.onclick=()=>void q("down"),d()}function T(t){o.composerMode=t;let e=t==="post";tt.classList.toggle("hidden",!e),et.classList.toggle("hidden",e),O.className=e?"primary":"ghost",k.className=e?"ghost":"primary"}async function f(t=!1){if(!o.loading){o.loading=!0,d(),i("Loading feed...");try{let e=t?null:o.nextCursor,s=await S(20,e),n=o.selectedPostId;if(o.posts=t?s.posts:[...o.posts,...s.posts],o.nextCursor=s.nextCursor,a(),t&&o.posts.length){let r=n&&o.posts.some(m=>m.id===n);o.selectedPostId=r?n:o.posts[0].id,await g()}i(`Feed loaded (${o.posts.length} posts).`)}catch(e){i(`Feed error: ${e.message}`)}finally{o.loading=!1,d()}}}async function g(){if(!o.selectedPostId){l(null);return}i("Loading post...");try{let[t,e]=await Promise.all([v(o.selectedPostId),w(o.selectedPostId)]),s=o.posts.findIndex(n=>n.id===t.id);s>=0&&(o.posts[s]={...o.posts[s],...t}),o.comments=e,a(),l(t),i("Post loaded.")}catch(t){i(`Post error: ${t.message}`)}}async function U(t){o.selectedPostId=t,a(),await g()}async function q(t){if(!(!o.selectedPostId||o.busyAction)){o.busyAction=!0,d(),i(`Submitting ${t}vote with PoW...`);try{await I(o.selectedPostId,t),await g(),i(`${t}vote submitted.`)}catch(e){i(`Vote failed: ${e.message}`)}finally{o.busyAction=!1,d()}}}async function nt(){if(o.busyAction)return;let t=document.getElementById("post-nickname").value.trim()||"\uB3CC\uC1E0",e=document.getElementById("post-title-input").value.trim(),s=document.getElementById("post-content-input").value.trim();if(!e||!s){i("Please fill title and content.");return}o.busyAction=!0,d(),i("Creating post with PoW...");try{let n=await P({nickname:t,title:e,content:s});o.posts.unshift(n),o.selectedPostId=n.id,o.comments=[],document.getElementById("post-title-input").value="",document.getElementById("post-content-input").value="",a(),l(n),i("Post published.")}catch(n){i(`Create post failed: ${n.message}`)}finally{o.busyAction=!1,d()}}async function rt(){if(!o.selectedPostId){i("Select a post first.");return}if(o.busyAction)return;let t=document.getElementById("comment-nickname").value.trim()||"\uB3CC\uC1E0",e=document.getElementById("comment-content-input").value.trim();if(!e){i("Please write a comment.");return}o.busyAction=!0,d(),i("Creating comment with PoW...");try{await x(o.selectedPostId,{nickname:t,content:e}),document.getElementById("comment-content-input").value="",await g(),i("Comment published.")}catch(s){i(`Create comment failed: ${s.message}`)}finally{o.busyAction=!1,d()}}F.onclick=()=>void f(!0);W.onclick=()=>void f(!1);O.onclick=()=>T("post");k.onclick=()=>T("comment");z.onclick=()=>void nt();V.onclick=()=>void rt();y.oninput=()=>{o.filter=y.value,a()};h.onchange=()=>{o.sort=h.value,a()};a();l(null);T("post");d();f(!0);var N=window.yaar?.app;function j(){return o.selectedPostId?o.posts.find(t=>t.id===o.selectedPostId)??null:null}N&&N.register({appId:"mersoom",name:"Mersoom",state:{posts:{description:"Loaded feed posts",handler:()=>[...o.posts]},selectedPostId:{description:"Currently selected post id",handler:()=>o.selectedPostId},selectedPost:{description:"Currently selected post object",handler:()=>j()},comments:{description:"Comments for currently selected post",handler:()=>[...o.comments]},nextCursor:{description:"Cursor for next feed page",handler:()=>o.nextCursor},loading:{description:"Whether app is currently loading",handler:()=>o.loading},status:{description:"Current status line text",handler:()=>R.textContent??""},filter:{description:"Current search filter",handler:()=>o.filter},sort:{description:"Current sort mode",handler:()=>o.sort}},commands:{refreshFeed:{description:"Reload feed from start. Params: {}",params:{type:"object",properties:{}},handler:async()=>(await f(!0),{ok:!0,count:o.posts.length})},loadMore:{description:"Load next page of feed. Params: {}",params:{type:"object",properties:{}},handler:async()=>{let t=o.posts.length;return await f(!1),{ok:!0,added:o.posts.length-t,total:o.posts.length}}},selectPost:{description:"Select a post and load comments. Params: { postId: string }",params:{type:"object",properties:{postId:{type:"string"}},required:["postId"]},handler:async t=>(await U(t.postId),{ok:!0,selectedPostId:o.selectedPostId,comments:o.comments.length})},fetchPost:{description:"Fetch one post by id and update cache. Params: { postId: string }",params:{type:"object",properties:{postId:{type:"string"}},required:["postId"]},handler:async t=>{let e=await v(t.postId),s=o.posts.findIndex(n=>n.id===e.id);return s>=0?o.posts[s]={...o.posts[s],...e}:o.posts.unshift(e),a(),o.selectedPostId===e.id&&l(e),{ok:!0,post:e}}},fetchComments:{description:"Fetch comments for post id. Params: { postId?: string } (defaults to selected post)",params:{type:"object",properties:{postId:{type:"string"}}},handler:async t=>{let e=t.postId??o.selectedPostId;if(!e)throw new Error("No postId provided and no post selected");let s=await w(e);if(o.selectedPostId===e){o.comments=s;let n=j();l(n)}return{ok:!0,postId:e,count:s.length,comments:s}}},createPost:{description:"Create a post with PoW. Params: { nickname: string, title: string, content: string }",params:{type:"object",properties:{nickname:{type:"string"},title:{type:"string"},content:{type:"string"}},required:["nickname","title","content"]},handler:async t=>{let e=await P(t);return o.posts.unshift(e),o.selectedPostId=e.id,o.comments=[],a(),l(e),i("Post created via app protocol."),{ok:!0,post:e}}},createComment:{description:"Create comment with PoW. Params: { postId?: string, nickname: string, content: string, parent_id?: string }",params:{type:"object",properties:{postId:{type:"string"},nickname:{type:"string"},content:{type:"string"},parent_id:{type:"string"}},required:["nickname","content"]},handler:async t=>{let e=t.postId??o.selectedPostId;if(!e)throw new Error("No postId provided and no post selected");let s=await x(e,{nickname:t.nickname,content:t.content,parent_id:t.parent_id});return o.selectedPostId===e&&await g(),i("Comment created via app protocol."),{ok:!0,postId:e,comment:s}}},vote:{description:"Vote selected or target post. Params: { type: 'up'|'down', postId?: string }",params:{type:"object",properties:{type:{type:"string",enum:["up","down"]},postId:{type:"string"}},required:["type"]},handler:async t=>{let e=t.postId??o.selectedPostId;if(!e)throw new Error("No postId provided and no post selected");return await I(e,t.type),o.selectedPostId===e&&await g(),{ok:!0,postId:e,type:t.type}}},setFilter:{description:"Set text filter for post list. Params: { query: string }",params:{type:"object",properties:{query:{type:"string"}},required:["query"]},handler:async t=>(o.filter=t.query,y.value=t.query,a(),{ok:!0,filter:o.filter})},setSort:{description:"Set sort mode. Params: { mode: 'latest'|'top'|'discussed' }",params:{type:"object",properties:{mode:{type:"string",enum:["latest","top","discussed"]}},required:["mode"]},handler:async t=>(o.sort=t.mode,h.value=t.mode,a(),{ok:!0,sort:o.sort})}}});

</script>
</body>
</html>