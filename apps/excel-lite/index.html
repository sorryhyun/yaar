<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Excel Lite</title>
<style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden}body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}</style>
<script>(function(){if(window.__yaarCaptureInstalled)return;window.__yaarCaptureInstalled=true;function respond(requestId,imageData){window.parent.postMessage({type:"yaar:capture-response",requestId,imageData},"*")}function inlineStyles(original,clone){var origEls=original.querySelectorAll("*");var cloneEls=clone.querySelectorAll("*");for(var i=0;i<origEls.length&&i<cloneEls.length;i++){var cs=window.getComputedStyle(origEls[i]);cloneEls[i].setAttribute("style",cs.cssText)}var rootCs=window.getComputedStyle(original);clone.setAttribute("style",rootCs.cssText)}function svgToCanvas(svgStr,w,h,cb){var blob=new Blob([svgStr],{type:"image/svg+xml;charset=utf-8"});var url=URL.createObjectURL(blob);var img=new Image;img.onload=function(){var c=document.createElement("canvas");c.width=w;c.height=h;var ctx=c.getContext("2d");ctx.drawImage(img,0,0,w,h);URL.revokeObjectURL(url);cb(c.toDataURL("image/png"))};img.onerror=function(){URL.revokeObjectURL(url);cb(null)};img.src=url}window.addEventListener("message",function(e){if(!e.data||e.data.type!=="yaar:capture-request")return;var requestId=e.data.requestId;var imageData=null;try{var canvases=document.querySelectorAll("canvas");if(canvases.length>0){var largest=null;var largestArea=0;for(var i=0;i<canvases.length;i++){var area=canvases[i].width*canvases[i].height;if(area>largestArea){largestArea=area;largest=canvases[i]}}if(largest){imageData=largest.toDataURL("image/png")}}if(imageData){respond(requestId,imageData);return}var svgs=document.querySelectorAll("svg");if(svgs.length>0){var largest=null;var largestArea=0;for(var i=0;i<svgs.length;i++){var rect=svgs[i].getBoundingClientRect();var area=rect.width*rect.height;if(area>largestArea){largestArea=area;largest=svgs[i]}}if(largest){var serializer=new XMLSerializer;var svgStr=serializer.serializeToString(largest);var rect=largest.getBoundingClientRect();svgToCanvas(svgStr,rect.width||300,rect.height||150,function(data){respond(requestId,data)});return}}var body=document.body;if(body){var w=Math.min(body.scrollWidth,window.innerWidth)||window.innerWidth||800;var h=Math.min(body.scrollHeight,window.innerHeight)||window.innerHeight||600;var clone=body.cloneNode(true);inlineStyles(body,clone);var remove=clone.querySelectorAll("script,iframe");for(var i=0;i<remove.length;i++)remove[i].remove();var xmlns="http://www.w3.org/1999/xhtml";var svgNS="http://www.w3.org/2000/svg";var xhtml=new XMLSerializer().serializeToString(clone);var svgStr='<svg xmlns="'+svgNS+'" width="'+w+'" height="'+h+'">'+'<foreignObject width="100%" height="100%">'+'<body xmlns="'+xmlns+'" style="margin:0;padding:0;">'+xhtml+"</body></foreignObject></svg>";svgToCanvas(svgStr,w,h,function(data){respond(requestId,data)});return}}catch(ex){}respond(requestId,null)})})();(function(){if(window.__yaarStorageInstalled)return;window.__yaarStorageInstalled=true;function encodePath(p){return p.split("/").map(encodeURIComponent).join("/")}window.yaar=window.yaar||{};window.yaar.storage={async save(path,data){var body;if(typeof data==="string"){body=data}else if(data instanceof Blob){body=await data.arrayBuffer()}else if(data instanceof ArrayBuffer){body=data}else if(data instanceof Uint8Array){body=data.buffer.slice(data.byteOffset,data.byteOffset+data.byteLength)}else{body=String(data)}var res=await fetch("/api/storage/"+encodePath(path),{method:"POST",body});if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Save failed")}return res.json()},async read(path,options){var mode=options&&options.as||"auto";var res=await fetch("/api/storage/"+encodePath(path));if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Read failed")}if(mode==="blob")return res.blob();if(mode==="arraybuffer")return res.arrayBuffer();if(mode==="json")return res.json();if(mode==="text")return res.text();var ct=res.headers.get("content-type")||"";if(ct.includes("json"))return res.json();if(ct.startsWith("text/"))return res.text();return res.blob()},async list(dirPath){var p=dirPath?encodePath(dirPath):"";var res=await fetch("/api/storage/"+p+"?list=true");if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"List failed")}return res.json()},async remove(path){var res=await fetch("/api/storage/"+encodePath(path),{method:"DELETE"});if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Delete failed")}return res.json()},url:function(path){return"/api/storage/"+encodePath(path)}}})();(function(){if(window.__yaarFetchProxyInstalled)return;window.__yaarFetchProxyInstalled=true;var realFetch=window.fetch.bind(window);var sessionId="";try{var sp=new URLSearchParams(location.search);var raw=sp.get("sessionId")||"";if(/^[a-zA-Z0-9_-]+$/.test(raw))sessionId=raw}catch(e){}window.fetch=function(input,init){var url;if(input instanceof Request){url=input.url}else{url=String(input)}if(url.startsWith("/")||url.startsWith("./")||url.startsWith("../")){return realFetch(input,init)}try{var parsed=new URL(url,location.origin);if(parsed.origin===location.origin){return realFetch(input,init)}}catch(e){return realFetch(input,init)}var method=init&&init.method||(input instanceof Request?input.method:"GET");var headers={};if(init&&init.headers){if(init.headers instanceof Headers){init.headers.forEach(function(v,k){headers[k]=v})}else if(Array.isArray(init.headers)){init.headers.forEach(function(pair){headers[pair[0]]=pair[1]})}else{headers=Object.assign({},init.headers)}}else if(input instanceof Request){input.headers.forEach(function(v,k){headers[k]=v})}var bodyPromise;if(init&&init.body!=null){if(typeof init.body==="string"){bodyPromise=Promise.resolve(init.body)}else{bodyPromise=new Response(init.body).text()}}else if(input instanceof Request&&method!=="GET"&&method!=="HEAD"){bodyPromise=input.text()}else{bodyPromise=Promise.resolve(undefined)}return bodyPromise.then(function(bodyStr){var payload={url,method,headers};if(bodyStr!==undefined)payload.body=bodyStr;if(sessionId)payload.sessionId=sessionId;return realFetch("/api/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)})}).then(function(proxyRes){if(!proxyRes.ok){return proxyRes.json().then(function(err){throw new Error(err.error||"Fetch proxy error: "+proxyRes.status)})}return proxyRes.json()}).then(function(data){var body;if(data.bodyEncoding==="base64"){var bin=atob(data.body);var bytes=new Uint8Array(bin.length);for(var i=0;i<bin.length;i++)bytes[i]=bin.charCodeAt(i);body=bytes.buffer}else{body=data.body}return new Response(body,{status:data.status,statusText:data.statusText,headers:data.headers})})}})();(function(){if(window.__yaarAppProtocolInstalled)return;window.__yaarAppProtocolInstalled=true;window.yaar=window.yaar||{};var registration=null;window.yaar.app={register:function(config){registration=config;window.parent.postMessage({type:"yaar:app-ready",appId:config.appId},"*")},sendInteraction:function(description){window.parent.postMessage({type:"yaar:app-interaction",content:typeof description==="string"?description:JSON.stringify(description)},"*")}};window.addEventListener("message",function(e){if(!e.data||!e.data.type)return;var msg=e.data;var requestId=msg.requestId;if(msg.type==="yaar:app-manifest-request"){if(!registration){window.parent.postMessage({type:"yaar:app-manifest-response",requestId,manifest:null,error:"No app registered"},"*");return}var manifest={appId:registration.appId,name:registration.name,state:{},commands:{}};if(registration.state){for(var key in registration.state){var s=registration.state[key];manifest.state[key]={description:s.description};if(s.schema)manifest.state[key].schema=s.schema}}if(registration.commands){for(var key in registration.commands){var c=registration.commands[key];manifest.commands[key]={description:c.description};if(c.params)manifest.commands[key].params=c.params;if(c.returns)manifest.commands[key].returns=c.returns}}window.parent.postMessage({type:"yaar:app-manifest-response",requestId,manifest},"*");return}if(msg.type==="yaar:app-query-request"){if(!registration||!registration.state||!registration.state[msg.stateKey]){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:"Unknown state key: "+msg.stateKey},"*");return}try{var result=registration.state[msg.stateKey].handler();if(result&&typeof result.then==="function"){result.then(function(data){window.parent.postMessage({type:"yaar:app-query-response",requestId,data},"*")}).catch(function(err){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:String(err)},"*")})}else{window.parent.postMessage({type:"yaar:app-query-response",requestId,data:result},"*")}}catch(err){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:String(err)},"*")}return}if(msg.type==="yaar:app-command-request"){if(!registration||!registration.commands||!registration.commands[msg.command]){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:"Unknown command: "+msg.command},"*");return}try{var result=registration.commands[msg.command].handler(msg.params);if(result&&typeof result.then==="function"){result.then(function(data){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:data},"*")}).catch(function(err){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:String(err)},"*")})}else{window.parent.postMessage({type:"yaar:app-command-response",requestId,result},"*")}}catch(err){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:String(err)},"*")}return}})})();</script>
</head>
<body>
<div id="app"></div>
<script type="module">
function v(n){let N="",M=n;while(M>0){let b=(M-1)%26;N=String.fromCharCode(65+b)+N,M=Math.floor((M-1)/26)}return N}function s(n){let N=0;for(let M of n)N=N*26+(M.charCodeAt(0)-64);return N}function D(n,N){return`${v(n)}${N}`}function z(n){let N=n.toUpperCase().match(/^([A-Z]+)(\d+)$/);if(!N)return null;return{c:s(N[1]),r:Number(N[2])}}function B(n,N){let M=z(n),b=z(N);return{c1:Math.min(M.c,b.c),c2:Math.max(M.c,b.c),r1:Math.min(M.r,b.r),r2:Math.max(M.r,b.r)}}function K(n){let N=[];for(let M=n.r1;M<=n.r2;M++)for(let b=n.c1;b<=n.c2;b++)N.push(D(b,M));return N}function Y1(n,N){let M=z(n),b=z(N);if(!M||!b)return[];let j=[],U=Math.min(M.c,b.c),O=Math.max(M.c,b.c),m=Math.min(M.r,b.r),Z=Math.max(M.r,b.r);for(let $=m;$<=Z;$++)for(let _=U;_<=O;_++)j.push(D(_,$));return j}function Q1(n,N,M){let b=[];for(let j of n){if(!z(j))continue;let O=M(j).trim(),m=(N[j]??"").trim(),$=Number(O||m);if(!Number.isFinite($))continue;b.push({label:j,value:$})}return b}var e=60,u=20,G={bold:!1,italic:!1,underline:!1,fontSize:14,color:"#111827",bg:"#ffffff",align:"left"};function H(n){return JSON.parse(JSON.stringify(n))}function X1(n){if(/[\",\n]/.test(n))return`"${n.replace(/"/g,'""')}"`;return n}function n1(n,N){let M=z(N);if(!M)return null;let b=M.r<n.r1,j=M.r>n.r2,U=M.c<n.c1,O=M.c>n.c2;if(!b&&!j&&!U&&!O)return null;let m=b?n.r1-M.r:j?M.r-n.r2:0,Z=U?n.c1-M.c:O?M.c-n.c2:0;if((b||j)&&m>=Z)return b?{c1:n.c1,c2:n.c2,r1:M.r,r2:n.r1-1}:{c1:n.c1,c2:n.c2,r1:n.r2+1,r2:M.r};return U?{c1:M.c,c2:n.c1-1,r1:n.r1,r2:n.r2}:{c1:n.c2+1,c2:M.c,r1:n.r1,r2:n.r2}}function V1(n,N){let M=z(N),b=n.r2-n.r1+1,j=n.c2-n.c1+1,U=n.r1,O=n.c1;if(M.r>n.r2)U=n.r1+(M.r-n.r1)%b;else if(M.r<n.r1)U=n.r2-(n.r1-M.r-1)%b;else U=M.r;if(M.c>n.c2)O=n.c1+(M.c-n.c1)%j;else if(M.c<n.c1)O=n.c2-(n.c1-M.c-1)%j;else O=M.c;return D(O,U)}function z1(n){function N(j,U=new Set){if(U.has(j))return NaN;U.add(j);let O=n(j).trim();if(!O)return 0;if(!O.startsWith("=")){let m=Number(O);return Number.isFinite(m)?m:NaN}return M(O.slice(1),U)}function M(j,U){try{let O=j.toUpperCase();if(O=O.replace(/SUM\(\s*([A-Z]+\d+)\s*:\s*([A-Z]+\d+)\s*\)/g,(Z,$,_)=>{return String(Y1($,_).reduce((q,J)=>{let V=N(J,new Set(U));return q+(Number.isFinite(V)?V:0)},0))}),O=O.replace(/\b([A-Z]+\d+)\b/g,(Z,$)=>{let _=N($,new Set(U));return Number.isFinite(_)?String(_):"NaN"}),!/^[0-9+\-*/().\sNAN]+$/.test(O))return NaN;let m=Function(`"use strict"; return (${O});`)();return Number.isFinite(m)?m:NaN}catch{return NaN}}function b(j){let U=n(j);if(!U.startsWith("="))return U;let O=N(j);return Number.isFinite(O)?String(O):"#ERR"}return{evalCell:N,display:b}}function D1(n,N,M){if(!n.startsWith("="))return n;return n.replace(/\b([A-Z]+)(\d+)\b/g,(b,j,U)=>{let O=Math.max(1,s(j)+M),m=Math.max(1,Number(U)+N);return`${v(O)}${m}`})}function F1(n,N,M,b,j=100){if(n.push({cells:H(M),styles:H(b)}),n.length>j)n.shift();N.length=0}function N1(n,N,M){for(let b of Object.keys(N))delete N[b];for(let[b,j]of Object.entries(n.cells))N[b]=j;for(let b of Object.keys(M))delete M[b];for(let[b,j]of Object.entries(n.styles))M[b]=j}function E(n,N){let M=n[N]??{};return{bold:M.bold??G.bold,italic:M.italic??G.italic,underline:M.underline??G.underline,fontSize:M.fontSize??G.fontSize,color:M.color??G.color,bg:M.bg??G.bg,align:M.align??G.align}}function o(n){let N={};if((n.bold??G.bold)!==G.bold)N.bold=!!n.bold;if((n.italic??G.italic)!==G.italic)N.italic=!!n.italic;if((n.underline??G.underline)!==G.underline)N.underline=!!n.underline;if((n.fontSize??G.fontSize)!==G.fontSize)N.fontSize=n.fontSize;if((n.color??G.color)!==G.color)N.color=n.color;if((n.bg??G.bg)!==G.bg)N.bg=n.bg;if((n.align??G.align)!==G.align)N.align=n.align;return Object.keys(N).length?N:null}function P1(n){let N={};for(let[j,U]of Object.entries(n)){let O=j.toUpperCase();if(!z(O))continue;N[O]=String(U??"")}let b=JSON.stringify({cells:N,format:"excel-lite-json-v1"});return new TextEncoder().encode(b)}function x1(n){try{let N=n instanceof Uint8Array?n:new Uint8Array(n),M=new TextDecoder().decode(N),b=JSON.parse(M),j=b&&b.cells&&typeof b.cells==="object"?b.cells:{},U={};for(let[O,m]of Object.entries(j)){let Z=O.toUpperCase();if(!z(Z))continue;U[Z]=String(m??"")}return{cells:U}}catch{return{cells:{}}}}class C1{static register(...n){}canvas;cfg;constructor(n,N){this.canvas=n,this.cfg=N,this.render()}destroy(){let n=this.canvas.getContext("2d");if(n)n.clearRect(0,0,this.canvas.width,this.canvas.height)}render(){let n=this.canvas.getContext("2d");if(!n)return;let N=this.canvas.width,M=this.canvas.height;n.clearRect(0,0,N,M);let b=this.cfg.data.datasets[0]?.data??[];if(!b.length)return;let j=Math.max(...b,1);if(this.cfg.type==="pie"){let _=-Math.PI/2,q=b.reduce((J,V)=>J+V,0)||1;b.forEach((J,V)=>{let W=_+J/q*Math.PI*2,p1=V*57%360;n.fillStyle=`hsl(${p1} 75% 55%)`,n.beginPath(),n.moveTo(N/2,M/2),n.arc(N/2,M/2,Math.min(N,M)*0.38,_,W),n.closePath(),n.fill(),_=W});return}let U=b.length,O=24,m=N-O*2,Z=M-O*2;if(n.strokeStyle="#9aa7bd",n.beginPath(),n.moveTo(O,M-O),n.lineTo(N-O,M-O),n.stroke(),this.cfg.type==="line"){n.strokeStyle="#2a6df6",n.lineWidth=2,n.beginPath(),b.forEach((_,q)=>{let J=O+q/Math.max(1,U-1)*m,V=M-O-_/j*Z;if(q===0)n.moveTo(J,V);else n.lineTo(J,V)}),n.stroke();return}let $=m/U;b.forEach((_,q)=>{let J=O+q*$+3,V=_/j*Z,W=M-O-V;n.fillStyle="rgba(42,109,246,0.6)",n.fillRect(J,W,Math.max(2,$-6),V)})}}var u1=[];function o1(n,N){if(N!=="HH:mm:ss")return n.toISOString();let M=(b)=>String(b).padStart(2,"0");return`${M(n.getHours())}:${M(n.getMinutes())}:${M(n.getSeconds())}`}var R={format:(n)=>(N)=>Number.isFinite(N)?N.toLocaleString(void 0,{maximumFractionDigits:4}):"0",sum:(n)=>n.reduce((N,M)=>N+M,0),mean:(n)=>n.length?n.reduce((N,M)=>N+M,0)/n.length:void 0,median:(n)=>{if(!n.length)return;let N=[...n].sort((b,j)=>b-j),M=Math.floor(N.length/2);return N.length%2?N[M]:(N[M-1]+N[M])/2},min:(n)=>n.length?Math.min(...n):void 0,max:(n)=>n.length?Math.max(...n):void 0};function d1(n,N=300){let M=null;return(...b)=>{if(M)clearTimeout(M);M=window.setTimeout(()=>n(...b),N)}}var H1=document.createElement("div");H1.innerHTML=`
  <style>
    :root { color-scheme: light; }
    body { margin: 0; font-family: Inter, Arial, sans-serif; background: #f3f6fc; user-select: none; color: #111827; }
    .wrap { padding: 10px; display: grid; gap: 8px; }
    .toolbar {
      display: grid;
      gap: 8px;
      padding: 10px;
      border: 1px solid #d8e1ef;
      border-radius: 12px;
      background: linear-gradient(180deg, #ffffff, #f8fbff);
      box-shadow: 0 6px 18px rgba(42, 109, 246, 0.08);
      position: sticky;
      top: 8px;
      z-index: 10;
    }
    .toolbar-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: nowrap;
      min-width: 0;
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 2px;
    }
    .toolbar-row.file #storagePathInput { flex: 1 1 280px; min-width: 240px; }
    .toolbar-row.edit #formulaInput { flex: 1 1 360px; min-width: 260px; }
    .toolbar-row.edit .name { flex: 0 0 auto; }
    .name {
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-weight: 700;
      min-width: 78px;
      text-align: center;
      border: 1px solid #cfd8e6;
      border-radius: 8px;
      padding: 7px 8px;
      background: #f7faff;
    }
    input, select {
      height: 34px;
      padding: 6px 9px;
      border: 1px solid #ccd6e4;
      border-radius: 8px;
      font-size: 13px;
      background: white;
      box-sizing: border-box;
    }
    #formulaInput { width: 100%; }
    #storagePathInput { min-width: 260px; }
    #textColor, #bgColor { width: 42px; padding: 2px; }
    button {
      height: 34px;
      min-width: 34px;
      padding: 6px 10px;
      border: 1px solid #c8d3e3;
      border-radius: 9px;
      background: linear-gradient(180deg, #ffffff, #f7f9fd);
      cursor: pointer;
      transition: all 120ms ease;
      font-weight: 600;
      color: #1f2937;
    }
    button:hover { background: #edf3ff; border-color: #aec2e6; transform: translateY(-1px); }
    button.active { background: #dce8ff; border-color: #89abf0; }
    .sheetWrap { overflow: auto; border: 1px solid #d8e1ef; border-radius: 10px; background: white; max-height: calc(100vh - 160px); }
    .chartPanel {
      border: 1px solid #d8e1ef;
      border-radius: 10px;
      background: #ffffff;
      padding: 8px;
      display: none;
      min-height: 220px;
      box-shadow: inset 0 0 0 1px #eef3ff;
    }
    .chartPanel.open { display: block; }
    .chartPanelHead {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      color: #1e293b;
      font-size: 13px;
    }
    #chartCanvas { width: 100%; max-height: 220px; }
    .statsPanel {
      border: 1px solid #d8e1ef;
      border-radius: 10px;
      background: #ffffff;
      padding: 10px;
      display: none;
    }
    .statsPanel.open { display: block; }
    .statsGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
    }
    .statCard {
      border: 1px solid #e5ecf8;
      border-radius: 8px;
      background: #f8fbff;
      padding: 8px;
    }
    .statLabel { font-size: 11px; color: #64748b; }
    .statValue { font-size: 14px; font-weight: 700; color: #0f172a; margin-top: 2px; }
    table { border-collapse: collapse; min-width: 1250px; table-layout: fixed; }
    th, td { border: 1px solid #e7ecf5; }
    th { position: sticky; top: 0; background: #f8faff; z-index: 2; font-weight: 600; }
    .rowHead { position: sticky; left: 0; background: #f8faff; z-index: 1; text-align: right; padding: 6px 8px; min-width: 46px; }
    .corner { position: sticky; left: 0; top: 0; z-index: 3; background: #eef3ff; min-width: 46px; }
    td { position: relative; min-width: 98px; }
    td input { width: 100%; border: none; padding: 7px 8px; box-sizing: border-box; outline: none; background: transparent; }
    td.selected { background: #dce8ff; box-shadow: inset 0 0 0 1px #93b4f4; }
    td.active { box-shadow: inset 0 0 0 2px #2a6df6; z-index: 1; }
    .fill-handle { position: absolute; width: 8px; height: 8px; right: -4px; bottom: -4px; border-radius: 1px; background: #2a6df6; cursor: crosshair; z-index: 5; }
    td.fill-preview { background: #c7dcff; box-shadow: inset 0 0 0 1px #79a3ff; }
    .hint { color: #5c6475; font-size: 12px; display: none; }
    .io-status {
      position: fixed;
      right: 18px;
      bottom: 14px;
      z-index: 30;
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 8px;
      border: 1px solid #d8e1ef;
      background: rgba(255, 255, 255, 0.95);
      color: #374151;
      box-shadow: 0 6px 20px rgba(16, 24, 40, 0.12);
      display: none;
    }
    @media (max-width: 1200px) {
      #formulaInput, #storagePathInput { min-width: 220px; }
    }
  </style>
  <div class="wrap">
    <div class="toolbar">
      <div class="toolbar-row file">
        <button id="saveFileBtn" title="Save workbook XLSX to YAAR storage" aria-label="Save File">\uD83D\uDCBE</button>
        <button id="openFileBtn" title="Open workbook from YAAR storage (XLSX/JSON)" aria-label="Open File">\uD83D\uDCC2</button>
        <button id="saveBtn" title="Copy sheet JSON to clipboard" aria-label="Copy JSON">⎘</button>
        <button id="loadBtn" title="Paste sheet JSON from a dialog" aria-label="Paste JSON">\uD83D\uDCCB</button>
        <button id="csvBtn" title="Export CSV" aria-label="Export CSV">⬇</button>
        <button id="chartBtn" title="Create chart from selection" aria-label="Chart Selection">\uD83D\uDCCA</button>
        <button id="statsBtn" title="Selection statistics" aria-label="Selection Statistics">Σ</button>
        <select id="chartTypeSel" title="Chart type">
          <option value="bar" selected>Bar</option>
          <option value="line">Line</option>
          <option value="pie">Pie</option>
        </select>
        <input id="storagePathInput" title="Storage path" value="excel-lite/sheet.xlsx" />
      </div>
      <div class="toolbar-row edit">
        <button id="undoBtn" title="Undo" aria-label="Undo">↶</button>
        <button id="redoBtn" title="Redo" aria-label="Redo">↷</button>
        <div class="name" id="cellName">A1</div>
        <input id="formulaInput" placeholder="Value or formula (=A1+B1, =SUM(A1:A10))" />
        <button id="boldBtn"><b>B</b></button>
        <button id="italicBtn"><i>I</i></button>
        <button id="underlineBtn"><u>U</u></button>
        <select id="fontSizeSel" title="Font size">
          <option value="12">12</option><option value="14" selected>14</option><option value="16">16</option><option value="18">18</option><option value="20">20</option><option value="24">24</option>
        </select>
        <input id="textColor" type="color" value="#111827" title="Text color" />
        <input id="bgColor" type="color" value="#ffffff" title="Cell background" />
        <select id="alignSel" title="Alignment"><option value="left">Left</option><option value="center">Center</option><option value="right">Right</option></select>
      </div>
    </div>
    <div class="hint io-status" id="ioStatus" aria-live="polite">Storage ready.</div>
    <div class="chartPanel" id="chartPanel">
      <div class="chartPanelHead">
        <strong id="chartTitle">Selection Chart</strong>
        <button id="closeChartBtn" title="Close chart">✕</button>
      </div>
      <canvas id="chartCanvas" height="180"></canvas>
    </div>
    <div class="statsPanel" id="statsPanel"></div>
    <div class="sheetWrap" id="sheet"></div>
  </div>
`;document.body.appendChild(H1);var R1=document.getElementById("sheet"),r=document.getElementById("formulaInput"),r1=document.getElementById("cellName"),k1=document.getElementById("boldBtn"),A1=document.getElementById("italicBtn"),T1=document.getElementById("underlineBtn"),b1=document.getElementById("fontSizeSel"),j1=document.getElementById("textColor"),O1=document.getElementById("bgColor"),U1=document.getElementById("alignSel"),a1=document.getElementById("undoBtn"),t1=document.getElementById("redoBtn"),l1=document.getElementById("saveBtn"),s1=document.getElementById("loadBtn"),w1=document.getElementById("storagePathInput"),e1=document.getElementById("saveFileBtn"),nn=document.getElementById("openFileBtn"),Nn=document.getElementById("csvBtn"),Mn=document.getElementById("chartBtn"),bn=document.getElementById("statsBtn"),E1=document.getElementById("chartTypeSel"),Z1=document.getElementById("chartPanel"),K1=document.getElementById("statsPanel"),jn=document.getElementById("chartCanvas"),On=document.getElementById("chartTitle"),Un=document.getElementById("closeChartBtn"),h=document.getElementById("ioStatus"),C={},Y={},f=new Map,i=new Map,_1=document.createElement("div");_1.className="fill-handle";var F="A1",Q="A1",X="A1",a=null,d=!1,c=!1,L=null,T=null,J1=[],L1=[];function g(n){return C[n]??""}var l=z1(g);C1.register(...u1);var w=window.yaar?.storage,M1,t=null;function P(n,N=!1){if(h.textContent=`[${o1(new Date,"HH:mm:ss")}] ${n}`,h.style.display="block",h.style.color=N?"#b42318":"#374151",h.style.borderColor=N?"#f6b5ad":"#d8e1ef",M1)window.clearTimeout(M1);M1=window.setTimeout(()=>{h.style.display="none"},N?4200:2400)}function f1(){let n=w1.value.trim()||"excel-lite/sheet.xlsx";return w1.value=n,n}var $1="excel-lite/autosave.json",$n=d1(async()=>{if(!w)return;try{await w.save($1,S1())}catch{}},1400);function k(){$n()}function A(){F1(J1,L1,C,Y)}function I1(){let n=J1.pop();if(!n)return;L1.push({cells:H(C),styles:H(Y)}),N1(n,C,Y),x()}function m1(){let n=L1.pop();if(!n)return;J1.push({cells:H(C),styles:H(Y)}),N1(n,C,Y),x()}function S(n){i.forEach((N)=>N.classList.remove(n))}function mn(){let n=E(Y,F);k1.classList.toggle("active",n.bold),A1.classList.toggle("active",n.italic),T1.classList.toggle("active",n.underline),b1.value=String(n.fontSize),j1.value=n.color,O1.value=n.bg,U1.value=n.align}function g1(){S("selected"),S("active"),S("fill-preview");let n=B(Q,X);for(let M of K(n))i.get(M)?.classList.add("selected");let N=i.get(F);if(N)N.classList.add("active"),N.appendChild(_1);if(r1.textContent=Q===X?F:`${Q}:${X}`,a!==F)r.value=g(F);mn()}function y(n,N,M=!1){if(Q=n,X=N,M)F=N;g1()}function v1(n){let N=f.get(n);if(!N)return;if(a!==n)N.value=l.display(n);let M=E(Y,n);N.style.fontWeight=M.bold?"700":"400",N.style.fontStyle=M.italic?"italic":"normal",N.style.textDecoration=M.underline?"underline":"none",N.style.fontSize=`${M.fontSize}px`,N.style.color=M.color,N.style.background=M.bg,N.style.textAlign=M.align}function x(){f.forEach((n,N)=>v1(N)),g1()}function h1(n,N){if(g(n)===N){v1(n);return}if(A(),N)C[n]=N;else delete C[n];x(),k()}function p(n){A();let N=B(Q,X);for(let M of K(N)){let b={...E(Y,M),...n},j=o(b);if(j)Y[M]=j;else delete Y[M]}x(),k()}function I(n){let N=E(Y,F);p({[n]:!N[n]})}function Cn(){A();let n=B(Q,X);for(let N of K(n))delete C[N];x(),k()}function W1(){if(S("fill-preview"),!c||!L||!T)return;let n=n1(L,T);if(!n)return;for(let N of K(n))i.get(N)?.classList.add("fill-preview")}function Zn(){if(!L||!T)return;let n=n1(L,T);if(!n)return;A();for(let N of K(n)){let M=V1(L,N),b=z(N),j=z(M),U=D1(g(M),b.r-j.r,b.c-j.c);if(U)C[N]=U;else delete C[N];let O=Y[M];if(O)Y[N]={...O};else delete Y[N]}if(n.r2>L.r2)Q=D(L.c1,L.r1),X=D(L.c2,n.r2);else if(n.r1<L.r1)Q=D(L.c1,n.r1),X=D(L.c2,L.r2);else if(n.c2>L.c2)Q=D(L.c1,L.r1),X=D(n.c2,L.r2);else if(n.c1<L.c1)Q=D(n.c1,L.r1),X=D(L.c2,L.r2);x(),k()}function y1(){let n=B(Q,X),N=K(n),M=Q1(N,C,(j)=>l.display(j));if(!M.length){P("Selection has no numeric values for charting.",!0);return}let b=E1.value;t?.destroy(),t=new C1(jn,{type:b,data:{labels:M.map((j)=>j.label),datasets:[{label:b.toUpperCase(),data:M.map((j)=>j.value),borderColor:"#2a6df6",backgroundColor:b==="pie"?["#2a6df6","#60a5fa","#93c5fd","#bfdbfe","#dbeafe","#2563eb"]:"rgba(42, 109, 246, 0.35)",borderWidth:2,fill:b==="line",tension:0.25}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:b==="pie"}}}}),On.textContent=`${Q===X?F:`${Q}:${X}`} (${M.length} pts)`,Z1.classList.add("open"),P(`Rendered ${b} chart from selection.`)}function _n(){let n=B(Q,X),M=K(n).map((j)=>Number.parseFloat(l.display(j))).filter((j)=>Number.isFinite(j));if(!M.length){P("Selection has no numeric values for stats.",!0);return}let b=[{label:"Count",value:String(M.length)},{label:"Sum",value:R.format(",.4~f")(R.sum(M))},{label:"Mean",value:R.format(",.4~f")(R.mean(M)??0)},{label:"Median",value:R.format(",.4~f")(R.median(M)??0)},{label:"Min",value:R.format(",.4~f")(R.min(M)??0)},{label:"Max",value:R.format(",.4~f")(R.max(M)??0)}];K1.innerHTML=`
    <div class="chartPanelHead">
      <strong>Selection Stats</strong>
      <span>${Q===X?F:`${Q}:${X}`}</span>
    </div>
    <div class="statsGrid">
      ${b.map((j)=>`<div class="statCard"><div class="statLabel">${j.label}</div><div class="statValue">${j.value}</div></div>`).join("")}
    </div>
  `,K1.classList.add("open"),P("Computed stats with d3 for selected range.")}function Jn(){let n=1,N=1;for(let m of Object.keys(C)){let Z=z(m);if(!Z)continue;if(!C[m])continue;n=Math.max(n,Z.r),N=Math.max(N,Z.c)}let M=[];for(let m=1;m<=n;m++){let Z=[];for(let $=1;$<=N;$++)Z.push(X1(g(D($,m))));M.push(Z.join(","))}let b=M.join(`
`),j=new Blob([b],{type:"text/csv;charset=utf-8"}),U=URL.createObjectURL(j),O=document.createElement("a");O.href=U,O.download="sheet.csv",O.click(),URL.revokeObjectURL(U)}function Ln(){let n=document.createElement("table"),N=document.createElement("thead"),M=document.createElement("tr"),b=document.createElement("th");b.className="corner",M.appendChild(b);for(let U=1;U<=u;U++){let O=document.createElement("th");O.textContent=v(U),M.appendChild(O)}N.appendChild(M),n.appendChild(N);let j=document.createElement("tbody");for(let U=1;U<=e;U++){let O=document.createElement("tr"),m=document.createElement("th");m.className="rowHead",m.textContent=String(U),O.appendChild(m);for(let Z=1;Z<=u;Z++){let $=D(Z,U),_=document.createElement("td");_.dataset.ref=$;let q=document.createElement("input");q.spellcheck=!1,_.addEventListener("mousedown",(J)=>{if(J.button!==0)return;if(J.target.classList.contains("fill-handle"))return;if(d=!0,J.shiftKey)y(Q,$,!0);else F=$,y($,$,!0);q.focus()}),_.addEventListener("mouseenter",()=>{if(d)y(Q,$,!0);if(c)T=$,W1()}),q.addEventListener("focus",()=>{if(a=$,F=$,!d)y($,$,!0);q.value=g($)}),q.addEventListener("blur",()=>{let J=q.value;a=null,h1($,J)}),q.addEventListener("keydown",(J)=>{let V=z($);if(J.key==="Enter"){J.preventDefault(),q.blur();let W=D(V.c,Math.min(e,V.r+1));f.get(W)?.focus()}else if(J.key==="Tab"){J.preventDefault(),q.blur();let W=D(Math.min(u,V.c+1),V.r);f.get(W)?.focus()}else if(J.key==="Escape")J.preventDefault(),q.value=l.display($),q.blur()}),_.appendChild(q),O.appendChild(_),f.set($,q),i.set($,_)}j.appendChild(O)}n.appendChild(j),R1.innerHTML="",R1.appendChild(n),_1.addEventListener("mousedown",(U)=>{U.preventDefault(),U.stopPropagation(),c=!0,L=B(Q,X),T=F,W1()})}r.addEventListener("keydown",(n)=>{if(n.key==="Enter")h1(F,r.value),f.get(F)?.focus()});k1.addEventListener("click",()=>I("bold"));A1.addEventListener("click",()=>I("italic"));T1.addEventListener("click",()=>I("underline"));b1.addEventListener("change",()=>p({fontSize:Number(b1.value)}));j1.addEventListener("change",()=>p({color:j1.value}));O1.addEventListener("change",()=>p({bg:O1.value}));U1.addEventListener("change",()=>p({align:U1.value}));a1.addEventListener("click",I1);t1.addEventListener("click",m1);function S1(){return JSON.stringify({cells:C,styles:Y},null,2)}function q1(n){A();for(let N of Object.keys(C))delete C[N];for(let N of Object.keys(Y))delete Y[N];if(n&&typeof n==="object"&&n.cells&&typeof n.cells==="object"){for(let[N,M]of Object.entries(n.cells))if(typeof M==="string")C[N.toUpperCase()]=M;if(n.styles&&typeof n.styles==="object")for(let[N,M]of Object.entries(n.styles)){if(!M||typeof M!=="object")continue;let b=o(M);if(b)Y[N.toUpperCase()]=b}}else for(let[N,M]of Object.entries(n))if(typeof M==="string")C[N.toUpperCase()]=M;x(),k()}function G1(n,N="Invalid JSON"){try{let M=JSON.parse(n);return q1(M),!0}catch{return alert(N),!1}}async function i1(){if(!w){P("Storage API unavailable in this runtime.",!0);return}try{let n=f1(),N=P1(C);await w.save(n,N),P(`Saved XLSX to storage: ${n}`)}catch(n){let N=n instanceof Error?n.message:"Failed to save";P(N,!0)}}async function c1(){if(!w){P("Storage API unavailable in this runtime.",!0);return}try{let n=f1();if(n.toLowerCase().endsWith(".json")){let U=await w.read(n,{as:"text"});if(typeof U!=="string")throw Error("Workbook content is not text");if(G1(U,`Invalid JSON in ${n}`))P(`Opened JSON from storage: ${n}`);return}let M=await w.read(n,{as:"arraybuffer"}),b=M instanceof Uint8Array?M:new Uint8Array(M),j=x1(b);q1(j),P(`Opened XLSX from storage: ${n}`)}catch(n){let N=n instanceof Error?n.message:"Failed to open file";P(N,!0)}}l1.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(S1()),P("Workbook JSON copied to clipboard.")}catch{alert("Clipboard access failed. Use Save Store instead.")}});s1.addEventListener("click",()=>{let n=prompt("Paste JSON: { cells: {...}, styles: {...} } (legacy cell map also supported)");if(!n)return;if(G1(n,"Invalid JSON"))P("Loaded workbook from pasted JSON.")});e1.addEventListener("click",()=>{i1()});nn.addEventListener("click",()=>{c1()});Nn.addEventListener("click",()=>{Jn(),P("CSV exported.")});Mn.addEventListener("click",()=>{y1()});bn.addEventListener("click",()=>{_n()});E1.addEventListener("change",()=>{if(Z1.classList.contains("open"))y1()});Un.addEventListener("click",()=>{t?.destroy(),t=null,Z1.classList.remove("open")});document.addEventListener("mouseup",()=>{if(d=!1,c)Zn(),c=!1,L=null,T=null,S("fill-preview")});document.addEventListener("keydown",(n)=>{let M=n.target===r;if((n.ctrlKey||n.metaKey)&&n.key.toLowerCase()==="s"){n.preventDefault(),i1();return}if((n.ctrlKey||n.metaKey)&&n.key.toLowerCase()==="o"){n.preventDefault(),c1();return}if((n.ctrlKey||n.metaKey)&&n.key.toLowerCase()==="z"){if(n.preventDefault(),n.shiftKey)m1();else I1();return}if((n.ctrlKey||n.metaKey)&&n.key.toLowerCase()==="y"){n.preventDefault(),m1();return}if((n.ctrlKey||n.metaKey)&&n.key.toLowerCase()==="b"){n.preventDefault(),I("bold");return}if((n.ctrlKey||n.metaKey)&&n.key.toLowerCase()==="i"){n.preventDefault(),I("italic");return}if((n.ctrlKey||n.metaKey)&&n.key.toLowerCase()==="u"){n.preventDefault(),I("underline");return}if(n.key==="Delete"&&!M)Cn()});Ln();x();async function qn(){if(!w)return;if(Object.keys(C).length>0)return;try{let n=await w.read($1,{as:"text"});if(typeof n!=="string"||!n.trim())return;if(G1(n,"Autosave is corrupted and could not be restored."))P(`Recovered autosave from ${$1}`)}catch{}}qn();if(!w)P("Storage API unavailable in this runtime.",!0);var B1=window.yaar?.app;if(B1)B1.register({appId:"excel-lite",name:"Excel Lite",state:{cells:{description:'All cell values as a { [ref]: rawValue } object (e.g., {"A1":"Hello","B2":"=A1+1"})',handler:()=>({...C})},styles:{description:"All cell styles as a { [ref]: CellStyle } object",handler:()=>({...Y})},selection:{description:"Current selection: { active, start, end }",handler:()=>({active:F,start:Q,end:X})}},commands:{setCells:{description:"Set one or more cell values. Params: { cells: { [ref]: value } }",params:{type:"object",properties:{cells:{type:"object",additionalProperties:{type:"string"}}},required:["cells"]},handler:(n)=>{A();for(let[N,M]of Object.entries(n.cells)){let b=N.toUpperCase();if(M)C[b]=M;else delete C[b]}return x(),k(),{ok:!0,count:Object.keys(n.cells).length}}},setStyles:{description:"Set styles for one or more cells. Params: { styles: { [ref]: Partial<CellStyle> } }",params:{type:"object",properties:{styles:{type:"object"}},required:["styles"]},handler:(n)=>{A();for(let[N,M]of Object.entries(n.styles)){let b=N.toUpperCase(),j={...E(Y,b),...M},U=o(j);if(U)Y[b]=U;else delete Y[b]}return x(),k(),{ok:!0}}},selectCell:{description:"Select a cell or range. Params: { ref: string } or { start: string, end: string }",params:{type:"object",properties:{ref:{type:"string"},start:{type:"string"},end:{type:"string"}}},handler:(n)=>{let N=(n.start??n.ref??"A1").toUpperCase(),M=(n.end??N).toUpperCase();return F=N,y(N,M,!0),{ok:!0}}},clearRange:{description:"Clear all cell values in a range. Params: { start: string, end: string }",params:{type:"object",properties:{start:{type:"string"},end:{type:"string"}},required:["start","end"]},handler:(n)=>{A();let N=B(n.start.toUpperCase(),n.end.toUpperCase()),M=0;for(let b of K(N))if(C[b])delete C[b],M++;return x(),k(),{ok:!0,cleared:M}}},importWorkbook:{description:"Import a full workbook JSON. Params: { data: { cells: {...}, styles?: {...} } }",params:{type:"object",properties:{data:{type:"object"}},required:["data"]},handler:(n)=>{return q1(n.data),{ok:!0}}}}});

</script>
</body>
</html>