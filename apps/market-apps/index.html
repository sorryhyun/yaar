<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Market Apps</title>
<style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden}body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}</style>
<script>(function(){if(window.__yaarCaptureInstalled)return;window.__yaarCaptureInstalled=!0;function o(r,e){window.parent.postMessage({type:"yaar:capture-response",requestId:r,imageData:e},"*")}function s(r,e){for(var t=r.querySelectorAll("*"),d=e.querySelectorAll("*"),c=0;c<t.length&&c<d.length;c++){var u=window.getComputedStyle(t[c]);d[c].setAttribute("style",u.cssText)}var n=window.getComputedStyle(r);e.setAttribute("style",n.cssText)}function a(r,e,t,d){var c=new Blob([r],{type:"image/svg+xml;charset=utf-8"}),u=URL.createObjectURL(c),n=new Image;n.onload=function(){var f=document.createElement("canvas");f.width=e,f.height=t;var i=f.getContext("2d");i.drawImage(n,0,0,e,t),URL.revokeObjectURL(u),d(f.toDataURL("image/png"))},n.onerror=function(){URL.revokeObjectURL(u),d(null)},n.src=u}window.addEventListener("message",function(r){if(!(!r.data||r.data.type!=="yaar:capture-request")){var e=r.data.requestId,t=null;try{var d=document.querySelectorAll("canvas");if(d.length>0){for(var c=null,u=0,n=0;n<d.length;n++){var f=d[n].width*d[n].height;f>u&&(u=f,c=d[n])}c&&(t=c.toDataURL("image/png"))}if(t){o(e,t);return}var i=document.querySelectorAll("svg");if(i.length>0){for(var c=null,u=0,n=0;n<i.length;n++){var l=i[n].getBoundingClientRect(),f=l.width*l.height;f>u&&(u=f,c=i[n])}if(c){var y=new XMLSerializer,w=y.serializeToString(c),l=c.getBoundingClientRect();a(w,l.width||300,l.height||150,function(j){o(e,j)});return}}var p=document.body;if(p){var g=Math.min(p.scrollWidth,window.innerWidth)||window.innerWidth||800,m=Math.min(p.scrollHeight,window.innerHeight)||window.innerHeight||600,h=p.cloneNode(!0);s(p,h);for(var v=h.querySelectorAll("script,iframe"),n=0;n<v.length;n++)v[n].remove();var q="http://www.w3.org/1999/xhtml",I="http://www.w3.org/2000/svg",b=new XMLSerializer().serializeToString(h),w='<svg xmlns="'+I+'" width="'+g+'" height="'+m+'"><foreignObject width="100%" height="100%"><body xmlns="'+q+'" style="margin:0;padding:0;">'+b+"</body></foreignObject></svg>";a(w,g,m,function(S){o(e,S)});return}}catch{}o(e,null)}})})(),function(){if(window.__yaarStorageInstalled)return;window.__yaarStorageInstalled=!0;function o(s){return s.split("/").map(encodeURIComponent).join("/")}window.yaar=window.yaar||{},window.yaar.storage={async save(s,a){var r;typeof a=="string"?r=a:a instanceof Blob?r=await a.arrayBuffer():a instanceof ArrayBuffer?r=a:a instanceof Uint8Array?r=a.buffer.slice(a.byteOffset,a.byteOffset+a.byteLength):r=String(a);var e=await fetch("/api/storage/"+o(s),{method:"POST",body:r});if(!e.ok){var t=await e.json().catch(function(){return{error:e.statusText}});throw new Error(t.error||"Save failed")}return e.json()},async read(s,a){var r=a&&a.as||"auto",e=await fetch("/api/storage/"+o(s));if(!e.ok){var t=await e.json().catch(function(){return{error:e.statusText}});throw new Error(t.error||"Read failed")}if(r==="blob")return e.blob();if(r==="arraybuffer")return e.arrayBuffer();if(r==="json")return e.json();if(r==="text")return e.text();var d=e.headers.get("content-type")||"";return d.includes("json")?e.json():d.startsWith("text/")?e.text():e.blob()},async list(s){var a=s?o(s):"",r=await fetch("/api/storage/"+a+"?list=true");if(!r.ok){var e=await r.json().catch(function(){return{error:r.statusText}});throw new Error(e.error||"List failed")}return r.json()},async remove(s){var a=await fetch("/api/storage/"+o(s),{method:"DELETE"});if(!a.ok){var r=await a.json().catch(function(){return{error:a.statusText}});throw new Error(r.error||"Delete failed")}return a.json()},url:function(s){return"/api/storage/"+o(s)}}}(),function(){if(!window.__yaarFetchProxyInstalled){window.__yaarFetchProxyInstalled=!0;var o=window.fetch.bind(window),s="";try{var a=new URLSearchParams(location.search),r=a.get("sessionId")||"";/^[a-zA-Z0-9_-]+$/.test(r)&&(s=r)}catch{}window.fetch=function(e,t){var d;if(e instanceof Request?d=e.url:d=String(e),d.startsWith("/")||d.startsWith("./")||d.startsWith("../"))return o(e,t);try{var c=new URL(d,location.origin);if(c.origin===location.origin)return o(e,t)}catch{return o(e,t)}var u=t&&t.method||(e instanceof Request?e.method:"GET"),n={};t&&t.headers?t.headers instanceof Headers?t.headers.forEach(function(i,l){n[l]=i}):Array.isArray(t.headers)?t.headers.forEach(function(i){n[i[0]]=i[1]}):n=Object.assign({},t.headers):e instanceof Request&&e.headers.forEach(function(i,l){n[l]=i});var f;return t&&t.body!=null?typeof t.body=="string"?f=Promise.resolve(t.body):f=new Response(t.body).text():e instanceof Request&&u!=="GET"&&u!=="HEAD"?f=e.text():f=Promise.resolve(void 0),f.then(function(i){var l={url:d,method:u,headers:n};return i!==void 0&&(l.body=i),s&&(l.sessionId=s),o("/api/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)})}).then(function(i){return i.ok?i.json():i.json().then(function(l){throw new Error(l.error||"Fetch proxy error: "+i.status)})}).then(function(i){var l;if(i.bodyEncoding==="base64"){for(var y=atob(i.body),w=new Uint8Array(y.length),p=0;p<y.length;p++)w[p]=y.charCodeAt(p);l=w.buffer}else l=i.body;return new Response(l,{status:i.status,statusText:i.statusText,headers:i.headers})})}}}(),function(){if(!window.__yaarAppProtocolInstalled){window.__yaarAppProtocolInstalled=!0,window.yaar=window.yaar||{};var o=null;window.yaar.app={register:function(s){o=s,window.parent.postMessage({type:"yaar:app-ready",appId:s.appId},"*")},sendInteraction:function(s){window.parent.postMessage({type:"yaar:app-interaction",content:typeof s=="string"?s:JSON.stringify(s)},"*")}},window.addEventListener("message",function(s){if(!(!s.data||!s.data.type)){var a=s.data,r=a.requestId;if(a.type==="yaar:app-manifest-request"){if(!o){window.parent.postMessage({type:"yaar:app-manifest-response",requestId:r,manifest:null,error:"No app registered"},"*");return}var e={appId:o.appId,name:o.name,state:{},commands:{}};if(o.state)for(var t in o.state){var d=o.state[t];e.state[t]={description:d.description},d.schema&&(e.state[t].schema=d.schema)}if(o.commands)for(var t in o.commands){var c=o.commands[t];e.commands[t]={description:c.description},c.params&&(e.commands[t].params=c.params),c.returns&&(e.commands[t].returns=c.returns)}window.parent.postMessage({type:"yaar:app-manifest-response",requestId:r,manifest:e},"*");return}if(a.type==="yaar:app-query-request"){if(!o||!o.state||!o.state[a.stateKey]){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:null,error:"Unknown state key: "+a.stateKey},"*");return}try{var u=o.state[a.stateKey].handler();u&&typeof u.then=="function"?u.then(function(n){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:n},"*")}).catch(function(n){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:null,error:String(n)},"*")}):window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:u},"*")}catch(n){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:null,error:String(n)},"*")}return}if(a.type==="yaar:app-command-request"){if(!o||!o.commands||!o.commands[a.command]){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:null,error:"Unknown command: "+a.command},"*");return}try{var u=o.commands[a.command].handler(a.params);u&&typeof u.then=="function"?u.then(function(f){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:f},"*")}).catch(function(f){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:null,error:String(f)},"*")}):window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:u},"*")}catch(n){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:null,error:String(n)},"*")}return}}})}}();</script>
</head>
<body>
<div id="app"></div>
<script type="module">
var w="market_apps.domain",D="https://yaarmarket.vercel.app";function T(e){let t=(e||"").trim();return t?t.replace(/\/+$/,""):""}function P(){let e=new URLSearchParams(window.location.search).get("domain"),t=window.__MARKET_APPS_DOMAIN__,o=localStorage.getItem(w);return T(e||t||o||D)}var A=document.createElement("div");A.style.cssText=`
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: #0b1020;
  color: #e8ecff;
`;document.body.style.margin="0";document.body.appendChild(A);var x="market",l=[],p=[],k="Waiting for data\u2026",b="",d=!1,a=P();function j(){return new Date().toLocaleString()}function C(){b=j()}function s(e,t=!0){k=e,t&&C()}function L(e){a=T(e),a?localStorage.setItem(w,a):localStorage.removeItem(w),s(a?`Domain set: ${a}`:"Domain cleared"),r()}async function E(e){if(!a)throw new Error("No domain configured. Set a domain first.");let t=await fetch(`${a}${e}`,{method:"GET"});if(!t.ok)throw new Error(`GET ${e} failed (${t.status})`);return t.json()}async function I(e,t){if(!a)throw new Error("No domain configured. Set a domain first.");let o=await fetch(`${a}${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!o.ok)throw new Error(`POST ${e} failed (${o.status})`);return o.json()}function R(e){return Array.isArray(e.marketApps)?e.marketApps:Array.isArray(e.apps)?e.apps:[]}function N(e){return Array.isArray(e.installedApps)?e.installedApps:Array.isArray(e.installed)?e.installed:[]}async function y(){if(!a){s("No domain configured. Use App Protocol command setDomain.",!0),r();return}d=!0,s("Refreshing\u2026",!1),r();try{let e=await E("/api/apps/");l=R(e);try{let t=await E("/api/installed");p=N(t),s(`Loaded ${l.length} market / ${p.length} installed apps`)}catch{p=[],s(`Loaded ${l.length} market apps (no /api/installed endpoint)`)}}catch(e){s(`Refresh failed: ${e?.message||String(e)}`)}finally{d=!1,r()}}async function U(e){try{d=!0,s(`Installing ${e.name}\u2026`,!1),r(),await I("/api/install",{appId:e.id}),s(`Installed ${e.name}`),await y()}catch(t){d=!1,s(`Install failed: ${t?.message||String(t)}`),r()}}async function _(e){try{d=!0,s(`Uninstalling ${e.name}\u2026`,!1),r(),await I("/api/uninstall",{appId:e.id}),s(`Uninstalled ${e.name}`),await y()}catch(t){d=!1,s(`Uninstall failed: ${t?.message||String(t)}`),r()}}function v(e,t,o,h,f=!1){let c=document.createElement("div");c.style.cssText=`
    border: 1px solid #263254;
    border-radius: 10px;
    padding: 12px;
    display: flex;
    justify-content: space-between;
    gap: 12px;
    align-items: center;
    background: #121a34;
  `;let g=document.createElement("div"),m=document.createElement("div");m.textContent=e,m.style.cssText="font-weight: 600;";let u=document.createElement("div");u.textContent=t,u.style.cssText="opacity: 0.8; font-size: 12px; margin-top: 2px;",g.append(m,u);let i=document.createElement("button");return i.textContent=o,i.disabled=f,i.style.cssText=`
    border: 1px solid #3c4d84;
    background: ${f?"#18213f":"#1f2b54"};
    color: #e8ecff;
    border-radius: 8px;
    padding: 8px 12px;
    cursor: ${f?"not-allowed":"pointer"};
    opacity: ${f?.7:1};
  `,i.onclick=h,c.append(g,i),c}function r(){A.innerHTML="";let e=document.createElement("div");e.style.cssText="padding: 14px 16px; border-bottom: 1px solid #263254; display: flex; justify-content: space-between; align-items: center; gap: 10px;";let t=document.createElement("div"),o=document.createElement("div");o.textContent="Market Apps",o.style.cssText="font-size: 18px; font-weight: 700;";let h=document.createElement("div");h.textContent=`${k}${b?` \u2022 ${b}`:""}`,h.style.cssText="font-size: 12px; opacity: 0.8; margin-top: 2px;";let f=document.createElement("div");f.textContent=a?`Domain: ${a}`:"Domain: (not set)",f.style.cssText="font-size: 11px; opacity: 0.7; margin-top: 4px;",t.append(o,h,f);let c=document.createElement("button");c.textContent=d?"Refreshing\u2026":"Refresh",c.disabled=d,c.style.cssText="border: 1px solid #3c4d84; background: #1f2b54; color: #e8ecff; border-radius: 8px; padding: 8px 12px; cursor: pointer;",c.onclick=()=>{y()},e.append(t,c);let g=document.createElement("div");g.style.cssText="display: flex; gap: 8px; padding: 10px 16px; border-bottom: 1px solid #263254;";let m=document.createElement("button");m.textContent=`Marketplace (${l.length})`;let u=document.createElement("button");u.textContent=`Installed (${p.length})`,[m,u].forEach(n=>{n.style.cssText="border: 1px solid #3c4d84; background: #1a2445; color: #e8ecff; border-radius: 999px; padding: 6px 12px; cursor: pointer;"}),x==="market"&&(m.style.background="#2f4fd1"),x==="installed"&&(u.style.background="#2f4fd1"),m.onclick=()=>{x="market",r()},u.onclick=()=>{x="installed",r()},g.append(m,u);let i=document.createElement("div");if(i.style.cssText="padding: 14px 16px; overflow: auto; display: grid; gap: 10px;",x==="market")if(l.length)for(let n of l){let S=[n.description,n.version?`v${n.version}`:"",n.author||""].filter(Boolean).join(" \u2022 ");i.appendChild(v(n.name,S,n.installed?"Reinstall":"Install",()=>void U(n),d))}else{let n=document.createElement("div");n.textContent="No marketplace apps loaded.",n.style.opacity="0.8",i.appendChild(n)}else if(p.length)for(let n of p)i.appendChild(v(n.name,n.id,"Uninstall",()=>void _(n),d));else{let n=document.createElement("div");n.textContent="No installed apps loaded.",n.style.opacity="0.8",i.appendChild(n)}A.append(e,g,i)}r();var $=window.yaar?.app;$&&$.register({appId:"market-apps",name:"Market Apps",state:{marketApps:{description:"Current marketplace app list",handler:()=>[...l]},installedApps:{description:"Current installed app list",handler:()=>[...p]},status:{description:"Status line text",handler:()=>k},lastUpdated:{description:"Last updated local timestamp",handler:()=>b},domain:{description:"Configured marketplace domain",handler:()=>a},loading:{description:"Whether network request is in progress",handler:()=>d}},commands:{setDomain:{description:"Set marketplace API domain (e.g. https://example.com)",params:{type:"object",properties:{domain:{type:"string"},autoRefresh:{type:"boolean"}},required:["domain"]},handler:async e=>(L(e.domain),e.autoRefresh!==!1&&await y(),{ok:!0,domain:a})},refresh:{description:"Fetch data from configured domain",params:{type:"object",properties:{}},handler:async()=>(await y(),{ok:!0,marketCount:l.length,installedCount:p.length})},setData:{description:"Set marketplace and installed data manually",params:{type:"object",properties:{marketApps:{type:"array",items:{type:"object"}},installedApps:{type:"array",items:{type:"object"}},status:{type:"string"}}},handler:e=>(e.marketApps&&(l=e.marketApps),e.installedApps&&(p=e.installedApps),e.status&&(k=e.status),C(),r(),{ok:!0,marketCount:l.length,installedCount:p.length})},setStatus:{description:"Update status line",params:{type:"object",properties:{status:{type:"string"}},required:["status"]},handler:e=>(s(e.status),r(),{ok:!0})},clearData:{description:"Clear all app data",params:{type:"object",properties:{}},handler:()=>(l=[],p=[],s("Cleared"),r(),{ok:!0})}}});a?y():(s("No domain configured. Set domain via App Protocol setDomain command.",!0),r());

</script>
</body>
</html>