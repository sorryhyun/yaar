<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Market Apps</title>
<style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden}body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}</style>
<script>(function(){if(window.__yaarCaptureInstalled)return;window.__yaarCaptureInstalled=true;function respond(requestId,imageData){window.parent.postMessage({type:"yaar:capture-response",requestId,imageData},"*")}function inlineStyles(original,clone){var origEls=original.querySelectorAll("*");var cloneEls=clone.querySelectorAll("*");for(var i=0;i<origEls.length&&i<cloneEls.length;i++){var cs=window.getComputedStyle(origEls[i]);cloneEls[i].setAttribute("style",cs.cssText)}var rootCs=window.getComputedStyle(original);clone.setAttribute("style",rootCs.cssText)}function svgToCanvas(svgStr,w,h,cb){var blob=new Blob([svgStr],{type:"image/svg+xml;charset=utf-8"});var url=URL.createObjectURL(blob);var img=new Image;img.onload=function(){var c=document.createElement("canvas");c.width=w;c.height=h;var ctx=c.getContext("2d");ctx.drawImage(img,0,0,w,h);URL.revokeObjectURL(url);cb(c.toDataURL("image/png"))};img.onerror=function(){URL.revokeObjectURL(url);cb(null)};img.src=url}window.addEventListener("message",function(e){if(!e.data||e.data.type!=="yaar:capture-request")return;var requestId=e.data.requestId;var imageData=null;try{var canvases=document.querySelectorAll("canvas");if(canvases.length>0){var largest=null;var largestArea=0;for(var i=0;i<canvases.length;i++){var area=canvases[i].width*canvases[i].height;if(area>largestArea){largestArea=area;largest=canvases[i]}}if(largest){imageData=largest.toDataURL("image/png")}}if(imageData){respond(requestId,imageData);return}var svgs=document.querySelectorAll("svg");if(svgs.length>0){var largest=null;var largestArea=0;for(var i=0;i<svgs.length;i++){var rect=svgs[i].getBoundingClientRect();var area=rect.width*rect.height;if(area>largestArea){largestArea=area;largest=svgs[i]}}if(largest){var serializer=new XMLSerializer;var svgStr=serializer.serializeToString(largest);var rect=largest.getBoundingClientRect();svgToCanvas(svgStr,rect.width||300,rect.height||150,function(data){respond(requestId,data)});return}}var body=document.body;if(body){var w=Math.min(body.scrollWidth,window.innerWidth)||window.innerWidth||800;var h=Math.min(body.scrollHeight,window.innerHeight)||window.innerHeight||600;var clone=body.cloneNode(true);inlineStyles(body,clone);var remove=clone.querySelectorAll("script,iframe");for(var i=0;i<remove.length;i++)remove[i].remove();var xmlns="http://www.w3.org/1999/xhtml";var svgNS="http://www.w3.org/2000/svg";var xhtml=new XMLSerializer().serializeToString(clone);var svgStr='<svg xmlns="'+svgNS+'" width="'+w+'" height="'+h+'">'+'<foreignObject width="100%" height="100%">'+'<body xmlns="'+xmlns+'" style="margin:0;padding:0;">'+xhtml+"</body></foreignObject></svg>";svgToCanvas(svgStr,w,h,function(data){respond(requestId,data)});return}}catch(ex){}respond(requestId,null)})})();(function(){if(window.__yaarStorageInstalled)return;window.__yaarStorageInstalled=true;function encodePath(p){return p.split("/").map(encodeURIComponent).join("/")}window.yaar=window.yaar||{};window.yaar.storage={async save(path,data){var body;if(typeof data==="string"){body=data}else if(data instanceof Blob){body=await data.arrayBuffer()}else if(data instanceof ArrayBuffer){body=data}else if(data instanceof Uint8Array){body=data.buffer.slice(data.byteOffset,data.byteOffset+data.byteLength)}else{body=String(data)}var res=await fetch("/api/storage/"+encodePath(path),{method:"POST",body});if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Save failed")}return res.json()},async read(path,options){var mode=options&&options.as||"auto";var res=await fetch("/api/storage/"+encodePath(path));if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Read failed")}if(mode==="blob")return res.blob();if(mode==="arraybuffer")return res.arrayBuffer();if(mode==="json")return res.json();if(mode==="text")return res.text();var ct=res.headers.get("content-type")||"";if(ct.includes("json"))return res.json();if(ct.startsWith("text/"))return res.text();return res.blob()},async list(dirPath){var p=dirPath?encodePath(dirPath):"";var res=await fetch("/api/storage/"+p+"?list=true");if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"List failed")}return res.json()},async remove(path){var res=await fetch("/api/storage/"+encodePath(path),{method:"DELETE"});if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Delete failed")}return res.json()},url:function(path){return"/api/storage/"+encodePath(path)}}})();(function(){if(window.__yaarFetchProxyInstalled)return;window.__yaarFetchProxyInstalled=true;var realFetch=window.fetch.bind(window);var sessionId="";try{var sp=new URLSearchParams(location.search);var raw=sp.get("sessionId")||"";if(/^[a-zA-Z0-9_-]+$/.test(raw))sessionId=raw}catch(e){}window.fetch=function(input,init){var url;if(input instanceof Request){url=input.url}else{url=String(input)}if(url.startsWith("/")||url.startsWith("./")||url.startsWith("../")){return realFetch(input,init)}try{var parsed=new URL(url,location.origin);if(parsed.origin===location.origin){return realFetch(input,init)}}catch(e){return realFetch(input,init)}var method=init&&init.method||(input instanceof Request?input.method:"GET");var headers={};if(init&&init.headers){if(init.headers instanceof Headers){init.headers.forEach(function(v,k){headers[k]=v})}else if(Array.isArray(init.headers)){init.headers.forEach(function(pair){headers[pair[0]]=pair[1]})}else{headers=Object.assign({},init.headers)}}else if(input instanceof Request){input.headers.forEach(function(v,k){headers[k]=v})}var bodyPromise;if(init&&init.body!=null){if(typeof init.body==="string"){bodyPromise=Promise.resolve(init.body)}else{bodyPromise=new Response(init.body).text()}}else if(input instanceof Request&&method!=="GET"&&method!=="HEAD"){bodyPromise=input.text()}else{bodyPromise=Promise.resolve(undefined)}return bodyPromise.then(function(bodyStr){var payload={url,method,headers};if(bodyStr!==undefined)payload.body=bodyStr;if(sessionId)payload.sessionId=sessionId;return realFetch("/api/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)})}).then(function(proxyRes){if(!proxyRes.ok){return proxyRes.json().then(function(err){throw new Error(err.error||"Fetch proxy error: "+proxyRes.status)})}return proxyRes.json()}).then(function(data){var body;if(data.bodyEncoding==="base64"){var bin=atob(data.body);var bytes=new Uint8Array(bin.length);for(var i=0;i<bin.length;i++)bytes[i]=bin.charCodeAt(i);body=bytes.buffer}else{body=data.body}return new Response(body,{status:data.status,statusText:data.statusText,headers:data.headers})})}})();(function(){if(window.__yaarAppProtocolInstalled)return;window.__yaarAppProtocolInstalled=true;window.yaar=window.yaar||{};var registration=null;window.yaar.app={register:function(config){registration=config;window.parent.postMessage({type:"yaar:app-ready",appId:config.appId},"*")},sendInteraction:function(description){window.parent.postMessage({type:"yaar:app-interaction",content:typeof description==="string"?description:JSON.stringify(description)},"*")}};window.addEventListener("message",function(e){if(!e.data||!e.data.type)return;var msg=e.data;var requestId=msg.requestId;if(msg.type==="yaar:app-manifest-request"){if(!registration){window.parent.postMessage({type:"yaar:app-manifest-response",requestId,manifest:null,error:"No app registered"},"*");return}var manifest={appId:registration.appId,name:registration.name,state:{},commands:{}};if(registration.state){for(var key in registration.state){var s=registration.state[key];manifest.state[key]={description:s.description};if(s.schema)manifest.state[key].schema=s.schema}}if(registration.commands){for(var key in registration.commands){var c=registration.commands[key];manifest.commands[key]={description:c.description};if(c.params)manifest.commands[key].params=c.params;if(c.returns)manifest.commands[key].returns=c.returns}}window.parent.postMessage({type:"yaar:app-manifest-response",requestId,manifest},"*");return}if(msg.type==="yaar:app-query-request"){if(!registration||!registration.state||!registration.state[msg.stateKey]){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:"Unknown state key: "+msg.stateKey},"*");return}try{var result=registration.state[msg.stateKey].handler();if(result&&typeof result.then==="function"){result.then(function(data){window.parent.postMessage({type:"yaar:app-query-response",requestId,data},"*")}).catch(function(err){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:String(err)},"*")})}else{window.parent.postMessage({type:"yaar:app-query-response",requestId,data:result},"*")}}catch(err){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:String(err)},"*")}return}if(msg.type==="yaar:app-command-request"){if(!registration||!registration.commands||!registration.commands[msg.command]){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:"Unknown command: "+msg.command},"*");return}try{var result=registration.commands[msg.command].handler(msg.params);if(result&&typeof result.then==="function"){result.then(function(data){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:data},"*")}).catch(function(err){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:String(err)},"*")})}else{window.parent.postMessage({type:"yaar:app-command-response",requestId,result},"*")}}catch(err){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:String(err)},"*")}return}})})();</script>
</head>
<body>
<div id="app"></div>
<script type="module">
function S(t){let e=(t||"").trim();if(!e)return"";return e.replace(/\/+$/,"")}function O(){let t=new URLSearchParams(window.location.search).get("domain"),e=window.__MARKET_APPS_DOMAIN__,n=localStorage.getItem("market_apps.domain");return S(t||e||n||"https://yaarmarket.vercel.app")}var h=document.createElement("div");h.style.cssText=`
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: #0b1020;
  color: #e8ecff;
`;document.body.style.margin="0";document.body.appendChild(h);var A="market",i=[],r=[],x="Waiting for data…",k="",d=!1,p=O();function M(){return new Date().toLocaleString()}function C(){k=M()}function s(t,e=!0){if(x=t,e)C()}function N(t){if(p=S(t),p)localStorage.setItem("market_apps.domain",p);else localStorage.removeItem("market_apps.domain");s(p?`Domain set: ${p}`:"Domain cleared"),o()}async function E(t){if(!p)throw Error("No domain configured. Set a domain first.");let e=await fetch(`${p}${t}`,{method:"GET"});if(!e.ok)throw Error(`GET ${t} failed (${e.status})`);return e.json()}async function j(t,e){if(!p)throw Error("No domain configured. Set a domain first.");let n=await fetch(`${p}${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!n.ok)throw Error(`POST ${t} failed (${n.status})`);return n.json()}async function D(t,e){let n;for(let l of t)try{return await j(l,e)}catch(c){n=c}throw n||Error("All POST endpoints failed")}function T(t){return(t||"").trim().toLowerCase()}function P(t){let e=T(t);return r.some((n)=>T(n.id)===e)}function b(t,e){if(e){if(!r.some((n)=>n.id===t.id))r=[...r,{id:t.id,name:t.name}]}else r=r.filter((n)=>n.id!==t.id);i=i.map((n)=>n.id===t.id?{...n,installed:e}:n)}async function _(t,e){let n=window.yaar;if(typeof n?.os?.action==="function"){let l=t==="install"?"apps:market_get":"apps:market_delete";return await n.os.action(l,{appId:e.id}),"os-action"}if(typeof n?.app?.sendInteraction==="function")return n.app.sendInteraction({event:"market-apps:request",action:t,appId:e.id,appName:e.name,requestedAt:new Date().toISOString()}),"interaction";return null}function R(t){return Array.isArray(t.marketApps)?t.marketApps:Array.isArray(t.apps)?t.apps:[]}function U(t){return Array.isArray(t.installedApps)?t.installedApps:Array.isArray(t.installed)?t.installed:[]}function G(t){if(Array.isArray(t))return t.filter((e)=>e&&typeof e.id==="string").map((e)=>({id:e.id,name:e.name||e.id}));if(t&&typeof t==="object")return(Array.isArray(t.apps)?t.apps:Array.isArray(t.installed)?t.installed:Array.isArray(t.installedApps)?t.installedApps:[]).filter((n)=>n&&typeof n.id==="string").map((n)=>({id:n.id,name:n.name||n.id}));return[]}async function w(){if(!p){s("No domain configured. Use App Protocol command setDomain.",!0),o();return}d=!0,s("Refreshing…",!1),o();try{let t=await E("/api/apps/");i=R(t);try{let e=await E("/api/installed");r=U(e),s(`Loaded ${i.length} market / ${r.length} installed apps`)}catch(e){let n=window.yaar;if(typeof n?.os?.action==="function")try{let l=await n.os.action("apps:list",{}),c=G(l);if(c.length)r=c,s(`Loaded ${i.length} market / ${r.length} installed apps (local)`);else r=i.map((m)=>({id:m.id,name:m.name||m.id})),s(`Loaded ${i.length} market apps (assumed installed: no /api/installed endpoint)`)}catch{r=i.map((l)=>({id:l.id,name:l.name||l.id})),s(`Loaded ${i.length} market apps (assumed installed: no /api/installed endpoint)`)}else r=i.map((l)=>({id:l.id,name:l.name||l.id})),s(`Loaded ${i.length} market apps (assumed installed: no /api/installed endpoint)`)}i=i.map((e)=>({...e,installed:e.installed||P(e.id)}))}catch(t){s(`Refresh failed: ${t?.message||String(t)}`)}finally{d=!1,o()}}async function q(t){try{d=!0,s(`Installing ${t.name}…`,!1),o();let e=await _("install",t);if(e==="os-action"){b(t,!0),s(`Installed ${t.name} via OS action`),d=!1,o();return}if(e==="interaction"){s(`Install request sent for ${t.name} (waiting for agent)`),d=!1,o();return}await D(["/api/install","/api/apps/install"],{appId:t.id}),b(t,!0),s(`Installed ${t.name}`),d=!1,o()}catch(e){d=!1,s(`Install failed: ${e?.message||String(e)}`),o()}}async function K(t){try{d=!0,s(`Uninstalling ${t.name}…`,!1),o();let e=await _("uninstall",t);if(e==="os-action"){b(t,!1),s(`Uninstalled ${t.name} via OS action`),d=!1,o();return}if(e==="interaction"){s(`Uninstall request sent for ${t.name} (waiting for agent)`),d=!1,o();return}await D(["/api/uninstall","/api/apps/uninstall"],{appId:t.id}),b(t,!1),s(`Uninstalled ${t.name}`),d=!1,o()}catch(e){d=!1,s(`Uninstall failed: ${e?.message||String(e)}`),o()}}function $(t,e,n,l,c=!1){let m=document.createElement("div");m.style.cssText=`
    border: 1px solid #263254;
    border-radius: 10px;
    padding: 12px;
    display: flex;
    justify-content: space-between;
    gap: 12px;
    align-items: center;
    background: #121a34;
  `;let g=document.createElement("div"),u=document.createElement("div");u.textContent=t,u.style.cssText="font-weight: 600;";let y=document.createElement("div");y.textContent=e,y.style.cssText="opacity: 0.8; font-size: 12px; margin-top: 2px;",g.append(u,y);let f=document.createElement("button");return f.textContent=n,f.disabled=c,f.style.cssText=`
    border: 1px solid #3c4d84;
    background: ${c?"#18213f":"#1f2b54"};
    color: #e8ecff;
    border-radius: 8px;
    padding: 8px 12px;
    cursor: ${c?"not-allowed":"pointer"};
    opacity: ${c?0.7:1};
  `,f.onclick=l,m.append(g,f),m}function o(){h.innerHTML="";let t=document.createElement("div");t.style.cssText="padding: 14px 16px; border-bottom: 1px solid #263254; display: flex; justify-content: space-between; align-items: center; gap: 10px;";let e=document.createElement("div"),n=document.createElement("div");n.textContent="Market Apps",n.style.cssText="font-size: 18px; font-weight: 700;";let l=document.createElement("div");l.textContent=`${x}${k?` • ${k}`:""}`,l.style.cssText="font-size: 12px; opacity: 0.8; margin-top: 2px;";let c=document.createElement("div");c.textContent=p?`Domain: ${p}`:"Domain: (not set)",c.style.cssText="font-size: 11px; opacity: 0.7; margin-top: 4px;",e.append(n,l,c);let m=document.createElement("button");m.textContent=d?"Refreshing…":"Refresh",m.disabled=d,m.style.cssText="border: 1px solid #3c4d84; background: #1f2b54; color: #e8ecff; border-radius: 8px; padding: 8px 12px; cursor: pointer;",m.onclick=()=>{w()},t.append(e,m);let g=document.createElement("div");g.style.cssText="display: flex; gap: 8px; padding: 10px 16px; border-bottom: 1px solid #263254;";let u=document.createElement("button");u.textContent=`Marketplace (${i.length})`;let y=document.createElement("button");if(y.textContent=`Installed (${r.length})`,[u,y].forEach((a)=>{a.style.cssText="border: 1px solid #3c4d84; background: #1a2445; color: #e8ecff; border-radius: 999px; padding: 6px 12px; cursor: pointer;"}),A==="market")u.style.background="#2f4fd1";if(A==="installed")y.style.background="#2f4fd1";u.onclick=()=>{A="market",o()},y.onclick=()=>{A="installed",o()},g.append(u,y);let f=document.createElement("div");if(f.style.cssText="padding: 14px 16px; overflow: auto; display: grid; gap: 10px;",A==="market")if(!i.length){let a=document.createElement("div");a.textContent="No marketplace apps loaded.",a.style.opacity="0.8",f.appendChild(a)}else for(let a of i){let L=[a.description,a.version?`v${a.version}`:"",a.author||""].filter(Boolean).join(" • "),I=a.installed||P(a.id);f.appendChild($(a.name,L,I?"Installed":"Install",()=>void q(a),d||I))}else if(!r.length){let a=document.createElement("div");a.textContent="No installed apps loaded.",a.style.opacity="0.8",f.appendChild(a)}else for(let a of r)f.appendChild($(a.name,a.id,"Uninstall",()=>void K(a),d));h.append(t,g,f)}o();var v=window.yaar?.app;if(v)v.register({appId:"market-apps",name:"Market Apps",state:{marketApps:{description:"Current marketplace app list",handler:()=>[...i]},installedApps:{description:"Current installed app list",handler:()=>[...r]},status:{description:"Status line text",handler:()=>x},lastUpdated:{description:"Last updated local timestamp",handler:()=>k},domain:{description:"Configured marketplace domain",handler:()=>p},loading:{description:"Whether network request is in progress",handler:()=>d}},commands:{setDomain:{description:"Set marketplace API domain (e.g. https://example.com)",params:{type:"object",properties:{domain:{type:"string"},autoRefresh:{type:"boolean"}},required:["domain"]},handler:async(t)=>{if(N(t.domain),t.autoRefresh!==!1)await w();return{ok:!0,domain:p}}},refresh:{description:"Fetch data from configured domain",params:{type:"object",properties:{}},handler:async()=>{return await w(),{ok:!0,marketCount:i.length,installedCount:r.length}}},setData:{description:"Set marketplace and installed data manually",params:{type:"object",properties:{marketApps:{type:"array",items:{type:"object"}},installedApps:{type:"array",items:{type:"object"}},status:{type:"string"}}},handler:(t)=>{if(t.marketApps)i=t.marketApps;if(t.installedApps)r=t.installedApps;if(t.status)x=t.status;return C(),o(),{ok:!0,marketCount:i.length,installedCount:r.length}}},setStatus:{description:"Update status line",params:{type:"object",properties:{status:{type:"string"}},required:["status"]},handler:(t)=>{return s(t.status),o(),{ok:!0}}},clearData:{description:"Clear all app data",params:{type:"object",properties:{}},handler:()=>{return i=[],r=[],s("Cleared"),o(),{ok:!0}}}}});if(p)w();else s("No domain configured. Set domain via App Protocol setDomain command.",!0),o();

</script>
</body>
</html>