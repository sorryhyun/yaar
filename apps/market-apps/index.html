<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Market Apps</title>
<style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden}body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}</style>
<script>(function(){if(window.__yaarCaptureInstalled)return;window.__yaarCaptureInstalled=true;function respond(requestId,imageData){window.parent.postMessage({type:"yaar:capture-response",requestId,imageData},"*")}function inlineStyles(original,clone){var origEls=original.querySelectorAll("*");var cloneEls=clone.querySelectorAll("*");for(var i=0;i<origEls.length&&i<cloneEls.length;i++){var cs=window.getComputedStyle(origEls[i]);cloneEls[i].setAttribute("style",cs.cssText)}var rootCs=window.getComputedStyle(original);clone.setAttribute("style",rootCs.cssText)}function svgToCanvas(svgStr,w,h,cb){var blob=new Blob([svgStr],{type:"image/svg+xml;charset=utf-8"});var url=URL.createObjectURL(blob);var img=new Image;img.onload=function(){var c=document.createElement("canvas");c.width=w;c.height=h;var ctx=c.getContext("2d");ctx.drawImage(img,0,0,w,h);URL.revokeObjectURL(url);cb(c.toDataURL("image/png"))};img.onerror=function(){URL.revokeObjectURL(url);cb(null)};img.src=url}window.addEventListener("message",function(e){if(!e.data||e.data.type!=="yaar:capture-request")return;var requestId=e.data.requestId;var imageData=null;try{var canvases=document.querySelectorAll("canvas");if(canvases.length>0){var largest=null;var largestArea=0;for(var i=0;i<canvases.length;i++){var area=canvases[i].width*canvases[i].height;if(area>largestArea){largestArea=area;largest=canvases[i]}}if(largest){imageData=largest.toDataURL("image/png")}}if(imageData){respond(requestId,imageData);return}var svgs=document.querySelectorAll("svg");if(svgs.length>0){var largest=null;var largestArea=0;for(var i=0;i<svgs.length;i++){var rect=svgs[i].getBoundingClientRect();var area=rect.width*rect.height;if(area>largestArea){largestArea=area;largest=svgs[i]}}if(largest){var serializer=new XMLSerializer;var svgStr=serializer.serializeToString(largest);var rect=largest.getBoundingClientRect();svgToCanvas(svgStr,rect.width||300,rect.height||150,function(data){respond(requestId,data)});return}}var body=document.body;if(body){var w=Math.min(body.scrollWidth,window.innerWidth)||window.innerWidth||800;var h=Math.min(body.scrollHeight,window.innerHeight)||window.innerHeight||600;var clone=body.cloneNode(true);inlineStyles(body,clone);var remove=clone.querySelectorAll("script,iframe");for(var i=0;i<remove.length;i++)remove[i].remove();var xmlns="http://www.w3.org/1999/xhtml";var svgNS="http://www.w3.org/2000/svg";var xhtml=new XMLSerializer().serializeToString(clone);var svgStr='<svg xmlns="'+svgNS+'" width="'+w+'" height="'+h+'">'+'<foreignObject width="100%" height="100%">'+'<body xmlns="'+xmlns+'" style="margin:0;padding:0;">'+xhtml+"</body></foreignObject></svg>";svgToCanvas(svgStr,w,h,function(data){respond(requestId,data)});return}}catch(ex){}respond(requestId,null)})})();(function(){if(window.__yaarStorageInstalled)return;window.__yaarStorageInstalled=true;function encodePath(p){return p.split("/").map(encodeURIComponent).join("/")}window.yaar=window.yaar||{};window.yaar.storage={async save(path,data){var body;if(typeof data==="string"){body=data}else if(data instanceof Blob){body=await data.arrayBuffer()}else if(data instanceof ArrayBuffer){body=data}else if(data instanceof Uint8Array){body=data.buffer.slice(data.byteOffset,data.byteOffset+data.byteLength)}else{body=String(data)}var res=await fetch("/api/storage/"+encodePath(path),{method:"POST",body});if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Save failed")}return res.json()},async read(path,options){var mode=options&&options.as||"auto";var res=await fetch("/api/storage/"+encodePath(path));if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Read failed")}if(mode==="blob")return res.blob();if(mode==="arraybuffer")return res.arrayBuffer();if(mode==="json")return res.json();if(mode==="text")return res.text();var ct=res.headers.get("content-type")||"";if(ct.includes("json"))return res.json();if(ct.startsWith("text/"))return res.text();return res.blob()},async list(dirPath){var p=dirPath?encodePath(dirPath):"";var res=await fetch("/api/storage/"+p+"?list=true");if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"List failed")}return res.json()},async remove(path){var res=await fetch("/api/storage/"+encodePath(path),{method:"DELETE"});if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Delete failed")}return res.json()},url:function(path){return"/api/storage/"+encodePath(path)}}})();(function(){if(window.__yaarFetchProxyInstalled)return;window.__yaarFetchProxyInstalled=true;var realFetch=window.fetch.bind(window);var sessionId="";try{var sp=new URLSearchParams(location.search);var raw=sp.get("sessionId")||"";if(/^[a-zA-Z0-9_-]+$/.test(raw))sessionId=raw}catch(e){}window.fetch=function(input,init){var url;if(input instanceof Request){url=input.url}else{url=String(input)}if(url.startsWith("/")||url.startsWith("./")||url.startsWith("../")){return realFetch(input,init)}try{var parsed=new URL(url,location.origin);if(parsed.origin===location.origin){return realFetch(input,init)}}catch(e){return realFetch(input,init)}var method=init&&init.method||(input instanceof Request?input.method:"GET");var headers={};if(init&&init.headers){if(init.headers instanceof Headers){init.headers.forEach(function(v,k){headers[k]=v})}else if(Array.isArray(init.headers)){init.headers.forEach(function(pair){headers[pair[0]]=pair[1]})}else{headers=Object.assign({},init.headers)}}else if(input instanceof Request){input.headers.forEach(function(v,k){headers[k]=v})}var bodyPromise;if(init&&init.body!=null){if(typeof init.body==="string"){bodyPromise=Promise.resolve(init.body)}else{bodyPromise=new Response(init.body).text()}}else if(input instanceof Request&&method!=="GET"&&method!=="HEAD"){bodyPromise=input.text()}else{bodyPromise=Promise.resolve(undefined)}return bodyPromise.then(function(bodyStr){var payload={url,method,headers};if(bodyStr!==undefined)payload.body=bodyStr;if(sessionId)payload.sessionId=sessionId;return realFetch("/api/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)})}).then(function(proxyRes){if(!proxyRes.ok){return proxyRes.json().then(function(err){throw new Error(err.error||"Fetch proxy error: "+proxyRes.status)})}return proxyRes.json()}).then(function(data){var body;if(data.bodyEncoding==="base64"){var bin=atob(data.body);var bytes=new Uint8Array(bin.length);for(var i=0;i<bin.length;i++)bytes[i]=bin.charCodeAt(i);body=bytes.buffer}else{body=data.body}return new Response(body,{status:data.status,statusText:data.statusText,headers:data.headers})})}})();(function(){if(window.__yaarAppProtocolInstalled)return;window.__yaarAppProtocolInstalled=true;window.yaar=window.yaar||{};var registration=null;window.yaar.app={register:function(config){registration=config;window.parent.postMessage({type:"yaar:app-ready",appId:config.appId},"*")},sendInteraction:function(description){window.parent.postMessage({type:"yaar:app-interaction",content:typeof description==="string"?description:JSON.stringify(description)},"*")}};window.addEventListener("message",function(e){if(!e.data||!e.data.type)return;var msg=e.data;var requestId=msg.requestId;if(msg.type==="yaar:app-manifest-request"){if(!registration){window.parent.postMessage({type:"yaar:app-manifest-response",requestId,manifest:null,error:"No app registered"},"*");return}var manifest={appId:registration.appId,name:registration.name,state:{},commands:{}};if(registration.state){for(var key in registration.state){var s=registration.state[key];manifest.state[key]={description:s.description};if(s.schema)manifest.state[key].schema=s.schema}}if(registration.commands){for(var key in registration.commands){var c=registration.commands[key];manifest.commands[key]={description:c.description};if(c.params)manifest.commands[key].params=c.params;if(c.returns)manifest.commands[key].returns=c.returns}}window.parent.postMessage({type:"yaar:app-manifest-response",requestId,manifest},"*");return}if(msg.type==="yaar:app-query-request"){if(!registration||!registration.state||!registration.state[msg.stateKey]){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:"Unknown state key: "+msg.stateKey},"*");return}try{var result=registration.state[msg.stateKey].handler();if(result&&typeof result.then==="function"){result.then(function(data){window.parent.postMessage({type:"yaar:app-query-response",requestId,data},"*")}).catch(function(err){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:String(err)},"*")})}else{window.parent.postMessage({type:"yaar:app-query-response",requestId,data:result},"*")}}catch(err){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:String(err)},"*")}return}if(msg.type==="yaar:app-command-request"){if(!registration||!registration.commands||!registration.commands[msg.command]){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:"Unknown command: "+msg.command},"*");return}try{var result=registration.commands[msg.command].handler(msg.params);if(result&&typeof result.then==="function"){result.then(function(data){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:data},"*")}).catch(function(err){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:String(err)},"*")})}else{window.parent.postMessage({type:"yaar:app-command-response",requestId,result},"*")}}catch(err){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:String(err)},"*")}return}})})();</script>
</head>
<body>
<div id="app"></div>
<script type="module">
function D(t){let e=(t||"").trim();if(!e)return"";return e.replace(/\/+$/,"")}function N(){let t=new URLSearchParams(window.location.search).get("domain"),e=window.__MARKET_APPS_DOMAIN__,n=localStorage.getItem("market_apps.domain");return D(t||e||n||"https://yaarmarket.vercel.app")}var h=document.createElement("div");h.style.cssText=`
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: #0b1020;
  color: #e8ecff;
`;document.body.style.margin="0";document.body.appendChild(h);var A="market",l=[],s=[],x="Waiting for data…",k="",p=!1,c=N();function O(){return new Date().toLocaleString()}function _(){k=O()}function o(t,e=!0){if(x=t,e)_()}function R(t){if(c=D(t),c)localStorage.setItem("market_apps.domain",c);else localStorage.removeItem("market_apps.domain");o(c?`Domain set: ${c}`:"Domain cleared"),r()}async function U(t){if(!c)throw Error("No domain configured. Set a domain first.");let e=await fetch(`${c}${t}`,{method:"GET"});if(!e.ok)throw Error(`GET ${t} failed (${e.status})`);return e.json()}function I(t){return(t||"").trim().toLowerCase()}function P(t){let e=I(t);return s.some((n)=>I(n.id)===e)}function w(t,e){return I(t)===I(e)}function j(t,e){if(e){if(!s.some((n)=>w(n.id,t.id)))s=[...s,{id:t.id,name:t.name}]}else s=s.filter((n)=>!w(n.id,t.id));l=l.map((n)=>w(n.id,t.id)?{...n,installed:e}:n)}async function L(t,e){let n=window.yaar;if(typeof n?.os?.action==="function"){let m=t==="install"?"apps:market_get":"apps:market_delete";return await n.os.action(m,{appId:e.id}),"os-action"}if(typeof n?.app?.sendInteraction==="function")return n.app.sendInteraction({event:"market-apps:request",action:t,appId:e.id,appName:e.name,requestedAt:new Date().toISOString()}),"interaction";throw Error("Host install/uninstall API is unavailable.")}function G(t){return Array.isArray(t.marketApps)?t.marketApps:Array.isArray(t.apps)?t.apps:[]}function $(t){if(!t)return[];let e=t.split(/\r?\n/),n=[];for(let m of e){let i=m.match(/^\s*-\s+(.+?)\s+\(([^)]+)\)/);if(i)n.push({id:i[2].trim(),name:i[1].trim()})}return n}function v(t){if(!t||typeof t!=="object")return null;let e=typeof t.id==="string"?t.id:typeof t.appId==="string"?t.appId:typeof t.slug==="string"?t.slug:typeof t.packageName==="string"?t.packageName:null;if(!e)return null;let n=typeof t.name==="string"?t.name:typeof t.title==="string"?t.title:e;return{id:e,name:n}}function E(t){if(Array.isArray(t))return t.map(v).filter((e)=>!!e);if(typeof t==="string")return $(t);if(t&&typeof t==="object"){let e=Array.isArray(t.apps)?t.apps:Array.isArray(t.installed)?t.installed:Array.isArray(t.installedApps)?t.installedApps:[];if(e.length){let n=e.map(v).filter((m)=>!!m);if(n.length)return n}if(typeof t.text==="string")return $(t.text)}return[]}async function q(){let t=["/api/apps","/api/apps/list","/api/apps/installed","/api/installed"];for(let e of t)try{let n=await fetch(e,{method:"GET"});if(!n.ok)continue;if((n.headers.get("content-type")||"").toLowerCase().includes("application/json")){let i=await n.json(),d=E(i);if(d.length)return d}else{let i=await n.text(),d=E(i);if(d.length)return d}}catch{}return[]}async function b(){if(!c){o("No domain configured. Use App Protocol command setDomain.",!0),r();return}p=!0,o("Refreshing…",!1),r();try{let t=await U("/api/apps/");l=G(t);let e=window.yaar;if(typeof e?.os?.action==="function")try{let n=await e.os.action("apps:list",{});s=E(n),o(`Loaded ${l.length} market / ${s.length} installed apps (apps:list)`)}catch{s=[],o(`Loaded ${l.length} market / ${s.length} installed apps`)}else s=await q(),o(`Loaded ${l.length} market / ${s.length} installed apps`);l=l.map((n)=>({...n,installed:P(n.id)}))}catch(t){o(`Refresh failed: ${t?.message||String(t)}`)}finally{p=!1,r()}}async function K(t){try{if(p=!0,o(`Installing ${t.name}…`,!1),r(),await L("install",t)==="os-action"){j(t,!0),o(`Installed ${t.name} via apps:market_get`),p=!1,r();return}o(`Install request sent for ${t.name} (waiting for agent)`),p=!1,r()}catch(e){p=!1,o(`Install failed: ${e?.message||String(e)}`),r()}}async function z(t){try{if(p=!0,o(`Uninstalling ${t.name}…`,!1),r(),await L("uninstall",t)==="os-action"){j(t,!1),o(`Uninstalled ${t.name} via apps:market_delete`),p=!1,r();return}o(`Uninstall request sent for ${t.name} (waiting for agent)`),p=!1,r()}catch(e){p=!1,o(`Uninstall failed: ${e?.message||String(e)}`),r()}}function S(t,e,n,m,i=!1){let d=document.createElement("div");d.style.cssText=`
    border: 1px solid #263254;
    border-radius: 10px;
    padding: 12px;
    display: flex;
    justify-content: space-between;
    gap: 12px;
    align-items: center;
    background: #121a34;
  `;let g=document.createElement("div"),u=document.createElement("div");u.textContent=t,u.style.cssText="font-weight: 600;";let y=document.createElement("div");y.textContent=e,y.style.cssText="opacity: 0.8; font-size: 12px; margin-top: 2px;",g.append(u,y);let f=document.createElement("button");return f.textContent=n,f.disabled=i,f.style.cssText=`
    border: 1px solid #3c4d84;
    background: ${i?"#18213f":"#1f2b54"};
    color: #e8ecff;
    border-radius: 8px;
    padding: 8px 12px;
    cursor: ${i?"not-allowed":"pointer"};
    opacity: ${i?0.7:1};
  `,f.onclick=m,d.append(g,f),d}function r(){h.innerHTML="";let t=document.createElement("div");t.style.cssText="padding: 14px 16px; border-bottom: 1px solid #263254; display: flex; justify-content: space-between; align-items: center; gap: 10px;";let e=document.createElement("div"),n=document.createElement("div");n.textContent="Market Apps",n.style.cssText="font-size: 18px; font-weight: 700;";let m=document.createElement("div");m.textContent=`${x}${k?` • ${k}`:""}`,m.style.cssText="font-size: 12px; opacity: 0.8; margin-top: 2px;";let i=document.createElement("div");i.textContent=c?`Domain: ${c}`:"Domain: (not set)",i.style.cssText="font-size: 11px; opacity: 0.7; margin-top: 4px;",e.append(n,m,i);let d=document.createElement("button");d.textContent=p?"Refreshing…":"Refresh",d.disabled=p,d.style.cssText="border: 1px solid #3c4d84; background: #1f2b54; color: #e8ecff; border-radius: 8px; padding: 8px 12px; cursor: pointer;",d.onclick=()=>{b()},t.append(e,d);let g=document.createElement("div");g.style.cssText="display: flex; gap: 8px; padding: 10px 16px; border-bottom: 1px solid #263254;";let u=document.createElement("button");u.textContent=`Marketplace (${l.length})`;let y=document.createElement("button");if(y.textContent=`Installed (${s.length})`,[u,y].forEach((a)=>{a.style.cssText="border: 1px solid #3c4d84; background: #1a2445; color: #e8ecff; border-radius: 999px; padding: 6px 12px; cursor: pointer;"}),A==="market")u.style.background="#2f4fd1";if(A==="installed")y.style.background="#2f4fd1";u.onclick=()=>{A="market",r()},y.onclick=()=>{A="installed",r()},g.append(u,y);let f=document.createElement("div");if(f.style.cssText="padding: 14px 16px; overflow: auto; display: grid; gap: 10px;",A==="market")if(!l.length){let a=document.createElement("div");a.textContent="No marketplace apps loaded.",a.style.opacity="0.8",f.appendChild(a)}else for(let a of l){let M=[a.description,a.version?`v${a.version}`:"",a.author||""].filter(Boolean).join(" • "),T=a.installed||P(a.id);f.appendChild(S(a.name,M,T?"Installed":"Install",()=>void K(a),p||T))}else if(!s.length){let a=document.createElement("div");a.textContent="No installed apps loaded.",a.style.opacity="0.8",f.appendChild(a)}else for(let a of s)f.appendChild(S(a.name,a.id,"Uninstall",()=>void z(a),p));h.append(t,g,f)}r();var C=window.yaar?.app;if(C)C.register({appId:"market-apps",name:"Market Apps",state:{marketApps:{description:"Current marketplace app list",handler:()=>[...l]},installedApps:{description:"Current installed app list",handler:()=>[...s]},status:{description:"Status line text",handler:()=>x},lastUpdated:{description:"Last updated local timestamp",handler:()=>k},domain:{description:"Configured marketplace domain",handler:()=>c},loading:{description:"Whether network request is in progress",handler:()=>p}},commands:{setDomain:{description:"Set marketplace API domain (e.g. https://example.com)",params:{type:"object",properties:{domain:{type:"string"},autoRefresh:{type:"boolean"}},required:["domain"]},handler:async(t)=>{if(R(t.domain),t.autoRefresh!==!1)await b();return{ok:!0,domain:c}}},refresh:{description:"Fetch data from configured domain",params:{type:"object",properties:{}},handler:async()=>{return await b(),{ok:!0,marketCount:l.length,installedCount:s.length}}},setData:{description:"Set marketplace and installed data manually",params:{type:"object",properties:{marketApps:{type:"array",items:{type:"object"}},installedApps:{type:"array",items:{type:"object"}},status:{type:"string"}}},handler:(t)=>{if(t.marketApps)l=t.marketApps;if(t.installedApps)s=t.installedApps;if(t.status)x=t.status;return _(),r(),{ok:!0,marketCount:l.length,installedCount:s.length}}},setStatus:{description:"Update status line",params:{type:"object",properties:{status:{type:"string"}},required:["status"]},handler:(t)=>{return o(t.status),r(),{ok:!0}}},clearData:{description:"Clear all app data",params:{type:"object",properties:{}},handler:()=>{return l=[],s=[],o("Cleared"),r(),{ok:!0}}}}});if(c)b();else o("No domain configured. Set domain via App Protocol setDomain command.",!0),r();

</script>
</body>
</html>