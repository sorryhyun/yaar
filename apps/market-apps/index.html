<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Market Apps</title>
<style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden}body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}</style>
<script>(function(){if(window.__yaarCaptureInstalled)return;window.__yaarCaptureInstalled=!0;function o(r,e){window.parent.postMessage({type:"yaar:capture-response",requestId:r,imageData:e},"*")}function s(r,e){for(var t=r.querySelectorAll("*"),d=e.querySelectorAll("*"),c=0;c<t.length&&c<d.length;c++){var u=window.getComputedStyle(t[c]);d[c].setAttribute("style",u.cssText)}var n=window.getComputedStyle(r);e.setAttribute("style",n.cssText)}function a(r,e,t,d){var c=new Blob([r],{type:"image/svg+xml;charset=utf-8"}),u=URL.createObjectURL(c),n=new Image;n.onload=function(){var f=document.createElement("canvas");f.width=e,f.height=t;var i=f.getContext("2d");i.drawImage(n,0,0,e,t),URL.revokeObjectURL(u),d(f.toDataURL("image/png"))},n.onerror=function(){URL.revokeObjectURL(u),d(null)},n.src=u}window.addEventListener("message",function(r){if(!(!r.data||r.data.type!=="yaar:capture-request")){var e=r.data.requestId,t=null;try{var d=document.querySelectorAll("canvas");if(d.length>0){for(var c=null,u=0,n=0;n<d.length;n++){var f=d[n].width*d[n].height;f>u&&(u=f,c=d[n])}c&&(t=c.toDataURL("image/png"))}if(t){o(e,t);return}var i=document.querySelectorAll("svg");if(i.length>0){for(var c=null,u=0,n=0;n<i.length;n++){var l=i[n].getBoundingClientRect(),f=l.width*l.height;f>u&&(u=f,c=i[n])}if(c){var y=new XMLSerializer,w=y.serializeToString(c),l=c.getBoundingClientRect();a(w,l.width||300,l.height||150,function(j){o(e,j)});return}}var p=document.body;if(p){var g=Math.min(p.scrollWidth,window.innerWidth)||window.innerWidth||800,m=Math.min(p.scrollHeight,window.innerHeight)||window.innerHeight||600,h=p.cloneNode(!0);s(p,h);for(var v=h.querySelectorAll("script,iframe"),n=0;n<v.length;n++)v[n].remove();var q="http://www.w3.org/1999/xhtml",I="http://www.w3.org/2000/svg",b=new XMLSerializer().serializeToString(h),w='<svg xmlns="'+I+'" width="'+g+'" height="'+m+'"><foreignObject width="100%" height="100%"><body xmlns="'+q+'" style="margin:0;padding:0;">'+b+"</body></foreignObject></svg>";a(w,g,m,function(S){o(e,S)});return}}catch{}o(e,null)}})})(),function(){if(window.__yaarStorageInstalled)return;window.__yaarStorageInstalled=!0;function o(s){return s.split("/").map(encodeURIComponent).join("/")}window.yaar=window.yaar||{},window.yaar.storage={async save(s,a){var r;typeof a=="string"?r=a:a instanceof Blob?r=await a.arrayBuffer():a instanceof ArrayBuffer?r=a:a instanceof Uint8Array?r=a.buffer.slice(a.byteOffset,a.byteOffset+a.byteLength):r=String(a);var e=await fetch("/api/storage/"+o(s),{method:"POST",body:r});if(!e.ok){var t=await e.json().catch(function(){return{error:e.statusText}});throw new Error(t.error||"Save failed")}return e.json()},async read(s,a){var r=a&&a.as||"auto",e=await fetch("/api/storage/"+o(s));if(!e.ok){var t=await e.json().catch(function(){return{error:e.statusText}});throw new Error(t.error||"Read failed")}if(r==="blob")return e.blob();if(r==="arraybuffer")return e.arrayBuffer();if(r==="json")return e.json();if(r==="text")return e.text();var d=e.headers.get("content-type")||"";return d.includes("json")?e.json():d.startsWith("text/")?e.text():e.blob()},async list(s){var a=s?o(s):"",r=await fetch("/api/storage/"+a+"?list=true");if(!r.ok){var e=await r.json().catch(function(){return{error:r.statusText}});throw new Error(e.error||"List failed")}return r.json()},async remove(s){var a=await fetch("/api/storage/"+o(s),{method:"DELETE"});if(!a.ok){var r=await a.json().catch(function(){return{error:a.statusText}});throw new Error(r.error||"Delete failed")}return a.json()},url:function(s){return"/api/storage/"+o(s)}}}(),function(){if(!window.__yaarFetchProxyInstalled){window.__yaarFetchProxyInstalled=!0;var o=window.fetch.bind(window),s="";try{var a=new URLSearchParams(location.search),r=a.get("sessionId")||"";/^[a-zA-Z0-9_-]+$/.test(r)&&(s=r)}catch{}window.fetch=function(e,t){var d;if(e instanceof Request?d=e.url:d=String(e),d.startsWith("/")||d.startsWith("./")||d.startsWith("../"))return o(e,t);try{var c=new URL(d,location.origin);if(c.origin===location.origin)return o(e,t)}catch{return o(e,t)}var u=t&&t.method||(e instanceof Request?e.method:"GET"),n={};t&&t.headers?t.headers instanceof Headers?t.headers.forEach(function(i,l){n[l]=i}):Array.isArray(t.headers)?t.headers.forEach(function(i){n[i[0]]=i[1]}):n=Object.assign({},t.headers):e instanceof Request&&e.headers.forEach(function(i,l){n[l]=i});var f;return t&&t.body!=null?typeof t.body=="string"?f=Promise.resolve(t.body):f=new Response(t.body).text():e instanceof Request&&u!=="GET"&&u!=="HEAD"?f=e.text():f=Promise.resolve(void 0),f.then(function(i){var l={url:d,method:u,headers:n};return i!==void 0&&(l.body=i),s&&(l.sessionId=s),o("/api/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)})}).then(function(i){return i.ok?i.json():i.json().then(function(l){throw new Error(l.error||"Fetch proxy error: "+i.status)})}).then(function(i){var l;if(i.bodyEncoding==="base64"){for(var y=atob(i.body),w=new Uint8Array(y.length),p=0;p<y.length;p++)w[p]=y.charCodeAt(p);l=w.buffer}else l=i.body;return new Response(l,{status:i.status,statusText:i.statusText,headers:i.headers})})}}}(),function(){if(!window.__yaarAppProtocolInstalled){window.__yaarAppProtocolInstalled=!0,window.yaar=window.yaar||{};var o=null;window.yaar.app={register:function(s){o=s,window.parent.postMessage({type:"yaar:app-ready",appId:s.appId},"*")},sendInteraction:function(s){window.parent.postMessage({type:"yaar:app-interaction",content:typeof s=="string"?s:JSON.stringify(s)},"*")}},window.addEventListener("message",function(s){if(!(!s.data||!s.data.type)){var a=s.data,r=a.requestId;if(a.type==="yaar:app-manifest-request"){if(!o){window.parent.postMessage({type:"yaar:app-manifest-response",requestId:r,manifest:null,error:"No app registered"},"*");return}var e={appId:o.appId,name:o.name,state:{},commands:{}};if(o.state)for(var t in o.state){var d=o.state[t];e.state[t]={description:d.description},d.schema&&(e.state[t].schema=d.schema)}if(o.commands)for(var t in o.commands){var c=o.commands[t];e.commands[t]={description:c.description},c.params&&(e.commands[t].params=c.params),c.returns&&(e.commands[t].returns=c.returns)}window.parent.postMessage({type:"yaar:app-manifest-response",requestId:r,manifest:e},"*");return}if(a.type==="yaar:app-query-request"){if(!o||!o.state||!o.state[a.stateKey]){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:null,error:"Unknown state key: "+a.stateKey},"*");return}try{var u=o.state[a.stateKey].handler();u&&typeof u.then=="function"?u.then(function(n){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:n},"*")}).catch(function(n){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:null,error:String(n)},"*")}):window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:u},"*")}catch(n){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:null,error:String(n)},"*")}return}if(a.type==="yaar:app-command-request"){if(!o||!o.commands||!o.commands[a.command]){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:null,error:"Unknown command: "+a.command},"*");return}try{var u=o.commands[a.command].handler(a.params);u&&typeof u.then=="function"?u.then(function(f){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:f},"*")}).catch(function(f){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:null,error:String(f)},"*")}):window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:u},"*")}catch(n){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:null,error:String(n)},"*")}return}}})}}();</script>
</head>
<body>
<div id="app"></div>
<script type="module">
var I="market_apps.domain",N="https://yaarmarket.vercel.app";function T(t){let e=(t||"").trim();return e?e.replace(/\/+$/,""):""}function R(){let t=new URLSearchParams(window.location.search).get("domain"),e=window.__MARKET_APPS_DOMAIN__,n=localStorage.getItem(I);return T(t||e||n||N)}var x=document.createElement("div");x.style.cssText=`
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: #0b1020;
  color: #e8ecff;
`;document.body.style.margin="0";document.body.appendChild(x);var h="market",l=[],o=[],A="Waiting for data\u2026",k="",r=!1,d=R();function U(){return new Date().toLocaleString()}function S(){k=U()}function i(t,e=!0){A=t,e&&S()}function _(t){d=T(t),d?localStorage.setItem(I,d):localStorage.removeItem(I),i(d?`Domain set: ${d}`:"Domain cleared"),s()}async function $(t){if(!d)throw new Error("No domain configured. Set a domain first.");let e=await fetch(`${d}${t}`,{method:"GET"});if(!e.ok)throw new Error(`GET ${t} failed (${e.status})`);return e.json()}async function M(t,e){if(!d)throw new Error("No domain configured. Set a domain first.");let n=await fetch(`${d}${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!n.ok)throw new Error(`POST ${t} failed (${n.status})`);return n.json()}async function C(t,e){let n;for(let m of t)try{return await M(m,e)}catch(c){n=c}throw n||new Error("All POST endpoints failed")}function P(t){return o.some(e=>e.id===t)}function b(t,e){e?o.some(n=>n.id===t.id)||(o=[...o,{id:t.id,name:t.name}]):o=o.filter(n=>n.id!==t.id),l=l.map(n=>n.id===t.id?{...n,installed:e}:n)}async function D(t,e){let n=window.yaar;if(typeof n?.os?.action=="function"){let m=t==="install"?"apps:market_get":"apps:market_delete";return await n.os.action(m,{appId:e.id}),"os-action"}return typeof n?.app?.sendInteraction=="function"?(n.app.sendInteraction({event:"market-apps:request",action:t,appId:e.id,appName:e.name,requestedAt:new Date().toISOString()}),"interaction"):null}function O(t){return Array.isArray(t.marketApps)?t.marketApps:Array.isArray(t.apps)?t.apps:[]}function q(t){return Array.isArray(t.installedApps)?t.installedApps:Array.isArray(t.installed)?t.installed:[]}async function w(){if(!d){i("No domain configured. Use App Protocol command setDomain.",!0),s();return}r=!0,i("Refreshing\u2026",!1),s();try{let t=await $("/api/apps/");l=O(t);try{let e=await $("/api/installed");o=q(e),i(`Loaded ${l.length} market / ${o.length} installed apps`)}catch{i(`Loaded ${l.length} market apps (no /api/installed endpoint)`)}l=l.map(e=>({...e,installed:e.installed||P(e.id)}))}catch(t){i(`Refresh failed: ${t?.message||String(t)}`)}finally{r=!1,s()}}async function z(t){try{r=!0,i(`Installing ${t.name}\u2026`,!1),s();let e=await D("install",t);if(e==="os-action"){b(t,!0),i(`Installed ${t.name} via OS action`),r=!1,s();return}if(e==="interaction"){i(`Install request sent for ${t.name} (waiting for agent)`),r=!1,s();return}await C(["/api/install","/api/apps/install"],{appId:t.id}),b(t,!0),i(`Installed ${t.name}`),r=!1,s()}catch(e){r=!1,i(`Install failed: ${e?.message||String(e)}`),s()}}async function G(t){try{r=!0,i(`Uninstalling ${t.name}\u2026`,!1),s();let e=await D("uninstall",t);if(e==="os-action"){b(t,!1),i(`Uninstalled ${t.name} via OS action`),r=!1,s();return}if(e==="interaction"){i(`Uninstall request sent for ${t.name} (waiting for agent)`),r=!1,s();return}await C(["/api/uninstall","/api/apps/uninstall"],{appId:t.id}),b(t,!1),i(`Uninstalled ${t.name}`),r=!1,s()}catch(e){r=!1,i(`Uninstall failed: ${e?.message||String(e)}`),s()}}function v(t,e,n,m,c=!1){let u=document.createElement("div");u.style.cssText=`
    border: 1px solid #263254;
    border-radius: 10px;
    padding: 12px;
    display: flex;
    justify-content: space-between;
    gap: 12px;
    align-items: center;
    background: #121a34;
  `;let y=document.createElement("div"),f=document.createElement("div");f.textContent=t,f.style.cssText="font-weight: 600;";let g=document.createElement("div");g.textContent=e,g.style.cssText="opacity: 0.8; font-size: 12px; margin-top: 2px;",y.append(f,g);let p=document.createElement("button");return p.textContent=n,p.disabled=c,p.style.cssText=`
    border: 1px solid #3c4d84;
    background: ${c?"#18213f":"#1f2b54"};
    color: #e8ecff;
    border-radius: 8px;
    padding: 8px 12px;
    cursor: ${c?"not-allowed":"pointer"};
    opacity: ${c?.7:1};
  `,p.onclick=m,u.append(y,p),u}function s(){x.innerHTML="";let t=document.createElement("div");t.style.cssText="padding: 14px 16px; border-bottom: 1px solid #263254; display: flex; justify-content: space-between; align-items: center; gap: 10px;";let e=document.createElement("div"),n=document.createElement("div");n.textContent="Market Apps",n.style.cssText="font-size: 18px; font-weight: 700;";let m=document.createElement("div");m.textContent=`${A}${k?` \u2022 ${k}`:""}`,m.style.cssText="font-size: 12px; opacity: 0.8; margin-top: 2px;";let c=document.createElement("div");c.textContent=d?`Domain: ${d}`:"Domain: (not set)",c.style.cssText="font-size: 11px; opacity: 0.7; margin-top: 4px;",e.append(n,m,c);let u=document.createElement("button");u.textContent=r?"Refreshing\u2026":"Refresh",u.disabled=r,u.style.cssText="border: 1px solid #3c4d84; background: #1f2b54; color: #e8ecff; border-radius: 8px; padding: 8px 12px; cursor: pointer;",u.onclick=()=>{w()},t.append(e,u);let y=document.createElement("div");y.style.cssText="display: flex; gap: 8px; padding: 10px 16px; border-bottom: 1px solid #263254;";let f=document.createElement("button");f.textContent=`Marketplace (${l.length})`;let g=document.createElement("button");g.textContent=`Installed (${o.length})`,[f,g].forEach(a=>{a.style.cssText="border: 1px solid #3c4d84; background: #1a2445; color: #e8ecff; border-radius: 999px; padding: 6px 12px; cursor: pointer;"}),h==="market"&&(f.style.background="#2f4fd1"),h==="installed"&&(g.style.background="#2f4fd1"),f.onclick=()=>{h="market",s()},g.onclick=()=>{h="installed",s()},y.append(f,g);let p=document.createElement("div");if(p.style.cssText="padding: 14px 16px; overflow: auto; display: grid; gap: 10px;",h==="market")if(l.length)for(let a of l){let j=[a.description,a.version?`v${a.version}`:"",a.author||""].filter(Boolean).join(" \u2022 "),L=a.installed||P(a.id);p.appendChild(v(a.name,j,L?"Reinstall":"Install",()=>void z(a),r))}else{let a=document.createElement("div");a.textContent="No marketplace apps loaded.",a.style.opacity="0.8",p.appendChild(a)}else if(o.length)for(let a of o)p.appendChild(v(a.name,a.id,"Uninstall",()=>void G(a),r));else{let a=document.createElement("div");a.textContent="No installed apps loaded.",a.style.opacity="0.8",p.appendChild(a)}x.append(t,y,p)}s();var E=window.yaar?.app;E&&E.register({appId:"market-apps",name:"Market Apps",state:{marketApps:{description:"Current marketplace app list",handler:()=>[...l]},installedApps:{description:"Current installed app list",handler:()=>[...o]},status:{description:"Status line text",handler:()=>A},lastUpdated:{description:"Last updated local timestamp",handler:()=>k},domain:{description:"Configured marketplace domain",handler:()=>d},loading:{description:"Whether network request is in progress",handler:()=>r}},commands:{setDomain:{description:"Set marketplace API domain (e.g. https://example.com)",params:{type:"object",properties:{domain:{type:"string"},autoRefresh:{type:"boolean"}},required:["domain"]},handler:async t=>(_(t.domain),t.autoRefresh!==!1&&await w(),{ok:!0,domain:d})},refresh:{description:"Fetch data from configured domain",params:{type:"object",properties:{}},handler:async()=>(await w(),{ok:!0,marketCount:l.length,installedCount:o.length})},setData:{description:"Set marketplace and installed data manually",params:{type:"object",properties:{marketApps:{type:"array",items:{type:"object"}},installedApps:{type:"array",items:{type:"object"}},status:{type:"string"}}},handler:t=>(t.marketApps&&(l=t.marketApps),t.installedApps&&(o=t.installedApps),t.status&&(A=t.status),S(),s(),{ok:!0,marketCount:l.length,installedCount:o.length})},setStatus:{description:"Update status line",params:{type:"object",properties:{status:{type:"string"}},required:["status"]},handler:t=>(i(t.status),s(),{ok:!0})},clearData:{description:"Clear all app data",params:{type:"object",properties:{}},handler:()=>(l=[],o=[],i("Cleared"),s(),{ok:!0})}}});d?w():(i("No domain configured. Set domain via App Protocol setDomain command.",!0),s());

</script>
</body>
</html>