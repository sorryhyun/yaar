<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Image Viewer</title>
<style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden}body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}</style>
<script>(function(){if(window.__yaarCaptureInstalled)return;window.__yaarCaptureInstalled=true;function respond(requestId,imageData){window.parent.postMessage({type:"yaar:capture-response",requestId,imageData},"*")}function inlineStyles(original,clone){var origEls=original.querySelectorAll("*");var cloneEls=clone.querySelectorAll("*");for(var i=0;i<origEls.length&&i<cloneEls.length;i++){var cs=window.getComputedStyle(origEls[i]);cloneEls[i].setAttribute("style",cs.cssText)}var rootCs=window.getComputedStyle(original);clone.setAttribute("style",rootCs.cssText)}function svgToCanvas(svgStr,w,h,cb){var blob=new Blob([svgStr],{type:"image/svg+xml;charset=utf-8"});var url=URL.createObjectURL(blob);var img=new Image;img.onload=function(){var c=document.createElement("canvas");c.width=w;c.height=h;var ctx=c.getContext("2d");ctx.drawImage(img,0,0,w,h);URL.revokeObjectURL(url);cb(c.toDataURL("image/png"))};img.onerror=function(){URL.revokeObjectURL(url);cb(null)};img.src=url}window.addEventListener("message",function(e){if(!e.data||e.data.type!=="yaar:capture-request")return;var requestId=e.data.requestId;var imageData=null;try{var canvases=document.querySelectorAll("canvas");if(canvases.length>0){var largest=null;var largestArea=0;for(var i=0;i<canvases.length;i++){var area=canvases[i].width*canvases[i].height;if(area>largestArea){largestArea=area;largest=canvases[i]}}if(largest){imageData=largest.toDataURL("image/png")}}if(imageData){respond(requestId,imageData);return}var svgs=document.querySelectorAll("svg");if(svgs.length>0){var largest=null;var largestArea=0;for(var i=0;i<svgs.length;i++){var rect=svgs[i].getBoundingClientRect();var area=rect.width*rect.height;if(area>largestArea){largestArea=area;largest=svgs[i]}}if(largest){var serializer=new XMLSerializer;var svgStr=serializer.serializeToString(largest);var rect=largest.getBoundingClientRect();svgToCanvas(svgStr,rect.width||300,rect.height||150,function(data){respond(requestId,data)});return}}var body=document.body;if(body){var w=Math.min(body.scrollWidth,window.innerWidth)||window.innerWidth||800;var h=Math.min(body.scrollHeight,window.innerHeight)||window.innerHeight||600;var clone=body.cloneNode(true);inlineStyles(body,clone);var remove=clone.querySelectorAll("script,iframe");for(var i=0;i<remove.length;i++)remove[i].remove();var xmlns="http://www.w3.org/1999/xhtml";var svgNS="http://www.w3.org/2000/svg";var xhtml=new XMLSerializer().serializeToString(clone);var svgStr='<svg xmlns="'+svgNS+'" width="'+w+'" height="'+h+'">'+'<foreignObject width="100%" height="100%">'+'<body xmlns="'+xmlns+'" style="margin:0;padding:0;">'+xhtml+"</body></foreignObject></svg>";svgToCanvas(svgStr,w,h,function(data){respond(requestId,data)});return}}catch(ex){}respond(requestId,null)})})();(function(){if(window.__yaarStorageInstalled)return;window.__yaarStorageInstalled=true;function encodePath(p){return p.split("/").map(encodeURIComponent).join("/")}window.yaar=window.yaar||{};window.yaar.storage={async save(path,data){var body;if(typeof data==="string"){body=data}else if(data instanceof Blob){body=await data.arrayBuffer()}else if(data instanceof ArrayBuffer){body=data}else if(data instanceof Uint8Array){body=data.buffer.slice(data.byteOffset,data.byteOffset+data.byteLength)}else{body=String(data)}var res=await fetch("/api/storage/"+encodePath(path),{method:"POST",body});if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Save failed")}return res.json()},async read(path,options){var mode=options&&options.as||"auto";var res=await fetch("/api/storage/"+encodePath(path));if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Read failed")}if(mode==="blob")return res.blob();if(mode==="arraybuffer")return res.arrayBuffer();if(mode==="json")return res.json();if(mode==="text")return res.text();var ct=res.headers.get("content-type")||"";if(ct.includes("json"))return res.json();if(ct.startsWith("text/"))return res.text();return res.blob()},async list(dirPath){var p=dirPath?encodePath(dirPath):"";var res=await fetch("/api/storage/"+p+"?list=true");if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"List failed")}return res.json()},async remove(path){var res=await fetch("/api/storage/"+encodePath(path),{method:"DELETE"});if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Delete failed")}return res.json()},url:function(path){return"/api/storage/"+encodePath(path)}}})();(function(){if(window.__yaarFetchProxyInstalled)return;window.__yaarFetchProxyInstalled=true;var realFetch=window.fetch.bind(window);var sessionId="";try{var sp=new URLSearchParams(location.search);var raw=sp.get("sessionId")||"";if(/^[a-zA-Z0-9_-]+$/.test(raw))sessionId=raw}catch(e){}window.fetch=function(input,init){var url;if(input instanceof Request){url=input.url}else{url=String(input)}if(url.startsWith("/")||url.startsWith("./")||url.startsWith("../")){return realFetch(input,init)}try{var parsed=new URL(url,location.origin);if(parsed.origin===location.origin){return realFetch(input,init)}}catch(e){return realFetch(input,init)}var method=init&&init.method||(input instanceof Request?input.method:"GET");var headers={};if(init&&init.headers){if(init.headers instanceof Headers){init.headers.forEach(function(v,k){headers[k]=v})}else if(Array.isArray(init.headers)){init.headers.forEach(function(pair){headers[pair[0]]=pair[1]})}else{headers=Object.assign({},init.headers)}}else if(input instanceof Request){input.headers.forEach(function(v,k){headers[k]=v})}var bodyPromise;if(init&&init.body!=null){if(typeof init.body==="string"){bodyPromise=Promise.resolve(init.body)}else{bodyPromise=new Response(init.body).text()}}else if(input instanceof Request&&method!=="GET"&&method!=="HEAD"){bodyPromise=input.text()}else{bodyPromise=Promise.resolve(undefined)}return bodyPromise.then(function(bodyStr){var payload={url,method,headers};if(bodyStr!==undefined)payload.body=bodyStr;if(sessionId)payload.sessionId=sessionId;return realFetch("/api/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)})}).then(function(proxyRes){if(!proxyRes.ok){return proxyRes.json().then(function(err){throw new Error(err.error||"Fetch proxy error: "+proxyRes.status)})}return proxyRes.json()}).then(function(data){var body;if(data.bodyEncoding==="base64"){var bin=atob(data.body);var bytes=new Uint8Array(bin.length);for(var i=0;i<bin.length;i++)bytes[i]=bin.charCodeAt(i);body=bytes.buffer}else{body=data.body}return new Response(body,{status:data.status,statusText:data.statusText,headers:data.headers})})}})();(function(){if(window.__yaarAppProtocolInstalled)return;window.__yaarAppProtocolInstalled=true;window.yaar=window.yaar||{};var registration=null;window.yaar.app={register:function(config){registration=config;window.parent.postMessage({type:"yaar:app-ready",appId:config.appId},"*")},sendInteraction:function(description){window.parent.postMessage({type:"yaar:app-interaction",content:typeof description==="string"?description:JSON.stringify(description)},"*")}};window.addEventListener("message",function(e){if(!e.data||!e.data.type)return;var msg=e.data;var requestId=msg.requestId;if(msg.type==="yaar:app-manifest-request"){if(!registration){window.parent.postMessage({type:"yaar:app-manifest-response",requestId,manifest:null,error:"No app registered"},"*");return}var manifest={appId:registration.appId,name:registration.name,state:{},commands:{}};if(registration.state){for(var key in registration.state){var s=registration.state[key];manifest.state[key]={description:s.description};if(s.schema)manifest.state[key].schema=s.schema}}if(registration.commands){for(var key in registration.commands){var c=registration.commands[key];manifest.commands[key]={description:c.description};if(c.params)manifest.commands[key].params=c.params;if(c.returns)manifest.commands[key].returns=c.returns}}window.parent.postMessage({type:"yaar:app-manifest-response",requestId,manifest},"*");return}if(msg.type==="yaar:app-query-request"){if(!registration||!registration.state||!registration.state[msg.stateKey]){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:"Unknown state key: "+msg.stateKey},"*");return}try{var result=registration.state[msg.stateKey].handler();if(result&&typeof result.then==="function"){result.then(function(data){window.parent.postMessage({type:"yaar:app-query-response",requestId,data},"*")}).catch(function(err){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:String(err)},"*")})}else{window.parent.postMessage({type:"yaar:app-query-response",requestId,data:result},"*")}}catch(err){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:String(err)},"*")}return}if(msg.type==="yaar:app-command-request"){if(!registration||!registration.commands||!registration.commands[msg.command]){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:"Unknown command: "+msg.command},"*");return}try{var result=registration.commands[msg.command].handler(msg.params);if(result&&typeof result.then==="function"){result.then(function(data){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:data},"*")}).catch(function(err){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:String(err)},"*")})}else{window.parent.postMessage({type:"yaar:app-command-response",requestId,result},"*")}}catch(err){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:String(err)},"*")}return}})})();</script>
</head>
<body>
<div id="app"></div>
<script type="module">
var M=document.getElementById("app")??document.body,I=window.yaar??{},p=I.storage,c=I.app,i=[],n=new Set,u=1,o="grid",s=3;M.innerHTML=`
<style>
  * { box-sizing: border-box; font-family: Inter, system-ui, -apple-system, sans-serif; }
  body { margin: 0; background: #0b1020; color: #e2e8f0; }
  .app { height: 100vh; display: grid; grid-template-rows: auto 1fr auto; }
  .toolbar {
    display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
    padding: 10px; border-bottom: 1px solid #233150; background: #0f172a;
  }
  .toolbar button, .toolbar select, .toolbar input {
    border: 1px solid #334155; background: #111827; color: #e2e8f0;
    border-radius: 8px; padding: 6px 10px;
  }
  .toolbar button:hover { cursor: pointer; background: #1f2937; }
  .main { min-height: 0; display: grid; grid-template-columns: 260px 1fr; }
  .sidebar {
    border-right: 1px solid #233150; min-height: 0;
    display: grid; grid-template-rows: auto 1fr;
  }
  .side-head { padding: 8px 10px; font-size: 12px; color: #94a3b8; border-bottom: 1px solid #1e293b; }
  .thumbs { overflow: auto; padding: 8px; display: grid; gap: 8px; align-content: start; }
  .thumb {
    width: 100%; border: 1px solid #334155; border-radius: 8px;
    background: #111827; color: #cbd5e1; padding: 6px; text-align: left;
    font-size: 11px; cursor: pointer;
  }
  .thumb.active { border-color: #22d3ee; box-shadow: 0 0 0 1px #22d3ee inset; }
  .thumb img { width: 100%; height: 100px; object-fit: cover; border-radius: 6px; display: block; margin-bottom: 6px; }
  .viewer-wrap {
    min-height: 0;
    overflow: auto;
    padding: 10px;
    display: flex;
  }
  #viewer { width: 100%; min-height: 0; }
  .viewer-grid {
    display: grid; gap: 10px;
    grid-template-columns: repeat(var(--cols), minmax(180px, 1fr));
  }
  .viewer-single {
    height: 100%;
    min-height: 0;
    display: flex;
  }
  .viewer-single .panel {
    width: 100%;
    display: grid;
    grid-template-rows: auto 1fr;
  }
  .panel {
    border: 1px solid #334155; border-radius: 10px; background: #0f172a;
    overflow: hidden;
  }
  .panel-head {
    padding: 8px 10px; font-size: 12px; color: #cbd5e1;
    border-bottom: 1px solid #1e293b; background: #0b1220;
  }
  .panel img {
    width: 100%;
    height: min(65vh, 520px);
    object-fit: contain;
    background: #020617;
    display: block;
  }
  .viewer-single .panel img {
    height: 100%;
    max-height: none;
  }
  .empty {
    color: #94a3b8; border: 1px dashed #334155; border-radius: 10px;
    padding: 30px; text-align: center;
  }
  .status { padding: 8px 12px; border-top: 1px solid #233150; color: #94a3b8; font-size: 12px; }
</style>
<div class="app">
  <div class="toolbar">
    <input id="fileInput" type="file" accept="image/*" multiple />
    <button id="loadStorageBtn">Load storage images</button>
    <button id="gridBtn">Grid</button>
    <button id="singleBtn">Single</button>
    <label>Cols <input id="colsInput" type="number" min="1" max="8" value="3" style="width:64px" /></label>
    <button id="clearBtn">Clear</button>
  </div>
  <div class="main">
    <aside class="sidebar">
      <div class="side-head">Loaded Images</div>
      <div id="thumbs" class="thumbs"></div>
    </aside>
    <div class="viewer-wrap"><div id="viewer"></div></div>
  </div>
  <div id="status" class="status">Ready.</div>
</div>
`;var v=document.getElementById("fileInput"),S=document.getElementById("loadStorageBtn"),k=document.getElementById("gridBtn"),A=document.getElementById("singleBtn"),g=document.getElementById("colsInput"),T=document.getElementById("clearBtn"),y=document.getElementById("thumbs"),f=document.getElementById("viewer"),H=document.getElementById("status");function h(e){H.textContent=e}function w(e){return e.split("/").pop()||e}function $(){if(y.innerHTML="",!i.length){y.innerHTML='<div class="empty">No images loaded.</div>';return}for(let e of i){let t=document.createElement("button"),a=n.has(e.id)?" active":"";t.className=`thumb${a}`,t.innerHTML=`<img src="${e.source}" alt="${e.name}"/><div>${e.name}</div>`,t.onclick=()=>{if(o==="single")n=new Set([e.id]);else{if(n.has(e.id))n.delete(e.id);else n.add(e.id);if(!n.size)n.add(e.id)}d(),c?.sendInteraction({event:"select_images",ids:[...n]})},y.appendChild(t)}}function j(){if(f.innerHTML="",!i.length){f.innerHTML='<div class="empty">Load files or send images via App Protocol.</div>';return}let e=i;if(n.size)e=i.filter((a)=>n.has(a.id));if(o==="single")e=e.length?[e[0]]:[i[0]];let t=document.createElement("div");if(t.className=o==="single"?"viewer-single":"viewer-grid",o==="grid")t.style.setProperty("--cols",String(Math.max(1,s)));for(let a of e){let r=document.createElement("div");r.className="panel",r.innerHTML=`<div class="panel-head">${a.name}</div><img src="${a.source}" alt="${a.name}"/>`,t.appendChild(r)}f.appendChild(t)}function d(){$(),j(),h(`${i.length} image(s) loaded · mode=${o}${o==="grid"?` · cols=${s}`:""}`)}function x(e){let t=e.url||e.dataUrl;if(!t)return null;return{id:u++,name:e.name||(e.path?w(e.path):`Image ${u-1}`),source:t,path:e.path}}function l(e,t=!0){if(i=t?e:[...i,...e],i.length)n=new Set([i[0].id]);else n=new Set;d()}async function L(e,t=!1){if(!p?.url){h("Storage API unavailable.");return}let a=e.map((r)=>({id:u++,name:w(r),source:p.url(r),path:r}));l(a,t)}async function B(){if(!p?.list||!p?.url){h("Storage API unavailable.");return}let t=(await p.list("")).filter((a)=>!a.isDirectory&&/\.(png|jpe?g|gif|webp|bmp)$/i.test(a.path)).map((a)=>a.path);await L(t,!0),h(`Loaded ${t.length} image(s) from storage.`)}v.addEventListener("change",async()=>{let e=[...v.files||[]];if(!e.length)return;let t=(r)=>new Promise((b,E)=>{let m=new FileReader;m.onload=()=>b(String(m.result||"")),m.onerror=E,m.readAsDataURL(r)}),a=[];for(let r of e){let b=await t(r);a.push({id:u++,name:r.name,source:b})}l(a,!0),c?.sendInteraction({event:"loaded_local_files",count:a.length})});S.onclick=()=>B();k.onclick=()=>{o="grid",d()};A.onclick=()=>{o="single",d()};g.onchange=()=>{s=Math.max(1,Math.min(8,Number(g.value)||3)),g.value=String(s),d()};T.onclick=()=>l([],!0);d();if(c)c.register({appId:"image-viewer",name:"Image Viewer",state:{images:{description:"List of loaded images",handler:()=>i.map(({id:e,name:t,path:a})=>({id:e,name:t,path:a||null}))},selectedIds:{description:"Currently selected image IDs",handler:()=>[...n]},layout:{description:"Current layout mode and columns",handler:()=>({mode:o,columns:s})}},commands:{setImages:{description:"Replace images with a new set. Accepts URL/dataUrl/path+url.",params:{type:"object",properties:{images:{type:"array",items:{type:"object",properties:{name:{type:"string"},path:{type:"string"},url:{type:"string"},dataUrl:{type:"string"}}}}},required:["images"]},handler:(e)=>{let t=e.images.map(x).filter(Boolean);return l(t,!0),{ok:!0,count:t.length}}},addImages:{description:"Append multiple images in one call.",params:{type:"object",properties:{images:{type:"array",items:{type:"object",properties:{name:{type:"string"},path:{type:"string"},url:{type:"string"},dataUrl:{type:"string"}}}}},required:["images"]},handler:(e)=>{let t=e.images.map(x).filter(Boolean);return l(t,!1),{ok:!0,count:t.length}}},openStoragePaths:{description:"Load multiple storage file paths at once.",params:{type:"object",properties:{paths:{type:"array",items:{type:"string"}},replace:{type:"boolean"}},required:["paths"]},handler:async(e)=>{return await L(e.paths,e.replace??!1),{ok:!0,count:e.paths.length}}},loadStorageAll:{description:"Load all image files from storage root.",params:{type:"object",properties:{}},handler:async()=>{return await B(),{ok:!0,count:i.length}}},setLayout:{description:"Set viewer layout mode and columns.",params:{type:"object",properties:{mode:{type:"string",enum:["single","grid"]},columns:{type:"number"}},required:["mode"]},handler:(e)=>{if(o=e.mode,typeof e.columns==="number")s=Math.max(1,Math.min(8,Math.floor(e.columns))),g.value=String(s);return d(),{ok:!0,layout:{mode:o,columns:s}}}},selectImages:{description:"Select images by IDs.",params:{type:"object",properties:{ids:{type:"array",items:{type:"number"}}},required:["ids"]},handler:(e)=>{if(n=new Set(e.ids.filter((t)=>i.some((a)=>a.id===t))),!n.size&&i.length)n=new Set([i[0].id]);return d(),{ok:!0,selectedIds:[...n]}}},clear:{description:"Clear all loaded images.",params:{type:"object",properties:{}},handler:()=>{return l([],!0),{ok:!0}}}}});

</script>
</body>
</html>