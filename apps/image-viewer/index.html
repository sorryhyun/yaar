<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Image Viewer</title>
<style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden}body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}</style>
<script>(function(){if(window.__yaarCaptureInstalled)return;window.__yaarCaptureInstalled=!0;function o(r,e){window.parent.postMessage({type:"yaar:capture-response",requestId:r,imageData:e},"*")}function s(r,e){for(var t=r.querySelectorAll("*"),d=e.querySelectorAll("*"),c=0;c<t.length&&c<d.length;c++){var u=window.getComputedStyle(t[c]);d[c].setAttribute("style",u.cssText)}var n=window.getComputedStyle(r);e.setAttribute("style",n.cssText)}function a(r,e,t,d){var c=new Blob([r],{type:"image/svg+xml;charset=utf-8"}),u=URL.createObjectURL(c),n=new Image;n.onload=function(){var f=document.createElement("canvas");f.width=e,f.height=t;var i=f.getContext("2d");i.drawImage(n,0,0,e,t),URL.revokeObjectURL(u),d(f.toDataURL("image/png"))},n.onerror=function(){URL.revokeObjectURL(u),d(null)},n.src=u}window.addEventListener("message",function(r){if(!(!r.data||r.data.type!=="yaar:capture-request")){var e=r.data.requestId,t=null;try{var d=document.querySelectorAll("canvas");if(d.length>0){for(var c=null,u=0,n=0;n<d.length;n++){var f=d[n].width*d[n].height;f>u&&(u=f,c=d[n])}c&&(t=c.toDataURL("image/png"))}if(t){o(e,t);return}var i=document.querySelectorAll("svg");if(i.length>0){for(var c=null,u=0,n=0;n<i.length;n++){var l=i[n].getBoundingClientRect(),f=l.width*l.height;f>u&&(u=f,c=i[n])}if(c){var y=new XMLSerializer,w=y.serializeToString(c),l=c.getBoundingClientRect();a(w,l.width||300,l.height||150,function(j){o(e,j)});return}}var p=document.body;if(p){var g=Math.min(p.scrollWidth,window.innerWidth)||window.innerWidth||800,m=Math.min(p.scrollHeight,window.innerHeight)||window.innerHeight||600,h=p.cloneNode(!0);s(p,h);for(var v=h.querySelectorAll("script,iframe"),n=0;n<v.length;n++)v[n].remove();var q="http://www.w3.org/1999/xhtml",I="http://www.w3.org/2000/svg",b=new XMLSerializer().serializeToString(h),w='<svg xmlns="'+I+'" width="'+g+'" height="'+m+'"><foreignObject width="100%" height="100%"><body xmlns="'+q+'" style="margin:0;padding:0;">'+b+"</body></foreignObject></svg>";a(w,g,m,function(S){o(e,S)});return}}catch{}o(e,null)}})})(),function(){if(window.__yaarStorageInstalled)return;window.__yaarStorageInstalled=!0;function o(s){return s.split("/").map(encodeURIComponent).join("/")}window.yaar=window.yaar||{},window.yaar.storage={async save(s,a){var r;typeof a=="string"?r=a:a instanceof Blob?r=await a.arrayBuffer():a instanceof ArrayBuffer?r=a:a instanceof Uint8Array?r=a.buffer.slice(a.byteOffset,a.byteOffset+a.byteLength):r=String(a);var e=await fetch("/api/storage/"+o(s),{method:"POST",body:r});if(!e.ok){var t=await e.json().catch(function(){return{error:e.statusText}});throw new Error(t.error||"Save failed")}return e.json()},async read(s,a){var r=a&&a.as||"auto",e=await fetch("/api/storage/"+o(s));if(!e.ok){var t=await e.json().catch(function(){return{error:e.statusText}});throw new Error(t.error||"Read failed")}if(r==="blob")return e.blob();if(r==="arraybuffer")return e.arrayBuffer();if(r==="json")return e.json();if(r==="text")return e.text();var d=e.headers.get("content-type")||"";return d.includes("json")?e.json():d.startsWith("text/")?e.text():e.blob()},async list(s){var a=s?o(s):"",r=await fetch("/api/storage/"+a+"?list=true");if(!r.ok){var e=await r.json().catch(function(){return{error:r.statusText}});throw new Error(e.error||"List failed")}return r.json()},async remove(s){var a=await fetch("/api/storage/"+o(s),{method:"DELETE"});if(!a.ok){var r=await a.json().catch(function(){return{error:a.statusText}});throw new Error(r.error||"Delete failed")}return a.json()},url:function(s){return"/api/storage/"+o(s)}}}(),function(){if(!window.__yaarFetchProxyInstalled){window.__yaarFetchProxyInstalled=!0;var o=window.fetch.bind(window),s="";try{var a=new URLSearchParams(location.search),r=a.get("sessionId")||"";/^[a-zA-Z0-9_-]+$/.test(r)&&(s=r)}catch{}window.fetch=function(e,t){var d;if(e instanceof Request?d=e.url:d=String(e),d.startsWith("/")||d.startsWith("./")||d.startsWith("../"))return o(e,t);try{var c=new URL(d,location.origin);if(c.origin===location.origin)return o(e,t)}catch{return o(e,t)}var u=t&&t.method||(e instanceof Request?e.method:"GET"),n={};t&&t.headers?t.headers instanceof Headers?t.headers.forEach(function(i,l){n[l]=i}):Array.isArray(t.headers)?t.headers.forEach(function(i){n[i[0]]=i[1]}):n=Object.assign({},t.headers):e instanceof Request&&e.headers.forEach(function(i,l){n[l]=i});var f;return t&&t.body!=null?typeof t.body=="string"?f=Promise.resolve(t.body):f=new Response(t.body).text():e instanceof Request&&u!=="GET"&&u!=="HEAD"?f=e.text():f=Promise.resolve(void 0),f.then(function(i){var l={url:d,method:u,headers:n};return i!==void 0&&(l.body=i),s&&(l.sessionId=s),o("/api/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)})}).then(function(i){return i.ok?i.json():i.json().then(function(l){throw new Error(l.error||"Fetch proxy error: "+i.status)})}).then(function(i){var l;if(i.bodyEncoding==="base64"){for(var y=atob(i.body),w=new Uint8Array(y.length),p=0;p<y.length;p++)w[p]=y.charCodeAt(p);l=w.buffer}else l=i.body;return new Response(l,{status:i.status,statusText:i.statusText,headers:i.headers})})}}}(),function(){if(!window.__yaarAppProtocolInstalled){window.__yaarAppProtocolInstalled=!0,window.yaar=window.yaar||{};var o=null;window.yaar.app={register:function(s){o=s,window.parent.postMessage({type:"yaar:app-ready",appId:s.appId},"*")},sendInteraction:function(s){window.parent.postMessage({type:"yaar:app-interaction",content:typeof s=="string"?s:JSON.stringify(s)},"*")}},window.addEventListener("message",function(s){if(!(!s.data||!s.data.type)){var a=s.data,r=a.requestId;if(a.type==="yaar:app-manifest-request"){if(!o){window.parent.postMessage({type:"yaar:app-manifest-response",requestId:r,manifest:null,error:"No app registered"},"*");return}var e={appId:o.appId,name:o.name,state:{},commands:{}};if(o.state)for(var t in o.state){var d=o.state[t];e.state[t]={description:d.description},d.schema&&(e.state[t].schema=d.schema)}if(o.commands)for(var t in o.commands){var c=o.commands[t];e.commands[t]={description:c.description},c.params&&(e.commands[t].params=c.params),c.returns&&(e.commands[t].returns=c.returns)}window.parent.postMessage({type:"yaar:app-manifest-response",requestId:r,manifest:e},"*");return}if(a.type==="yaar:app-query-request"){if(!o||!o.state||!o.state[a.stateKey]){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:null,error:"Unknown state key: "+a.stateKey},"*");return}try{var u=o.state[a.stateKey].handler();u&&typeof u.then=="function"?u.then(function(n){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:n},"*")}).catch(function(n){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:null,error:String(n)},"*")}):window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:u},"*")}catch(n){window.parent.postMessage({type:"yaar:app-query-response",requestId:r,data:null,error:String(n)},"*")}return}if(a.type==="yaar:app-command-request"){if(!o||!o.commands||!o.commands[a.command]){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:null,error:"Unknown command: "+a.command},"*");return}try{var u=o.commands[a.command].handler(a.params);u&&typeof u.then=="function"?u.then(function(f){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:f},"*")}).catch(function(f){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:null,error:String(f)},"*")}):window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:u},"*")}catch(n){window.parent.postMessage({type:"yaar:app-command-response",requestId:r,result:null,error:String(n)},"*")}return}}})}}();</script>
</head>
<body>
<div id="app"></div>
<script type="module">
var M=document.getElementById("app")??document.body,I=window.yaar??{},p=I.storage,c=I.app,i=[],n=new Set,u=1,o="grid",s=3;M.innerHTML=`
<style>
  * { box-sizing: border-box; font-family: Inter, system-ui, -apple-system, sans-serif; }
  body { margin: 0; background: #0b1020; color: #e2e8f0; }
  .app { height: 100vh; display: grid; grid-template-rows: auto 1fr auto; }
  .toolbar {
    display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
    padding: 10px; border-bottom: 1px solid #233150; background: #0f172a;
  }
  .toolbar button, .toolbar select, .toolbar input {
    border: 1px solid #334155; background: #111827; color: #e2e8f0;
    border-radius: 8px; padding: 6px 10px;
  }
  .toolbar button:hover { cursor: pointer; background: #1f2937; }
  .main { min-height: 0; display: grid; grid-template-columns: 260px 1fr; }
  .sidebar {
    border-right: 1px solid #233150; min-height: 0;
    display: grid; grid-template-rows: auto 1fr;
  }
  .side-head { padding: 8px 10px; font-size: 12px; color: #94a3b8; border-bottom: 1px solid #1e293b; }
  .thumbs { overflow: auto; padding: 8px; display: grid; gap: 8px; align-content: start; }
  .thumb {
    width: 100%; border: 1px solid #334155; border-radius: 8px;
    background: #111827; color: #cbd5e1; padding: 6px; text-align: left;
    font-size: 11px; cursor: pointer;
  }
  .thumb.active { border-color: #22d3ee; box-shadow: 0 0 0 1px #22d3ee inset; }
  .thumb img { width: 100%; height: 100px; object-fit: cover; border-radius: 6px; display: block; margin-bottom: 6px; }
  .viewer-wrap {
    min-height: 0;
    overflow: auto;
    padding: 10px;
    display: flex;
  }
  #viewer { width: 100%; min-height: 0; }
  .viewer-grid {
    display: grid; gap: 10px;
    grid-template-columns: repeat(var(--cols), minmax(180px, 1fr));
  }
  .viewer-single {
    height: 100%;
    min-height: 0;
    display: flex;
  }
  .viewer-single .panel {
    width: 100%;
    display: grid;
    grid-template-rows: auto 1fr;
  }
  .panel {
    border: 1px solid #334155; border-radius: 10px; background: #0f172a;
    overflow: hidden;
  }
  .panel-head {
    padding: 8px 10px; font-size: 12px; color: #cbd5e1;
    border-bottom: 1px solid #1e293b; background: #0b1220;
  }
  .panel img {
    width: 100%;
    height: min(65vh, 520px);
    object-fit: contain;
    background: #020617;
    display: block;
  }
  .viewer-single .panel img {
    height: 100%;
    max-height: none;
  }
  .empty {
    color: #94a3b8; border: 1px dashed #334155; border-radius: 10px;
    padding: 30px; text-align: center;
  }
  .status { padding: 8px 12px; border-top: 1px solid #233150; color: #94a3b8; font-size: 12px; }
</style>
<div class="app">
  <div class="toolbar">
    <input id="fileInput" type="file" accept="image/*" multiple />
    <button id="loadStorageBtn">Load storage images</button>
    <button id="gridBtn">Grid</button>
    <button id="singleBtn">Single</button>
    <label>Cols <input id="colsInput" type="number" min="1" max="8" value="3" style="width:64px" /></label>
    <button id="clearBtn">Clear</button>
  </div>
  <div class="main">
    <aside class="sidebar">
      <div class="side-head">Loaded Images</div>
      <div id="thumbs" class="thumbs"></div>
    </aside>
    <div class="viewer-wrap"><div id="viewer"></div></div>
  </div>
  <div id="status" class="status">Ready.</div>
</div>
`;var v=document.getElementById("fileInput"),S=document.getElementById("loadStorageBtn"),k=document.getElementById("gridBtn"),A=document.getElementById("singleBtn"),g=document.getElementById("colsInput"),T=document.getElementById("clearBtn"),y=document.getElementById("thumbs"),f=document.getElementById("viewer"),H=document.getElementById("status");function h(e){H.textContent=e}function w(e){return e.split("/").pop()||e}function $(){if(y.innerHTML="",!i.length){y.innerHTML='<div class="empty">No images loaded.</div>';return}for(let e of i){let t=document.createElement("button"),a=n.has(e.id)?" active":"";t.className=`thumb${a}`,t.innerHTML=`<img src="${e.source}" alt="${e.name}"/><div>${e.name}</div>`,t.onclick=()=>{o==="single"?n=new Set([e.id]):(n.has(e.id)?n.delete(e.id):n.add(e.id),n.size||n.add(e.id)),d(),c?.sendInteraction({event:"select_images",ids:[...n]})},y.appendChild(t)}}function j(){if(f.innerHTML="",!i.length){f.innerHTML='<div class="empty">Load files or send images via App Protocol.</div>';return}let e=i;n.size&&(e=i.filter(a=>n.has(a.id))),o==="single"&&(e=e.length?[e[0]]:[i[0]]);let t=document.createElement("div");t.className=o==="single"?"viewer-single":"viewer-grid",o==="grid"&&t.style.setProperty("--cols",String(Math.max(1,s)));for(let a of e){let r=document.createElement("div");r.className="panel",r.innerHTML=`<div class="panel-head">${a.name}</div><img src="${a.source}" alt="${a.name}"/>`,t.appendChild(r)}f.appendChild(t)}function d(){$(),j(),h(`${i.length} image(s) loaded \xB7 mode=${o}${o==="grid"?` \xB7 cols=${s}`:""}`)}function x(e){let t=e.url||e.dataUrl;return t?{id:u++,name:e.name||(e.path?w(e.path):`Image ${u-1}`),source:t,path:e.path}:null}function l(e,t=!0){i=t?e:[...i,...e],i.length?n=new Set([i[0].id]):n=new Set,d()}async function L(e,t=!1){if(!p?.url){h("Storage API unavailable.");return}let a=e.map(r=>({id:u++,name:w(r),source:p.url(r),path:r}));l(a,t)}async function B(){if(!p?.list||!p?.url){h("Storage API unavailable.");return}let t=(await p.list("")).filter(a=>!a.isDirectory&&/\.(png|jpe?g|gif|webp|bmp)$/i.test(a.path)).map(a=>a.path);await L(t,!0),h(`Loaded ${t.length} image(s) from storage.`)}v.addEventListener("change",async()=>{let e=[...v.files||[]];if(!e.length)return;let t=r=>new Promise((b,E)=>{let m=new FileReader;m.onload=()=>b(String(m.result||"")),m.onerror=E,m.readAsDataURL(r)}),a=[];for(let r of e){let b=await t(r);a.push({id:u++,name:r.name,source:b})}l(a,!0),c?.sendInteraction({event:"loaded_local_files",count:a.length})});S.onclick=()=>B();k.onclick=()=>{o="grid",d()};A.onclick=()=>{o="single",d()};g.onchange=()=>{s=Math.max(1,Math.min(8,Number(g.value)||3)),g.value=String(s),d()};T.onclick=()=>l([],!0);d();c&&c.register({appId:"image-viewer",name:"Image Viewer",state:{images:{description:"List of loaded images",handler:()=>i.map(({id:e,name:t,path:a})=>({id:e,name:t,path:a||null}))},selectedIds:{description:"Currently selected image IDs",handler:()=>[...n]},layout:{description:"Current layout mode and columns",handler:()=>({mode:o,columns:s})}},commands:{setImages:{description:"Replace images with a new set. Accepts URL/dataUrl/path+url.",params:{type:"object",properties:{images:{type:"array",items:{type:"object",properties:{name:{type:"string"},path:{type:"string"},url:{type:"string"},dataUrl:{type:"string"}}}}},required:["images"]},handler:e=>{let t=e.images.map(x).filter(Boolean);return l(t,!0),{ok:!0,count:t.length}}},addImages:{description:"Append multiple images in one call.",params:{type:"object",properties:{images:{type:"array",items:{type:"object",properties:{name:{type:"string"},path:{type:"string"},url:{type:"string"},dataUrl:{type:"string"}}}}},required:["images"]},handler:e=>{let t=e.images.map(x).filter(Boolean);return l(t,!1),{ok:!0,count:t.length}}},openStoragePaths:{description:"Load multiple storage file paths at once.",params:{type:"object",properties:{paths:{type:"array",items:{type:"string"}},replace:{type:"boolean"}},required:["paths"]},handler:async e=>(await L(e.paths,e.replace??!1),{ok:!0,count:e.paths.length})},loadStorageAll:{description:"Load all image files from storage root.",params:{type:"object",properties:{}},handler:async()=>(await B(),{ok:!0,count:i.length})},setLayout:{description:"Set viewer layout mode and columns.",params:{type:"object",properties:{mode:{type:"string",enum:["single","grid"]},columns:{type:"number"}},required:["mode"]},handler:e=>(o=e.mode,typeof e.columns=="number"&&(s=Math.max(1,Math.min(8,Math.floor(e.columns))),g.value=String(s)),d(),{ok:!0,layout:{mode:o,columns:s}})},selectImages:{description:"Select images by IDs.",params:{type:"object",properties:{ids:{type:"array",items:{type:"number"}}},required:["ids"]},handler:e=>(n=new Set(e.ids.filter(t=>i.some(a=>a.id===t))),!n.size&&i.length&&(n=new Set([i[0].id])),d(),{ok:!0,selectedIds:[...n]})},clear:{description:"Clear all loaded images.",params:{type:"object",properties:{}},handler:()=>(l([],!0),{ok:!0})}}});

</script>
</body>
</html>