<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SMTP Mailer</title>
<style>*{margin:0;padding:0;box-sizing:border-box}html,body{width:100%;height:100%;overflow:hidden}body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}</style>
<script>(function(){if(window.__yaarCaptureInstalled)return;window.__yaarCaptureInstalled=true;function respond(requestId,imageData){window.parent.postMessage({type:"yaar:capture-response",requestId,imageData},"*")}function inlineStyles(original,clone){var origEls=original.querySelectorAll("*");var cloneEls=clone.querySelectorAll("*");for(var i=0;i<origEls.length&&i<cloneEls.length;i++){var cs=window.getComputedStyle(origEls[i]);cloneEls[i].setAttribute("style",cs.cssText)}var rootCs=window.getComputedStyle(original);clone.setAttribute("style",rootCs.cssText)}function svgToCanvas(svgStr,w,h,cb){var blob=new Blob([svgStr],{type:"image/svg+xml;charset=utf-8"});var url=URL.createObjectURL(blob);var img=new Image;img.onload=function(){var c=document.createElement("canvas");c.width=w;c.height=h;var ctx=c.getContext("2d");ctx.drawImage(img,0,0,w,h);URL.revokeObjectURL(url);cb(c.toDataURL("image/png"))};img.onerror=function(){URL.revokeObjectURL(url);cb(null)};img.src=url}window.addEventListener("message",function(e){if(!e.data||e.data.type!=="yaar:capture-request")return;var requestId=e.data.requestId;var imageData=null;try{var canvases=document.querySelectorAll("canvas");if(canvases.length>0){var largest=null;var largestArea=0;for(var i=0;i<canvases.length;i++){var area=canvases[i].width*canvases[i].height;if(area>largestArea){largestArea=area;largest=canvases[i]}}if(largest){imageData=largest.toDataURL("image/png")}}if(imageData){respond(requestId,imageData);return}var svgs=document.querySelectorAll("svg");if(svgs.length>0){var largest=null;var largestArea=0;for(var i=0;i<svgs.length;i++){var rect=svgs[i].getBoundingClientRect();var area=rect.width*rect.height;if(area>largestArea){largestArea=area;largest=svgs[i]}}if(largest){var serializer=new XMLSerializer;var svgStr=serializer.serializeToString(largest);var rect=largest.getBoundingClientRect();svgToCanvas(svgStr,rect.width||300,rect.height||150,function(data){respond(requestId,data)});return}}var body=document.body;if(body){var w=Math.min(body.scrollWidth,window.innerWidth)||window.innerWidth||800;var h=Math.min(body.scrollHeight,window.innerHeight)||window.innerHeight||600;var clone=body.cloneNode(true);inlineStyles(body,clone);var remove=clone.querySelectorAll("script,iframe");for(var i=0;i<remove.length;i++)remove[i].remove();var xmlns="http://www.w3.org/1999/xhtml";var svgNS="http://www.w3.org/2000/svg";var xhtml=new XMLSerializer().serializeToString(clone);var svgStr='<svg xmlns="'+svgNS+'" width="'+w+'" height="'+h+'">'+'<foreignObject width="100%" height="100%">'+'<body xmlns="'+xmlns+'" style="margin:0;padding:0;">'+xhtml+"</body></foreignObject></svg>";svgToCanvas(svgStr,w,h,function(data){respond(requestId,data)});return}}catch(ex){}respond(requestId,null)})})();(function(){if(window.__yaarStorageInstalled)return;window.__yaarStorageInstalled=true;function encodePath(p){return p.split("/").map(encodeURIComponent).join("/")}window.yaar=window.yaar||{};window.yaar.storage={async save(path,data){var body;if(typeof data==="string"){body=data}else if(data instanceof Blob){body=await data.arrayBuffer()}else if(data instanceof ArrayBuffer){body=data}else if(data instanceof Uint8Array){body=data.buffer.slice(data.byteOffset,data.byteOffset+data.byteLength)}else{body=String(data)}var res=await fetch("/api/storage/"+encodePath(path),{method:"POST",body});if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Save failed")}return res.json()},async read(path,options){var mode=options&&options.as||"auto";var res=await fetch("/api/storage/"+encodePath(path));if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Read failed")}if(mode==="blob")return res.blob();if(mode==="arraybuffer")return res.arrayBuffer();if(mode==="json")return res.json();if(mode==="text")return res.text();var ct=res.headers.get("content-type")||"";if(ct.includes("json"))return res.json();if(ct.startsWith("text/"))return res.text();return res.blob()},async list(dirPath){var p=dirPath?encodePath(dirPath):"";var res=await fetch("/api/storage/"+p+"?list=true");if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"List failed")}return res.json()},async remove(path){var res=await fetch("/api/storage/"+encodePath(path),{method:"DELETE"});if(!res.ok){var err=await res.json().catch(function(){return{error:res.statusText}});throw new Error(err.error||"Delete failed")}return res.json()},url:function(path){return"/api/storage/"+encodePath(path)}}})();(function(){if(window.__yaarFetchProxyInstalled)return;window.__yaarFetchProxyInstalled=true;var realFetch=window.fetch.bind(window);var sessionId="";try{var sp=new URLSearchParams(location.search);var raw=sp.get("sessionId")||"";if(/^[a-zA-Z0-9_-]+$/.test(raw))sessionId=raw}catch(e){}window.fetch=function(input,init){var url;if(input instanceof Request){url=input.url}else{url=String(input)}if(url.startsWith("/")||url.startsWith("./")||url.startsWith("../")){return realFetch(input,init)}try{var parsed=new URL(url,location.origin);if(parsed.origin===location.origin){return realFetch(input,init)}}catch(e){return realFetch(input,init)}var method=init&&init.method||(input instanceof Request?input.method:"GET");var headers={};if(init&&init.headers){if(init.headers instanceof Headers){init.headers.forEach(function(v,k){headers[k]=v})}else if(Array.isArray(init.headers)){init.headers.forEach(function(pair){headers[pair[0]]=pair[1]})}else{headers=Object.assign({},init.headers)}}else if(input instanceof Request){input.headers.forEach(function(v,k){headers[k]=v})}var bodyPromise;if(init&&init.body!=null){if(typeof init.body==="string"){bodyPromise=Promise.resolve(init.body)}else{bodyPromise=new Response(init.body).text()}}else if(input instanceof Request&&method!=="GET"&&method!=="HEAD"){bodyPromise=input.text()}else{bodyPromise=Promise.resolve(undefined)}return bodyPromise.then(function(bodyStr){var payload={url,method,headers};if(bodyStr!==undefined)payload.body=bodyStr;if(sessionId)payload.sessionId=sessionId;return realFetch("/api/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)})}).then(function(proxyRes){if(!proxyRes.ok){return proxyRes.json().then(function(err){throw new Error(err.error||"Fetch proxy error: "+proxyRes.status)})}return proxyRes.json()}).then(function(data){var body;if(data.bodyEncoding==="base64"){var bin=atob(data.body);var bytes=new Uint8Array(bin.length);for(var i=0;i<bin.length;i++)bytes[i]=bin.charCodeAt(i);body=bytes.buffer}else{body=data.body}return new Response(body,{status:data.status,statusText:data.statusText,headers:data.headers})})}})();(function(){if(window.__yaarAppProtocolInstalled)return;window.__yaarAppProtocolInstalled=true;window.yaar=window.yaar||{};var registration=null;window.yaar.app={register:function(config){registration=config;window.parent.postMessage({type:"yaar:app-ready",appId:config.appId},"*")},sendInteraction:function(description){window.parent.postMessage({type:"yaar:app-interaction",content:typeof description==="string"?description:JSON.stringify(description)},"*")}};window.addEventListener("message",function(e){if(!e.data||!e.data.type)return;var msg=e.data;var requestId=msg.requestId;if(msg.type==="yaar:app-manifest-request"){if(!registration){window.parent.postMessage({type:"yaar:app-manifest-response",requestId,manifest:null,error:"No app registered"},"*");return}var manifest={appId:registration.appId,name:registration.name,state:{},commands:{}};if(registration.state){for(var key in registration.state){var s=registration.state[key];manifest.state[key]={description:s.description};if(s.schema)manifest.state[key].schema=s.schema}}if(registration.commands){for(var key in registration.commands){var c=registration.commands[key];manifest.commands[key]={description:c.description};if(c.params)manifest.commands[key].params=c.params;if(c.returns)manifest.commands[key].returns=c.returns}}window.parent.postMessage({type:"yaar:app-manifest-response",requestId,manifest},"*");return}if(msg.type==="yaar:app-query-request"){if(!registration||!registration.state||!registration.state[msg.stateKey]){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:"Unknown state key: "+msg.stateKey},"*");return}try{var result=registration.state[msg.stateKey].handler();if(result&&typeof result.then==="function"){result.then(function(data){window.parent.postMessage({type:"yaar:app-query-response",requestId,data},"*")}).catch(function(err){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:String(err)},"*")})}else{window.parent.postMessage({type:"yaar:app-query-response",requestId,data:result},"*")}}catch(err){window.parent.postMessage({type:"yaar:app-query-response",requestId,data:null,error:String(err)},"*")}return}if(msg.type==="yaar:app-command-request"){if(!registration||!registration.commands||!registration.commands[msg.command]){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:"Unknown command: "+msg.command},"*");return}try{var result=registration.commands[msg.command].handler(msg.params);if(result&&typeof result.then==="function"){result.then(function(data){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:data},"*")}).catch(function(err){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:String(err)},"*")})}else{window.parent.postMessage({type:"yaar:app-command-response",requestId,result},"*")}}catch(err){window.parent.postMessage({type:"yaar:app-command-response",requestId,result:null,error:String(err)},"*")}return}})})();</script>
</head>
<body>
<div id="app"></div>
<script type="module">
var a=document.createElement("div");a.style.fontFamily="Inter, system-ui, sans-serif";a.style.padding="16px";a.style.maxWidth="920px";a.style.margin="0 auto";a.innerHTML=`
  <h2 style="margin:0 0 8px">SMTP Mailer</h2>
  <p style="margin:0 0 16px;color:#666">Compose email with SMTP or Google API.</p>

  <section style="border:1px solid #ddd;border-radius:10px;padding:12px;margin-bottom:12px">
    <h3 style="margin:0 0 10px;font-size:15px">Provider</h3>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <select id="providerSelect" style="padding:8px;border:1px solid #ccc;border-radius:8px;background:#fff">
        <option value="smtp">SMTP</option>
        <option value="google">Google API</option>
      </select>
      <span id="providerStatus" style="font-size:12px;color:#666">Using SMTP mode</span>
    </div>
  </section>

  <section id="smtpSection" style="border:1px solid #ddd;border-radius:10px;padding:12px;margin-bottom:12px">
    <h3 style="margin:0 0 10px;font-size:15px">SMTP Profile</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <label style="display:flex;flex-direction:column;gap:4px;font-size:12px;color:#555">
        Host
        <input id="smtpHost" value="smtp.gmail.com" style="padding:8px;border:1px solid #ccc;border-radius:8px" />
      </label>
      <label style="display:flex;flex-direction:column;gap:4px;font-size:12px;color:#555">
        Port
        <input id="smtpPort" value="465" style="padding:8px;border:1px solid #ccc;border-radius:8px" />
      </label>
      <label style="display:flex;flex-direction:column;gap:4px;font-size:12px;color:#555">
        Username
        <input id="smtpUser" value="standingbehindnv@gmail.com" style="padding:8px;border:1px solid #ccc;border-radius:8px" />
      </label>
      <label style="display:flex;flex-direction:column;gap:4px;font-size:12px;color:#555">
        App Password
        <input id="smtpPass" type="password" placeholder="xxxx xxxx xxxx xxxx" style="padding:8px;border:1px solid #ccc;border-radius:8px" />
      </label>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="saveProfile" style="padding:8px 12px;border-radius:8px;border:1px solid #0a7;background:#0a7;color:#fff">Save SMTP Profile</button>
      <span id="profileStatus" style="font-size:12px;color:#666;align-self:center"></span>
    </div>
  </section>

  <section id="googleSection" style="display:none;border:1px solid #ddd;border-radius:10px;padding:12px;margin-bottom:12px;background:#fcfcff">
    <h3 style="margin:0 0 10px;font-size:15px">Google Auth</h3>
    <p style="margin:0 0 8px;color:#666;font-size:12px">Authenticate in browser, then token is saved by agent.</p>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <button id="authenticateGoogle" style="padding:8px 12px;border-radius:8px;border:1px solid #2563eb;background:#2563eb;color:#fff">Authenticate Google</button>
      <button id="requestAuthLink" style="padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#fff">Get Manual Auth Link</button>
    </div>

    <label style="display:flex;flex-direction:column;gap:4px;font-size:12px;color:#555;margin-bottom:8px">
      Auth Link (manual fallback)
      <input id="googleAuthLink" readonly placeholder="Click 'Get Manual Auth Link'" style="padding:8px;border:1px solid #ccc;border-radius:8px;background:#f8f8f8" />
    </label>

    <div style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:end;margin-bottom:8px">
      <label style="display:flex;flex-direction:column;gap:4px;font-size:12px;color:#555">
        Paste authorization code
        <input id="googleAuthCode" placeholder="4/0AfJohX..." style="padding:8px;border:1px solid #ccc;border-radius:8px" />
      </label>
      <button id="submitGoogleCode" style="padding:8px 12px;border-radius:8px;border:1px solid #0a7;background:#0a7;color:#fff;height:36px">Submit Code</button>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <span id="googleStatus" style="font-size:12px;color:#666">Not connected</span>
    </div>
  </section>

  <section style="border:1px solid #ddd;border-radius:10px;padding:12px">
    <h3 style="margin:0 0 10px;font-size:15px">Compose</h3>
    <div style="display:flex;flex-direction:column;gap:8px">
      <input id="to" placeholder="To" style="padding:10px;border:1px solid #ccc;border-radius:8px" />
      <input id="subject" placeholder="Subject" style="padding:10px;border:1px solid #ccc;border-radius:8px" />
      <textarea id="body" placeholder="Write your email..." rows="10" style="padding:10px;border:1px solid #ccc;border-radius:8px;resize:vertical"></textarea>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="saveDraft" style="padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#fff">Save Draft</button>
      <button id="send" style="padding:8px 12px;border-radius:8px;border:1px solid #2563eb;background:#2563eb;color:#fff">Send Email</button>
      <span id="sendStatus" style="font-size:12px;color:#666;align-self:center"></span>
    </div>
  </section>
`;document.body.style.margin="0";document.body.style.background="#fafafa";document.body.appendChild(a);var e=(t)=>document.getElementById(t);function r(){return e("providerSelect").value||"smtp"}function s(t){let o=t==="smtp";e("smtpSection").style.display=o?"block":"none",e("googleSection").style.display=o?"none":"block",e("providerStatus").textContent=o?"Using SMTP mode":"Using Google API mode"}async function l(){try{let t=await window.yaar.storage.read("smtp-mailer/draft.json",{as:"json"});if(t)e("to").value=t.to||"",e("subject").value=t.subject||"",e("body").value=t.body||""}catch{}}async function i(){let t={to:e("to").value.trim(),subject:e("subject").value,body:e("body").value};await window.yaar.storage.save("smtp-mailer/draft.json",JSON.stringify(t,null,2)),e("sendStatus").textContent=`Draft saved at ${new Date().toLocaleTimeString()}`}function p(){return{smtpHost:e("smtpHost").value.trim(),smtpPort:Number(e("smtpPort").value||"465"),secure:Number(e("smtpPort").value||"465")===465,username:e("smtpUser").value.trim(),appPassword:e("smtpPass").value}}function d(){return{to:e("to").value.trim(),subject:e("subject").value,body:e("body").value}}e("providerSelect").addEventListener("change",()=>{let t=r();s(t),window.yaar?.app?.sendInteraction({event:"mail_provider_changed",payload:{provider:t}})});e("saveDraft").addEventListener("click",async()=>{await i()});e("saveProfile").addEventListener("click",()=>{let t=p();window.yaar?.app?.sendInteraction({event:"smtp_profile_save_requested",payload:t}),e("profileStatus").textContent="Save requested to agent"});e("authenticateGoogle").addEventListener("click",()=>{window.yaar?.app?.sendInteraction({event:"google_authenticate_requested",payload:{mode:"agent_browser"}}),e("googleStatus").textContent="Opening auth flow in browser..."});e("requestAuthLink").addEventListener("click",()=>{window.yaar?.app?.sendInteraction({event:"google_auth_link_requested",payload:{mode:"manual"}}),e("googleStatus").textContent="Auth link requested from agent..."});e("submitGoogleCode").addEventListener("click",()=>{let t=e("googleAuthCode").value.trim();if(!t){e("googleStatus").textContent="Please paste an authorization code first.";return}window.yaar?.app?.sendInteraction({event:"google_auth_code_submitted",payload:{code:t}}),e("googleStatus").textContent="Code submitted to agent for token exchange..."});e("send").addEventListener("click",async()=>{let t=d();await i();let o=window.yaar?.app;if(r()==="google"){o?.sendInteraction({event:"gmail_send_requested",payload:{draft:t}}),e("sendStatus").textContent="Google send requested to agent";return}o?.sendInteraction({event:"smtp_send_requested",payload:{profile:p(),draft:t}}),e("sendStatus").textContent="SMTP send requested to agent"});var n=window.yaar?.app;if(n)n.register({appId:"smtp-mailer",name:"SMTP Mailer",state:{provider:{description:"Current send provider",handler:()=>({provider:r()})},compose:{description:"Current compose fields",handler:()=>d()},smtpProfile:{description:"Current SMTP profile form values",handler:()=>({smtpHost:e("smtpHost").value,smtpPort:Number(e("smtpPort").value||"465"),username:e("smtpUser").value,hasPassword:Boolean(e("smtpPass").value)})},googleAuth:{description:"Current Google auth UI state",handler:()=>({authLink:e("googleAuthLink").value,hasAuthCode:Boolean(e("googleAuthCode").value.trim()),status:e("googleStatus").textContent||""})}},commands:{hydrateProfile:{description:"Fill SMTP profile fields from saved config",params:{type:"object",properties:{smtpHost:{type:"string"},smtpPort:{type:"number"},username:{type:"string"}},required:[]},handler:(t)=>{if(t.smtpHost)e("smtpHost").value=t.smtpHost;if(t.smtpPort)e("smtpPort").value=String(t.smtpPort);if(t.username)e("smtpUser").value=t.username;return{ok:!0}}},setProvider:{description:"Set active provider in UI",params:{type:"object",properties:{provider:{type:"string",enum:["smtp","google"]}},required:["provider"]},handler:(t)=>{return e("providerSelect").value=t.provider,s(t.provider),{ok:!0}}},setGoogleAuthLink:{description:"Set manual Google auth link in UI",params:{type:"object",properties:{url:{type:"string"}},required:["url"]},handler:(t)=>{return e("googleAuthLink").value=t.url,{ok:!0}}},setGoogleStatus:{description:"Set Google auth status text",params:{type:"object",properties:{status:{type:"string"}},required:["status"]},handler:(t)=>{return e("googleStatus").textContent=t.status,{ok:!0}}},setStatus:{description:"Set status text for profile/send actions",params:{type:"object",properties:{profileStatus:{type:"string"},sendStatus:{type:"string"},providerStatus:{type:"string"}},required:[]},handler:(t)=>{if(typeof t.profileStatus==="string")e("profileStatus").textContent=t.profileStatus;if(typeof t.sendStatus==="string")e("sendStatus").textContent=t.sendStatus;if(typeof t.providerStatus==="string")e("providerStatus").textContent=t.providerStatus;return{ok:!0}}}}});s("smtp");l();

</script>
</body>
</html>