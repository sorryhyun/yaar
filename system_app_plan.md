# System App Plan

System apps are hidden apps (`"hidden": true` in `app.json`) that ship with the repo. They don't show desktop icons — instead, their descriptions are injected into the AI's system prompt so the agent always knows about them. Compiled system apps include their iframe URL in the environment section.

## Architecture

```
apps/{id}/
├── app.json          # { "hidden": true, "appProtocol": true, ... }
├── SKILL.md          # AI instructions (auto-generated by deploy tool)
├── index.html        # Compiled iframe app
└── src/main.ts       # TypeScript source
```

**Discovery flow:**
1. `listApps()` reads `app.json`, sets `hidden: true` on matching apps
2. `buildEnvironmentSection()` splits apps into visible/hidden
3. Visible apps → `- Installed apps: ...`
4. Hidden apps → `- System apps:` with description + iframe URL
5. AI can open them with `create({ renderer: "iframe", content: "/api/apps/{id}/static/index.html" })`

**Already built:**
- `apps/storage/` — File browser with App Protocol (navigate, select, preview, refresh)

## Planned System Apps

### 1. Settings

System configuration and security center.

**Capabilities:**
- View/edit `config/permissions.json` (saved permission decisions)
- View/edit `config/curl_allowed_domains.yaml` (HTTP domain allowlist)
- Manage hook configs (launch, tool_use triggers)
- Toggle safe-mode flags
- View/clear session data

**App Protocol state:** `permissions`, `allowed-domains`, `hooks`, `safe-mode`
**App Protocol commands:** `grant-permission`, `revoke-permission`, `add-domain`, `remove-domain`, `set-hook`, `remove-hook`

### 2. Task Manager

Live view of running agents, budgets, and tool calls.

**Capabilities:**
- Show active agents per monitor (main + window + task agents)
- Display agent status, current tool call, token usage
- Per-monitor budget bars (used/remaining)
- Cancel/interrupt individual agents
- View recent tool call log with timing

**App Protocol state:** `agents`, `budgets`, `tool-log`
**App Protocol commands:** `interrupt-agent`, `clear-log`

**Implementation notes:**
- Needs a server-side event stream (agent lifecycle events → WebSocket → iframe)
- Could use `sendInteraction` to push updates, or poll via App Protocol queries

### 3. Memory

Manage the AI's persistent memory (`config/memory.md`).

**Capabilities:**
- View all memorized facts
- Edit/delete individual entries
- Search memories
- Import/export

**App Protocol state:** `memories`, `search-results`
**App Protocol commands:** `delete-memory`, `edit-memory`, `search`

### 4. Connector Hub

Unified credential and integration management (prerequisite for Workflows).

**Capabilities:**
- List all configured credentials (`config/credentials/*.json`)
- Add/edit/delete credentials per app
- OAuth flow launcher (for apps that need it)
- Connection test ("verify this API key works")
- Domain allowlist management (shared with Settings)

**App Protocol state:** `connectors`, `connection-status`
**App Protocol commands:** `test-connection`, `delete-credentials`, `add-domain`

## Development Workflow

All system apps use the standard YAAR app dev toolchain:

```
write_ts → compile → deploy (with hidden: true)
```

Or from Claude Code:
```
1. Write src/main.ts
2. curl MCP endpoint: write_ts, compile, deploy
```

## Design Principles

1. **Ship with repo** — No network dependency on first run. Version-controlled alongside the codebase.
2. **App Protocol first** — Every system app should expose state + commands so the AI can interact programmatically, not just display UI.
3. **Minimal footprint** — System apps are single-file TypeScript. Use `@bundled/*` imports sparingly. No external dependencies.
4. **Dark theme** — Match the desktop aesthetic (CSS vars: `--bg`, `--surface`, `--border`, `--text`, `--accent`).
5. **AI-openable** — The AI should be able to open any system app and interact with it without user intervention. The environment section provides the iframe URL.
